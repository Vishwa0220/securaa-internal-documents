<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Securaa Playbook Service - Low Level Design - Securaa Platform Documentation</title>
    <link rel="stylesheet" href="assets/css/documentation.css">
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.9.4/dist/mermaid.esm.min.mjs';
      mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <header class="main-header">
        <h1>Securaa Platform Documentation</h1>
        <p>Comprehensive documentation for Securaa security platform services</p>
    </header>
    <nav class="documentation-nav">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="securaa-ris-high-level-design.html">RIS High Level Design</a></li>
            <li><a href="securaa-ris-low-level-design.html">RIS Low Level Design</a></li>
            <li><a href="securaa-playbook-high-level-design.html">Securaa Playbook High Level Design</a></li>
            <li><a href="securaa-playbook-low-level-design.html">Securaa Playbook Low Level Design</a></li>
            <li><a href="optimization-guide.html">Optimization Guide</a></li>
            <li><a href="securaa-siem-high-level-design.html">Securaa SIEM High Level Design</a></li>
            <li><a href="securaa-siem-low-level-design.html">Securaa SIEM Low Level Design</a></li>
            <li><a href="securaa-platform-high-level-design.html">Securaa Platform</a></li>
<li><a href="process-manager-high-level-design.html">Process Manager High Level Design</a></li>
<li><a href="process-manager-low-level-design.html">Process Manager Low Level Design</a></li>
<li><a href="securaa-user-high-level-design.html">Securaa User High Level Design</a></li>
<li><a href="securaa-user-low-level-design.html">Securaa User Low Level Design</a></li>
            <li><a href="process-manager-high-level-design.html">Process Manager High Level Design</a></li>
            <li><a href="process-manager-low-level-design.html">Process Manager Low Level Design</a></li>
        </ul>
    </nav>
    <main class="main-content">
        <h1>Securaa Playbook Service - Low Level Design Document</h1>
        
        <h2>Document Information</h2>
        <ul>
            <li><strong>Service Name</strong>: Securaa Playbook Service</li>
            <li><strong>Version</strong>: 1.0</li>
            <li><strong>Date</strong>: September 11, 2025</li>
            <li><strong>Author</strong>: Development Team</li>
            <li><strong>Related Documents</strong>: <a href="securaa-playbook-high-level-design.html">High Level Design</a></li>
        </ul>
        
        <h2>Table of Contents</h2>
        <ol>
            <li><a href="#overview">Overview</a></li>
            <li><a href="#detailed-component-design">Detailed Component Design</a></li>
            <li><a href="#class-diagrams">Class Diagrams</a></li>
            <li><a href="#sequence-diagrams">Sequence Diagrams</a></li>
            <li><a href="#database-schema">Database Schema</a></li>
            <li><a href="#api-specifications">API Specifications</a></li>
            <li><a href="#algorithm-specifications">Algorithm Specifications</a></li>
            <li><a href="#configuration-management">Configuration Management</a></li>
            <li><a href="#error-handling-implementation">Error Handling Implementation</a></li>
            <li><a href="#concurrency--thread-safety">Concurrency & Thread Safety</a></li>
            <li><a href="#performance-optimizations">Performance Optimizations</a></li>
            <li><a href="#testing-strategy">Testing Strategy</a></li>
        </ol>

        <h2 id="overview">1. Overview</h2>
        <p>The Low Level Design document provides detailed implementation specifications for the Securaa Playbook Service, including class structures, method signatures, algorithm implementations, and detailed interaction patterns.</p>
        
        <h3>1.1 Scope</h3>
        <p>This document covers:</p>
        <ul>
            <li>Detailed class and method specifications</li>
            <li>Database schema with indexes and constraints</li>
            <li>Complete API specifications with validation rules</li>
            <li>Concurrency patterns and thread safety mechanisms</li>
            <li>Performance optimization techniques</li>
            <li>Error handling and recovery strategies</li>
        </ul>

        <h2 id="detailed-component-design">2. Detailed Component Design</h2>
        
        <h3>2.1 Core Package Structure</h3>
        <pre><code>securaa_services/securaa_playbook/
├── main.go                     // Application entry point
├── app.go                      // Application initialization
├── controllers/                // HTTP request handlers
│   ├── playbookcontroller.go
│   ├── listController.go
│   ├── caseController.go
│   ├── supportcontroller.go
│   └── processController.go
├── executionControllers/       // Execution orchestration
│   ├── playbookExecutionController.go
│   ├── runTaskController.go
│   ├── conditionController.go
│   └── subPlaybookController.go
├── models/                     // Data models
│   ├── playbook.go
│   ├── case.go
│   ├── task.go
│   └── Response.go
├── executionModels/           // Execution-specific models
│   ├── playbook.go
│   ├── Tasks.go
│   └── incidents.go
├── services/                  // Business logic
│   ├── genericTaskService.go
│   ├── processService.go
│   └── filterNTransformService.go
├── utils/                     // Utility functions
│   ├── filterConditionUtils.go
│   ├── matchConditionUtils.go
│   └── executionUtils.go
├── handlers/                  // Error and response handlers
│   ├── errorHandler.go
│   └── taskResponse.go
├── constants/                 // Application constants
│   └── constants.go
└── cacheControllers/         // Cache management
    └── cacheController.go</code></pre>

        <h2 id="class-diagrams">3. Class Diagrams</h2>
        
        <h3>3.1 Playbook Execution Model</h3>
        <div class="mermaid">
classDiagram
    class PlaybookExecutionController {
        +PlayBookTasksMap map[int]PlayBookTask
        +MapMutex sync.RWMutex
        +TenantCode string
        +CaseID string
        +PlaybookExecutionID string
        +UserID int
        +UserName string
        +AccessToken string
        +JwtToken string
        +IndicatorValue string
        +Completed bool
        +Stopped bool
        +RunSelectedPlaybook() error
        +ReadAndRunPlayBook() error
        +ProcessAndExecuteTask() error
        +WriteTaskMap(int, PlayBookTask)
        +ReadTaskMap(int) PlayBookTask
        +GetCompletionStatus() bool
        +SetCompletionStatus(bool)
        +GetStopStatus() bool
        +SetStopStatus(bool)
    }
    class PlayBookTask {
        +TaskID int
        +TaskSeq int
        +Type string
        +TaskName string
        +TaskTag string
        +InputFields []Inputfields
        +NextTask Object
        +PrevTask Object
        +Conditions []PlayBookCondition
        +ConditionOperator string
        +NextTaskOnTrue Object
        +NextTaskOnFalse Object
        +PEID string
        +TenantCode string
        +PlayBookName string
        +IsFirstTask bool
        +Status string
        +HasFlowControl bool
        +ConditionResult bool
        +GetTaskData() error
        +UpdatePlayBookErrorStatus() error
        +UpdatePlayBookExecutionStatus() error
        +CreateFailedTaskEntry() error
    }
    class PlaybookObject {
        +ID int
        +Name string
        +Description string
        +Definition string
        +ChartDefinition string
        +TenantCode string
        +CategoryID int
        +Status string
        +IsParallelPlaybook bool
        +TotalTasksCount int
        +GetPlaybookData() error
        +ImportPlaybook2() error
        +CreateImportedPlaybook() error
    }
    PlaybookExecutionController --> PlayBookTask : manages
    PlayBookTask --> PlaybookObject : executes
        </div>

        <h3>3.2 Task Execution Model</h3>
        <div class="mermaid">
classDiagram
    class TaskRequest {
        +TaskObjectID primitive.ObjectID
        +TaskRequestID string
        +TaskID int
        +UserID int
        +PEID string
        +TaskSeq int
        +Input string
        +Response string
        +Processed string
        +CreatedDate int64
        +UpdatedDate int64
        +TasksTag string
        +TenantCode string
        +AlertID int
        +Status string
        +ExecutionStatus string
        +CreateTaskRequest() error
    }
    class TaskResponse {
        +TaskResponseID int
        +TaskRequestID string
        +Response string
        +TenantCode string
        +CreatedDate int64
        +ApprovalStatus string
        +PlaybookName string
    }
    class ActiveInstanceObject {
        +InstanceID int
        +IntegrationID int64
        +TenantCode string
        +Title string
        +Status string
        +Fields Object
        +FieldsMap map[string]Object
        +CredentialsID int
        +BaseURL string
        +IsCustomApp bool
    }
    TaskRequest --> TaskResponse : generates
    TaskRequest --> ActiveInstanceObject : uses
        </div>

        <h2 id="sequence-diagrams">4. Sequence Diagrams</h2>
        
        <h3>4.1 Playbook Execution Flow</h3>
        <div class="mermaid">
sequenceDiagram
    participant Client
    participant Router
    participant Controller
    participant ExecutionController
    participant TaskExecutor
    participant Database
    participant ExternalSystem
    Client->>Router: POST /runplaybook/
    Router->>Controller: Route request
    Controller->>ExecutionController: RunSelectedPlaybook()
    ExecutionController->>Database: Get playbook definition
    Database-->>ExecutionController: Playbook data
    ExecutionController->>ExecutionController: ReadAndRunPlayBook()
    ExecutionController->>Database: Create execution entry
    loop For each task
        ExecutionController->>TaskExecutor: ProcessAndExecuteTask()
        TaskExecutor->>Database: Get task configuration
        TaskExecutor->>ExternalSystem: Execute task
        ExternalSystem-->>TaskExecutor: Task response
        TaskExecutor->>Database: Save task response
        TaskExecutor-->>ExecutionController: Task completed
    end
    ExecutionController->>Database: Update execution status
    ExecutionController-->>Controller: Execution complete
    Controller-->>Router: Response
    Router-->>Client: Final response
        </div>

        <h2 id="database-schema">5. Database Schema</h2>
        
        <h3>5.1 MongoDB Collections Schema</h3>
        
        <h4>5.1.1 Playbook Collection</h4>
        <pre><code>{
  "_id": ObjectId,
  "id": 1001,
  "name": "Malware Response Playbook",
  "description": "Automated malware response workflow",
  "version": "1.0.0",
  "definition": "...",
  "chart_definition": "...",
  "tenant_code": "tenant123",
  "category_id": 5,
  "status": "active",
  "created_date": 1694443200000,
  "updated_date": 1694443200000,
  "user_id": 1001,
  "group_id": 100,
  "type": "case",
  "filename": "1001_tenant123.json",
  "commit_id": "abc123",
  "list_names": ["suspicious_ips", "malware_domains"],
  "all_nodes_connected": "yes",
  "custom_utils_added": false,
  "custom_utils_names": [],
  "vertical_pb": false,
  "is_parallel_playbook": true,
  "total_tasks_count": 15,
  "total_utils_count": 3,
  "shard_bucket": 1
}</code></pre>

        <h3>5.2 Data Relationships</h3>
        <div class="mermaid">
erDiagram
    PLAYBOOK_COLLECTION ||--o{ PLAYBOOK_EXECUTION_COLLECTION : executes
    PLAYBOOK_EXECUTION_COLLECTION ||--o{ TASK_EXECUTION_COLLECTION : contains
    PLAYBOOK_EXECUTION_COLLECTION ||--o{ STOPPED_TASKS_COLLECTION : may_have
    INCIDENTS_COLLECTION ||--o{ PLAYBOOK_EXECUTION_COLLECTION : triggers
    TASK_COLLECTION ||--o{ TASK_EXECUTION_COLLECTION : defines
    INTEGRATION_COLLECTION ||--o{ TASK_EXECUTION_COLLECTION : provides
    INSTANCE_COLLECTION ||--o{ TASK_EXECUTION_COLLECTION : executes_on
        </div>

        <h2 id="api-specifications">6. API Specifications</h2>
        
        <h3>6.1 Playbook Management APIs</h3>
        
        <h4>6.1.1 Create Playbook</h4>
        <pre><code>POST /createplaybook/
Content-Type: application/json
Authorization: Bearer {jwt_token}

Request Body:
{
  "name": "Malware Response Playbook",
  "description": "Automated response to malware incidents",
  "definition": "...",
  "chart_definition": "...",
  "category_id": 5,
  "type": "case",
  "tenant_code": "tenant123",
  "user_id": 1001,
  "version": "1.0.0",
  "is_parallel_playbook": true,
  "total_tasks_count": 15,
  "total_utils_count": 3
}

Response:
{
  "success": true,
  "data": {
    "playbook_id": 1001,
    "filename": "1001_tenant123.json",
    "commit_id": "abc123"
  },
  "error": "",
  "displayMessage": "Playbook created successfully",
  "time": 1694443200000
}</code></pre>

        <h4>6.1.2 Run Playbook</h4>
        <pre><code>POST /runplaybook/
Content-Type: application/json
Authorization: Bearer {jwt_token}

Request Body:
{
  "tenantcode": "tenant123",
  "playbook_name": "Malware Response Playbook",
  "case_id": "50001",
  "is_bot": "false",
  "uid": "1001",
  "username": "security_analyst",
  "type": "case",
  "indicator": "192.168.1.100",
  "playbook_execution_id": "",
  "resume_playbook": "false"
}

Response:
{
  "success": true,
  "data": {
    "playbook_execution_id": "pb_exec_123456",
    "status": "inprogress",
    "total_tasks": 15,
    "estimated_duration": 300000
  },
  "error": "",
  "displayMessage": "Playbook execution started",
  "time": 1694443200000
}</code></pre>

        <h2 id="algorithm-specifications">7. Algorithm Specifications</h2>
        <p>This section includes detailed algorithm implementations for core functionalities like parallel task execution, condition evaluation, and cache management.</p>

        <h2 id="configuration-management">8. Configuration Management</h2>
        <p>Configuration structure and environment-based configuration management for the service.</p>

        <h2 id="error-handling-implementation">9. Error Handling Implementation</h2>
        <p>Comprehensive error handling strategies including error types, hierarchy, and retry mechanisms.</p>

        <h2 id="concurrency--thread-safety">10. Concurrency & Thread Safety</h2>
        <p>Thread-safe implementations for concurrent operations and channel-based communication patterns.</p>

        <h2 id="performance-optimizations">11. Performance Optimizations</h2>
        <p>Performance optimization techniques including connection pooling, batch operations, and memory management.</p>

        <h2 id="testing-strategy">12. Testing Strategy</h2>
        <p>Comprehensive testing approach including unit testing, integration testing, and performance testing strategies.</p>

    </main>
</body>
</html>
