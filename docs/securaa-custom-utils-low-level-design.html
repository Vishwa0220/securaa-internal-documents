<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Securaa Custom Utils - Low Level Design - Securaa Platform Documentation</title>
    <link rel="stylesheet" href="assets/css/documentation.css">
</head>
<body>
    <header class="main-header">
        <h1>Securaa Platform Documentation</h1>
        <p>Comprehensive documentation for Securaa security platform services</p>
    </header>
    
    <nav class="documentation-nav">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="securaa-playbook-high-level-design.html">Securaa Playbook High Level Design</a></li>
            <li><a href="securaa-playbook-low-level-design.html">Securaa Playbook Low Level Design</a></li>
            <li><a href="optimization-guide.html">Optimization Guide</a></li>
            <li><a href="securaa-siem-high-level-design.html">Securaa SIEM High Level Design</a></li>
            <li><a href="securaa-siem-low-level-design.html">Securaa SIEM Low Level Design</a></li>
            <li><a href="securaa-platform-high-level-design.html">Securaa Platform</a></li>
            <li><a href="process-manager-high-level-design.html">Process Manager High Level Design</a></li>
            <li><a href="process-manager-low-level-design.html">Process Manager Low Level Design</a></li>
            <li><a href="securaa-user-high-level-design.html">Securaa User High Level Design</a></li>
            <li><a href="securaa-user-low-level-design.html">Securaa User Low Level Design</a></li>
            <li><a href="securaa-custom-services-high-level-design.html">Securaa Custom Services High Level Design</a></li>
            <li><a href="securaa-custom-services-low-level-design.html">Securaa Custom Services Low Level Design</a></li>
            <li><a href="securaa-custom-utils-high-level-design.html">Securaa Custom Utils High Level Design</a></li>
            <li><a href="securaa-custom-utils-low-level-design.html" class="active">Securaa Custom Utils Low Level Design</a></li>
        </ul>
    </nav>
    
    <main class="main-content">
        <h1>Securaa Custom Utils - Low Level Design</h1>

        <h2>Document Information</h2>
        <ul>
            <li><strong>Service Name</strong>: Securaa Custom Utils Service</li>
            <li><strong>Version</strong>: 1.0</li>
            <li><strong>Date</strong>: September 2025</li>
            <li><strong>Author</strong>: Development Team</li>
            <li><strong>Related Documents</strong>: <a href="securaa-custom-utils-high-level-design.html">High Level Design</a></li>
        </ul>
        
        <h2>Table of Contents</h2>
        <ol>
            <li><a href="#technical-implementation">Technical Implementation</a></li>
            <li><a href="#database-design">Database Design</a></li>
            <li><a href="#api-specifications">API Specifications</a></li>
            <li><a href="#class-design">Class Design</a></li>
            <li><a href="#security-implementation">Security Implementation</a></li>
            <li><a href="#performance-optimization">Performance Optimization</a></li>
            <li><a href="#error-handling">Error Handling</a></li>
            <li><a href="#deployment-configuration">Deployment Configuration</a></li>
            <li><a href="#monitoring-logging">Monitoring & Logging</a></li>
        </ol>

        <h2 id="technical-implementation">Technical Implementation</h2>
        <h3>Technology Stack</h3>
        <ul>
            <li><strong>Programming Language</strong>: Python 3.9+</li>
            <li><strong>Web Framework</strong>: FastAPI</li>
            <li><strong>Database</strong>: MongoDB with Motor (async driver)</li>
            <li><strong>Cache</strong>: Redis with aioredis</li>
            <li><strong>Container Runtime</strong>: Docker</li>
            <li><strong>Authentication</strong>: JWT with custom middleware</li>
            <li><strong>Validation</strong>: Pydantic models</li>
            <li><strong>Testing</strong>: pytest with async support</li>
        </ul>

        <h3>Project Structure</h3>
        <pre><code>
securaa_custom_utils/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI application entry point
│   ├── config.py               # Configuration management
│   ├── dependencies.py         # Dependency injection setup
│   │
│   ├── api/
│   │   ├── __init__.py
│   │   ├── v1/
│   │   │   ├── __init__.py
│   │   │   ├── endpoints/
│   │   │   │   ├── __init__.py
│   │   │   │   ├── utils.py    # Utils management endpoints
│   │   │   │   ├── execution.py # Code execution endpoints
│   │   │   │   └── health.py   # Health check endpoints
│   │   │   └── api.py          # API router
│   │   └── deps.py             # API dependencies
│   │
│   ├── core/
│   │   ├── __init__.py
│   │   ├── config.py           # Core configuration
│   │   ├── security.py         # Security utilities
│   │   ├── logging.py          # Logging configuration
│   │   └── exceptions.py       # Custom exceptions
│   │
│   ├── models/
│   │   ├── __init__.py
│   │   ├── base.py             # Base Pydantic models
│   │   ├── utils.py            # Utils domain models
│   │   ├── execution.py        # Execution models
│   │   └── user.py             # User models
│   │
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── utils.py            # Utils API schemas
│   │   ├── execution.py        # Execution API schemas
│   │   └── common.py           # Common response schemas
│   │
│   ├── services/
│   │   ├── __init__.py
│   │   ├── utils_service.py    # Utils business logic
│   │   ├── execution_service.py # Execution business logic
│   │   ├── validation_service.py # Code validation service
│   │   ├── container_service.py # Container management
│   │   └── audit_service.py    # Audit logging service
│   │
│   ├── repositories/
│   │   ├── __init__.py
│   │   ├── base.py             # Base repository pattern
│   │   ├── utils_repository.py # Utils data access
│   │   ├── execution_repository.py # Execution data access
│   │   └── cache_repository.py # Cache operations
│   │
│   ├── utils/
│   │   ├── __init__.py
│   │   ├── security.py         # Security utilities
│   │   ├── validation.py       # Code validation utilities
│   │   ├── container.py        # Container utilities
│   │   └── file_manager.py     # File management utilities
│   │
│   └── middleware/
│       ├── __init__.py
│       ├── auth.py             # Authentication middleware
│       ├── tenant.py           # Multi-tenant middleware
│       └── logging.py          # Request logging middleware
│
├── tests/
├── deployment/
├── docs/
├── requirements.txt
├── pyproject.toml
└── README.md
        </code></pre>

        <h2 id="database-design">Database Design</h2>
        <h3>MongoDB Collections</h3>

        <h4>Custom Utils Collection</h4>
        <pre><code>
{
  "_id": "ObjectId",
  "util_id": "string (UUID)",
  "tenant_id": "string",
  "user_id": "string",
  "name": "string",
  "description": "string",
  "code": "string",
  "language": "python",
  "parameters": {
    "input_schema": {},
    "output_schema": {},
    "dependencies": []
  },
  "metadata": {
    "version": "string",
    "tags": [],
    "category": "string"
  },
  "validation": {
    "is_valid": "boolean",
    "validation_errors": [],
    "security_score": "number"
  },
  "execution_config": {
    "timeout_seconds": "number",
    "memory_limit_mb": "number",
    "cpu_limit": "number"
  },
  "status": "active|inactive|deleted",
  "created_at": "datetime",
  "updated_at": "datetime",
  "created_by": "string",
  "updated_by": "string"
}
        </code></pre>

        <h3>Database Indexes</h3>
        <div class="mermaid">
graph TB
    subgraph "MongoDB Indexes"
        subgraph "Custom Utils Indexes"
            UTIL_TENANT["{tenant_id: 1, status: 1}"]
            UTIL_USER["{user_id: 1, created_at: -1}"]
            UTIL_NAME["{tenant_id: 1, name: 1}"]
            UTIL_STATUS["{status: 1, updated_at: -1}"]
        end
        
        subgraph "Execution History Indexes"
            EXEC_UTIL["{util_id: 1, started_at: -1}"]
            EXEC_USER["{user_id: 1, started_at: -1}"]
            EXEC_STATUS["{status: 1, started_at: -1}"]
            EXEC_TENANT["{tenant_id: 1, started_at: -1}"]
        end
    end
        </div>

        <h2 id="api-specifications">API Specifications</h2>
        <h3>REST API Endpoints</h3>

        <h4>Utils Management APIs</h4>
        <table>
            <thead>
                <tr>
                    <th>Endpoint</th>
                    <th>Method</th>
                    <th>Description</th>
                    <th>Request Body</th>
                    <th>Response</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>/api/v1/utils</td>
                    <td>POST</td>
                    <td>Create custom utility</td>
                    <td>CreateUtilRequest</td>
                    <td>UtilResponse</td>
                </tr>
                <tr>
                    <td>/api/v1/utils</td>
                    <td>GET</td>
                    <td>List utilities (paginated)</td>
                    <td>Query parameters</td>
                    <td>PaginatedUtilResponse</td>
                </tr>
                <tr>
                    <td>/api/v1/utils/{util_id}</td>
                    <td>GET</td>
                    <td>Get utility details</td>
                    <td>None</td>
                    <td>UtilResponse</td>
                </tr>
                <tr>
                    <td>/api/v1/utils/{util_id}</td>
                    <td>PUT</td>
                    <td>Update utility</td>
                    <td>UpdateUtilRequest</td>
                    <td>UtilResponse</td>
                </tr>
                <tr>
                    <td>/api/v1/utils/{util_id}</td>
                    <td>DELETE</td>
                    <td>Delete utility</td>
                    <td>None</td>
                    <td>DeleteResponse</td>
                </tr>
                <tr>
                    <td>/api/v1/utils/{util_id}/execute</td>
                    <td>POST</td>
                    <td>Execute utility</td>
                    <td>ExecutionRequest</td>
                    <td>ExecutionResponse</td>
                </tr>
            </tbody>
        </table>

        <h2 id="class-design">Class Design</h2>
        <h3>Core Service Classes</h3>

        <div class="mermaid">
classDiagram
    class UtilsService {
        +create_util(util_data: CreateUtilRequest) UtilResponse
        +get_util(util_id: str) UtilResponse
        +update_util(util_id: str, util_data: UpdateUtilRequest) UtilResponse
        +delete_util(util_id: str) DeleteResponse
        +list_utils(filters: UtilFilters) PaginatedUtilResponse
        +validate_util(util_id: str) ValidationResponse
        -_validate_permissions(user_id: str, util_id: str) bool
    }
    
    class ExecutionService {
        +execute_util(util_id: str, execution_data: ExecutionRequest) ExecutionResponse
        +get_execution_status(execution_id: str) ExecutionStatusResponse
        +get_execution_logs(execution_id: str) LogsResponse
        -_prepare_execution_environment(util: Util) Container
        -_execute_in_container(container: Container, code: str, input_data: dict) ExecutionResult
        -_cleanup_container(container: Container) None
    }
    
    class ValidationService {
        +validate_code(code: str, language: str) ValidationResult
        +security_scan(code: str) SecurityScanResult
        +check_dependencies(dependencies: list) DependencyCheckResult
        -_ast_analysis(code: str) ASTAnalysisResult
        -_detect_security_issues(ast_tree: AST) list
    }
    
    class ContainerService {
        +create_container(image: str, config: ContainerConfig) Container
        +execute_code(container: Container, code: str, input_data: dict) ExecutionResult
        +destroy_container(container: Container) None
        +list_containers() list
        -_apply_security_policies(container: Container) None
    }
    
    UtilsService --> ValidationService
    ExecutionService --> ContainerService
    ExecutionService --> ValidationService
        </div>

        <h2 id="security-implementation">Security Implementation</h2>
        <h3>Authentication & Authorization</h3>

        <h4>JWT Authentication Middleware</h4>
        <pre><code>
class JWTAuthMiddleware:
    def __init__(self, secret_key: str, algorithm: str = "HS256"):
        self.secret_key = secret_key
        self.algorithm = algorithm
        self.jwt_decoder = JWTDecoder(secret_key, algorithm)
    
    async def __call__(self, request: Request, call_next):
        # Skip authentication for health check endpoints
        if request.url.path in SKIP_AUTH_PATHS:
            return await call_next(request)
        
        # Extract JWT token from Authorization header
        auth_header = request.headers.get("Authorization")
        if not auth_header or not auth_header.startswith("Bearer "):
            raise HTTPException(
                status_code=401,
                detail="Missing or invalid authorization header"
            )
        
        token = auth_header.split(" ")[1]
        
        try:
            # Decode and validate JWT token
            payload = self.jwt_decoder.decode(token)
            
            # Extract user and tenant information
            user_id = payload.get("user_id")
            tenant_id = payload.get("tenant_id")
            permissions = payload.get("permissions", [])
            
            # Add user context to request state
            request.state.user_id = user_id
            request.state.tenant_id = tenant_id
            request.state.permissions = permissions
            
        except JWTError as e:
            raise HTTPException(
                status_code=401,
                detail=f"Invalid token: {str(e)}"
            )
        
        return await call_next(request)
        </code></pre>

        <h3>Container Security</h3>

        <div class="mermaid">
graph TB
    subgraph "Container Security Layers"
        subgraph "Image Security"
            BASE_IMAGE[Minimal Base Image]
            SECURITY_SCAN[Vulnerability Scanning]
            SIGNED_IMAGES[Image Signing]
        end
        
        subgraph "Runtime Security"
            NO_ROOT[Non-root User]
            READ_ONLY[Read-only Filesystem]
            RESOURCE_LIMITS[Resource Limits]
            NETWORK_ISOLATION[Network Isolation]
        end
        
        subgraph "Execution Security"
            SECCOMP[Seccomp Profiles]
            APPARMOR[AppArmor/SELinux]
            CAPABILITIES[Dropped Capabilities]
            TIME_LIMITS[Execution Timeouts]
        end
    end
    
    BASE_IMAGE --> NO_ROOT
    SECURITY_SCAN --> READ_ONLY
    SIGNED_IMAGES --> RESOURCE_LIMITS
    
    NO_ROOT --> SECCOMP
    READ_ONLY --> APPARMOR
    RESOURCE_LIMITS --> CAPABILITIES
    NETWORK_ISOLATION --> TIME_LIMITS
        </div>

        <h2 id="performance-optimization">Performance Optimization</h2>
        <h3>Caching Strategy Implementation</h3>

        <h4>Multi-Level Cache</h4>
        <pre><code>
class CacheManager:
    def __init__(self, redis_client: Redis):
        self.redis = redis_client
        self.local_cache = {}
        self.cache_stats = CacheStats()
    
    async def get(self, key: str, fetch_func: callable = None) -> any:
        """Multi-level cache get with fallback"""
        
        # L1: Check local cache first
        if key in self.local_cache:
            self.cache_stats.l1_hits += 1
            return self.local_cache[key]
        
        # L2: Check Redis cache
        redis_value = await self.redis.get(key)
        if redis_value:
            self.cache_stats.l2_hits += 1
            # Store in local cache for future requests
            self.local_cache[key] = json.loads(redis_value)
            return self.local_cache[key]
        
        # L3: Fetch from source if fetch function provided
        if fetch_func:
            self.cache_stats.cache_misses += 1
            value = await fetch_func()
            
            # Store in both caches
            await self.set(key, value, ttl=300)  # 5 minutes TTL
            return value
        
        return None
        </code></pre>

        <h2 id="error-handling">Error Handling</h2>
        <h3>Exception Hierarchy</h3>

        <div class="mermaid">
classDiagram
    class CustomUtilsException {
        +message: str
        +error_code: str
        +details: dict
        +__init__(message: str, error_code: str, details: dict)
        +to_dict() dict
    }
    
    class ValidationException {
        +validation_errors: list
        +__init__(errors: list)
    }
    
    class ExecutionException {
        +execution_id: str
        +container_id: str
        +__init__(message: str, execution_id: str, container_id: str)
    }
    
    class SecurityException {
        +security_violations: list
        +risk_level: str
        +__init__(violations: list, risk_level: str)
    }
    
    CustomUtilsException <|-- ValidationException
    CustomUtilsException <|-- ExecutionException
    CustomUtilsException <|-- SecurityException
        </div>

        <h2 id="deployment-configuration">Deployment Configuration</h2>
        <h3>Docker Configuration</h3>

        <h4>Application Dockerfile</h4>
        <pre><code>
FROM python:3.9-slim as builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements and install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Production stage
FROM python:3.9-slim

# Create non-root user
RUN groupadd -r appuser && useradd -r -g appuser appuser

# Install runtime dependencies
RUN apt-get update && apt-get install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Copy Python packages from builder stage
COPY --from=builder /usr/local/lib/python3.9/site-packages /usr/local/lib/python3.9/site-packages
COPY --from=builder /usr/local/bin /usr/local/bin

# Create app directory
WORKDIR /app

# Copy application code
COPY app/ ./app/
COPY deployment/scripts/ ./scripts/

# Set ownership and permissions
RUN chown -R appuser:appuser /app
USER appuser

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# Expose port
EXPOSE 8000

# Start application
CMD ["python", "-m", "app.main"]
        </code></pre>

        <h2 id="monitoring-logging">Monitoring & Logging</h2>
        <h3>Metrics Collection</h3>

        <h4>Application Metrics</h4>
        <pre><code>
from prometheus_client import Counter, Histogram, Gauge

# Define metrics
utils_created_total = Counter(
    'utils_created_total',
    'Total number of utilities created',
    ['tenant_id', 'user_id']
)

utils_executed_total = Counter(
    'utils_executed_total',
    'Total number of utility executions',
    ['tenant_id', 'util_id', 'status']
)

execution_duration_seconds = Histogram(
    'execution_duration_seconds',
    'Time spent executing utilities',
    ['tenant_id', 'util_id']
)

active_containers = Gauge(
    'active_containers',
    'Number of active execution containers'
)
        </code></pre>

        <h3>Structured Logging</h3>

        <h4>Log Format</h4>
        <pre><code>
{
  "timestamp": "2025-09-30T10:30:00.123Z",
  "level": "INFO",
  "service": "securaa-custom-utils",
  "version": "1.0.0",
  "logger": "app.services.execution_service",
  "message": "Utility execution completed successfully",
  "context": {
    "tenant_id": "tenant_123",
    "user_id": "user_456",
    "util_id": "util_789",
    "execution_id": "exec_101112",
    "execution_time_ms": 1250,
    "memory_used_mb": 45,
    "container_id": "container_abc123"
  },
  "request_id": "req_987654321",
  "trace_id": "trace_555666777"
}
        </code></pre>

        <h2>Conclusion</h2>
        <p>This low-level design provides a comprehensive technical implementation guide for the Securaa Custom Utils Service. The design emphasizes security, performance, and maintainability through:</p>

        <ul>
            <li><strong>Secure Architecture</strong>: Multi-layered security with container isolation and code validation</li>
            <li><strong>Scalable Design</strong>: Microservice architecture with horizontal scaling capabilities</li>
            <li><strong>Performance Optimization</strong>: Multi-level caching and optimized database queries</li>
            <li><strong>Comprehensive Monitoring</strong>: Detailed metrics collection and structured logging</li>
            <li><strong>Maintainable Codebase</strong>: Clear separation of concerns and well-defined interfaces</li>
        </ul>

        <p>The implementation follows industry best practices for microservice development, security, and DevOps, ensuring a production-ready solution that can scale with business requirements.</p>
    </main>
    
    <footer class="main-footer">
        <p>&copy; 2025 Securaa Platform. All rights reserved. | <a href="#" onclick="printPage()" style="color: #ecf0f1;">Print</a> | <a href="#" onclick="exportToPDF()" style="color: #ecf0f1;">Export PDF</a></p>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.4/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#1976d2',
                primaryTextColor: '#000000',
                primaryBorderColor: '#0d47a1',
                lineColor: '#1976d2',
                secondaryColor: '#f5f5f5',
                tertiaryColor: '#ffffff'
            }
        });
    </script>
    <script src="assets/js/documentation.js"></script>
</body>
</html>