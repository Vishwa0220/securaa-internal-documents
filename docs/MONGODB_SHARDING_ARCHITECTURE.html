<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Securaa Platform Documentation - MongoDB Sharding Architecture">
    <title>MongoDB Sharding Architecture - Securaa Documentation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>

:root {
    --primary-color: #4f46e5;
    --primary-dark: #3730a3;
    --primary-light: #818cf8;
    --secondary-color: #06b6d4;
    --accent-color: #f59e0b;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --text-muted: #9ca3af;
    --bg-primary: #ffffff;
    --bg-secondary: #f9fafb;
    --bg-tertiary: #f3f4f6;
    --border-color: #e5e7eb;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    scroll-behavior: smooth;
    font-size: 16px;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.7;
    color: var(--text-primary);
    background-color: var(--bg-secondary);
}

/* Header */
.main-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 1rem 2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: var(--shadow-lg);
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-logo {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.025em;
}

.header-logo span {
    color: var(--secondary-color);
}

/* Navigation */
.documentation-nav {
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border-color);
    padding: 0.75rem 2rem;
    position: sticky;
    top: 60px;
    z-index: 999;
    box-shadow: var(--shadow-sm);
}

.nav-links {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    justify-content: center;
}

.nav-links a {
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
}

.nav-links a:hover {
    color: var(--primary-color);
    background: var(--bg-tertiary);
}

/* Main Content */
.main-content {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 2.5rem;
    background: var(--bg-primary);
    border-radius: 1rem;
    box-shadow: var(--shadow-md);
}

/* Typography */
h1, h2, h3, h4, h5, h6 {
    color: var(--text-primary);
    font-weight: 700;
    line-height: 1.3;
    margin-top: 2rem;
    margin-bottom: 1rem;
}

h1 {
    font-size: 2.5rem;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    padding-bottom: 0.75rem;
    border-bottom: 3px solid var(--primary-color);
    margin-top: 0;
}

h2 {
    font-size: 1.875rem;
    color: var(--primary-dark);
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0.5rem;
}

h3 {
    font-size: 1.5rem;
    color: var(--text-primary);
}

h4 {
    font-size: 1.25rem;
    color: var(--text-secondary);
}

h5 {
    font-size: 1.125rem;
}

h6 {
    font-size: 1rem;
    color: var(--text-muted);
}

p {
    margin-bottom: 1rem;
    color: var(--text-primary);
}

/* Links */
a {
    color: var(--primary-color);
    text-decoration: none;
    transition: color 0.2s ease;
}

a:hover {
    color: var(--primary-dark);
    text-decoration: underline;
}

/* Lists */
ul, ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
}

li {
    margin-bottom: 0.5rem;
}

li > ul, li > ol {
    margin-top: 0.5rem;
    margin-bottom: 0;
}

/* Code Blocks */
pre {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 1.25rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.5rem 0;
    font-size: 0.875rem;
    line-height: 1.6;
    box-shadow: var(--shadow-md);
}

code {
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 0.875em;
}

:not(pre) > code {
    background: var(--bg-tertiary);
    color: var(--primary-dark);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}

/* Tables */
table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.9rem;
    box-shadow: var(--shadow-sm);
    border-radius: 0.5rem;
    overflow: hidden;
}

thead {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
}

th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
}

td {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

tr:nth-child(even) {
    background: var(--bg-secondary);
}

tr:hover {
    background: var(--bg-tertiary);
}

/* Blockquotes */
blockquote {
    border-left: 4px solid var(--primary-color);
    padding: 1rem 1.5rem;
    margin: 1.5rem 0;
    background: var(--bg-secondary);
    border-radius: 0 0.5rem 0.5rem 0;
    font-style: italic;
    color: var(--text-secondary);
}

blockquote p:last-child {
    margin-bottom: 0;
}

/* Mermaid Diagrams - Enhanced Styling */
.mermaid {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 2rem 0;
    padding: 1.5rem;
    background: linear-gradient(135deg, #fafbfc 0%, #f0f4f8 100%);
    border-radius: 0.75rem;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    overflow-x: auto;
    overflow-y: visible;
    min-height: 200px;
}

.mermaid svg {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
}

/* Ensure diagrams scale properly */
.mermaid[data-processed="true"] {
    min-height: auto;
}

/* Diagram container for better control */
.diagram-container {
    width: 100%;
    overflow-x: auto;
    padding: 1rem 0;
}

/* HR Styling */
hr {
    border: none;
    border-top: 2px solid var(--border-color);
    margin: 2.5rem 0;
}

/* Table of Contents */
.toc {
    background: var(--bg-secondary);
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border-color);
}

.toc-title {
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 1rem;
    font-size: 1.125rem;
}

.toc ul {
    list-style: none;
    padding-left: 0;
}

.toc li {
    margin-bottom: 0.5rem;
}

.toc a {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.toc a:hover {
    color: var(--primary-color);
}

/* Document Info Box */
.doc-info {
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    font-size: 0.875rem;
}

.doc-info strong {
    color: var(--primary-color);
}

/* Footer */
.footer {
    text-align: center;
    padding: 2rem;
    background: var(--bg-tertiary);
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-top: 2rem;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
}

::-webkit-scrollbar-thumb {
    background: var(--text-muted);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}

/* Print Styles */
@media print {
    .main-header, .documentation-nav, .footer {
        display: none !important;
    }

    .main-content {
        max-width: none;
        margin: 0;
        padding: 20px;
        box-shadow: none;
        border-radius: 0;
    }

    body {
        background: white;
        font-size: 11pt;
    }

    h1 {
        font-size: 24pt;
        -webkit-text-fill-color: var(--primary-dark);
        page-break-after: avoid;
    }

    h2, h3, h4 {
        page-break-after: avoid;
    }

    pre {
        background: #f5f5f5 !important;
        color: #333 !important;
        border: 1px solid #ddd;
        page-break-inside: avoid;
        font-size: 9pt;
    }

    table {
        page-break-inside: avoid;
    }

    .mermaid {
        page-break-inside: avoid;
        background: white !important;
        border: 1px solid #ddd;
        max-width: 100% !important;
    }

    .mermaid svg {
        max-width: 100% !important;
        max-height: 700px !important;
    }

    a {
        color: var(--primary-dark) !important;
        text-decoration: none !important;
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .main-content {
        margin: 1rem;
        padding: 1.5rem;
        border-radius: 0.5rem;
    }

    h1 {
        font-size: 1.75rem;
    }

    h2 {
        font-size: 1.5rem;
    }

    .nav-links {
        gap: 0.75rem;
    }

    .nav-links a {
        font-size: 0.75rem;
        padding: 0.375rem 0.5rem;
    }

    pre {
        font-size: 0.8rem;
        padding: 1rem;
    }

    table {
        font-size: 0.8rem;
    }

    th, td {
        padding: 0.5rem;
    }
}

/* Animation for smooth transitions */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.main-content {
    animation: fadeIn 0.3s ease-out;
}

/* Index-specific styles */
.hero {
    text-align: center;
    padding: 3rem 0;
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    border-radius: 1rem;
    margin-bottom: 3rem;
}

.hero h1 {
    font-size: 3rem;
    margin-bottom: 1rem;
    border: none;
    padding: 0;
}

.hero p {
    font-size: 1.25rem;
    color: var(--text-secondary);
    max-width: 600px;
    margin: 0 auto;
}

.doc-sections {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.doc-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
}

.doc-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-light);
}

.doc-card h3 {
    color: var(--primary-color);
    font-size: 1.25rem;
    margin-top: 0;
    margin-bottom: 0.75rem;
}

.doc-card p {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.doc-card .links {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.doc-card .links a {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
    background: var(--bg-secondary);
    border-radius: 0.375rem;
    transition: all 0.2s ease;
}

.doc-card .links a:hover {
    background: var(--primary-color);
    color: white;
    text-decoration: none;
}

.section-title {
    font-size: 1.75rem;
    color: var(--primary-dark);
    margin-top: 3rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-color);
}

    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <div class="header-logo">Securaa<span>Docs</span></div>
            <div class="header-meta">
                <span>Generated: December 18, 2025</span>
            </div>
        </div>
    </header>

    <nav class="documentation-nav">
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="securaa-platform-high-level-design.html">Platform</a>
            <a href="securaa-playbook-high-level-design.html">Playbook</a>
            <a href="securaa-siem-high-level-design.html">SIEM</a>
            <a href="securaa-user-high-level-design.html">User Service</a>
            <a href="securaa-custom-services-high-level-design.html">Custom Services</a>
            <a href="sia-service-high-level-design.html">SIA Service</a>
            <a href="securaa-ris-high-level-design.html">RIS</a>
        </div>
    </nav>

    <main class="main-content">
        <h1 id="securaa-mongodb-sharding-scalable-architecture">SECURAA MongoDB Sharding Scalable Architecture</h1>
<h2 id="document-version-10">Document Version: 1.0</h2>
<h2 id="last-updated-december-2024">Last Updated: December 2024</h2>
<hr />
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#1-executive-summary">Executive Summary</a></li>
<li><a href="#2-current-architecture-overview">Current Architecture Overview</a></li>
<li><a href="#3-sharding-architecture-design">Sharding Architecture Design</a></li>
<li><a href="#4-component-details">Component Details</a></li>
<li><a href="#5-collection-sharding-strategy">Collection Sharding Strategy</a></li>
<li><a href="#6-high-availability-configuration">High Availability Configuration</a></li>
<li><a href="#7-deployment-architecture">Deployment Architecture</a></li>
<li><a href="#8-data-flow-architecture">Data Flow Architecture</a></li>
<li><a href="#9-scaling-strategies">Scaling Strategies</a></li>
<li><a href="#10-operational-procedures">Operational Procedures</a></li>
<li><a href="#11-monitoring-and-alerting">Monitoring and Alerting</a></li>
<li><a href="#12-disaster-recovery">Disaster Recovery</a></li>
</ol>
<hr />
<h2 id="1-executive-summary">1. Executive Summary</h2>
<h3 id="11-purpose">1.1 Purpose</h3>
<p>This document provides a comprehensive MongoDB sharding architecture for the SECURAA platform - a Security Orchestration, Automation and Response (SOAR) system. The architecture is designed to handle:
- Multi-tenant (MSSP) deployments
- High-volume security incident data
- Real-time case processing
- Scalable integration management
- Enterprise-grade reliability</p>
<h3 id="12-key-architecture-decisions">1.2 Key Architecture Decisions</h3>
<ul>
<li><strong>Sharding Type</strong>: Range-based and Hashed sharding based on collection access patterns</li>
<li><strong>Replica Set Configuration</strong>: 3-node replica sets for all shards</li>
<li><strong>Config Servers</strong>: Dedicated 3-node replica set (cfgrs)</li>
<li><strong>Query Routers</strong>: Multiple mongos instances behind load balancer</li>
<li><strong>Shard Key Strategy</strong>: Tenant-based compound keys for MSSP deployments</li>
</ul>
<h3 id="13-technology-stack">1.3 Technology Stack</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Version</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>MongoDB</td>
<td>7.0</td>
<td>Primary Database</td>
</tr>
<tr>
<td>Go</td>
<td>1.20+</td>
<td>Backend Services</td>
</tr>
<tr>
<td>Docker Swarm</td>
<td>Latest</td>
<td>Container Orchestration</td>
</tr>
<tr>
<td>Redis</td>
<td>Latest</td>
<td>Caching Layer</td>
</tr>
<tr>
<td>Kafka</td>
<td>Latest</td>
<td>Message Queue</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2-current-architecture-overview">2. Current Architecture Overview</h2>
<h3 id="21-project-structure">2.1 Project Structure</h3>
<div class="highlight"><pre><span></span><code><span class="nx">SECURAA</span><span class="w"> </span><span class="nx">Platform</span>
<span class="err">├──</span><span class="w"> </span><span class="nx">build_securaa</span><span class="o">/</span><span class="w">           </span><span class="err">#</span><span class="w"> </span><span class="nx">Core</span><span class="w"> </span><span class="nx">build</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">configuration</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">securaa</span><span class="o">/</span><span class="nx">common</span><span class="o">/</span><span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="nx">Shared</span><span class="w"> </span><span class="nx">utilities</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">MongoDB</span><span class="w"> </span><span class="nx">controller</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">pkg</span><span class="o">/</span><span class="nx">db</span><span class="o">/</span><span class="w">              </span><span class="err">#</span><span class="w"> </span><span class="nx">Database</span><span class="w"> </span><span class="nx">scripts</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="nx">migrations</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="nx">deployment_scripts</span><span class="o">/</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nx">Docker</span><span class="w"> </span><span class="nx">deployment</span><span class="w"> </span><span class="nx">scripts</span>
<span class="err">├──</span><span class="w"> </span><span class="nx">securaa</span><span class="o">/</span><span class="w">                 </span><span class="err">#</span><span class="w"> </span><span class="nx">Main</span><span class="w"> </span><span class="nx">SOAR</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="p">(</span><span class="nx">SIEM</span><span class="w"> </span><span class="nx">integrations</span><span class="p">)</span>
<span class="err">├──</span><span class="w"> </span><span class="nx">securaa_lib</span><span class="o">/</span><span class="w">             </span><span class="err">#</span><span class="w"> </span><span class="nx">Shared</span><span class="w"> </span><span class="nx">Go</span><span class="w"> </span><span class="kn">library</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">mongoclient</span><span class="o">/</span><span class="w">         </span><span class="err">#</span><span class="w"> </span><span class="nx">MongoDB</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="nx">wrapper</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">sharding</span><span class="w"> </span><span class="nx">support</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">config</span><span class="o">/</span><span class="w">              </span><span class="err">#</span><span class="w"> </span><span class="nx">Configuration</span><span class="w"> </span><span class="nx">management</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">common</span><span class="o">/</span><span class="w">              </span><span class="err">#</span><span class="w"> </span><span class="nx">Common</span><span class="w"> </span><span class="nx">utilities</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="nx">models</span><span class="o">/</span><span class="w">              </span><span class="err">#</span><span class="w"> </span><span class="nx">Data</span><span class="w"> </span><span class="nx">models</span>
<span class="err">├──</span><span class="w"> </span><span class="nx">zona_services</span><span class="o">/</span><span class="w">           </span><span class="err">#</span><span class="w"> </span><span class="nx">Backend</span><span class="w"> </span><span class="nx">microservices</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">zona_siem</span><span class="o">/</span><span class="w">           </span><span class="err">#</span><span class="w"> </span><span class="nx">SIEM</span><span class="w"> </span><span class="nx">integration</span><span class="w"> </span><span class="nx">service</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">zona_user</span><span class="o">/</span><span class="w">           </span><span class="err">#</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="nx">management</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">zona_playbook</span><span class="o">/</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="nx">Playbook</span><span class="w"> </span><span class="nx">engine</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">zona_integrations</span><span class="o">/</span><span class="w">   </span><span class="err">#</span><span class="w"> </span><span class="nx">Integration</span><span class="w"> </span><span class="nx">manager</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">zona_shard_handler</span><span class="o">/</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nx">Shard</span><span class="w"> </span><span class="nx">management</span><span class="w"> </span><span class="nx">service</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">custom_mongodb_shard</span><span class="o">/</span><span class="err">#</span><span class="w"> </span><span class="nx">MongoDB</span><span class="w"> </span><span class="nx">shard</span><span class="w"> </span><span class="nx">Docker</span><span class="w"> </span><span class="nx">image</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="nx">custom_mongos</span><span class="o">/</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="nx">Mongos</span><span class="w"> </span><span class="nx">Docker</span><span class="w"> </span><span class="nx">image</span>
<span class="err">├──</span><span class="w"> </span><span class="nx">zona_batch</span><span class="o">/</span><span class="w">              </span><span class="err">#</span><span class="w"> </span><span class="nx">Batch</span><span class="w"> </span><span class="nx">processing</span><span class="w"> </span><span class="nx">services</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">zona_case_consumer</span><span class="o">/</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nx">Case</span><span class="w"> </span><span class="nx">ingestion</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">SIEMs</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="nx">csam_connector</span><span class="o">/</span><span class="w">      </span><span class="err">#</span><span class="w"> </span><span class="nx">CSAM</span><span class="w"> </span><span class="nx">integration</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="nx">sla_breach_monitor</span><span class="o">/</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="nx">SLA</span><span class="w"> </span><span class="nx">monitoring</span>
<span class="err">├──</span><span class="w"> </span><span class="nx">integrations</span><span class="o">/</span><span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="mi">180</span><span class="o">+</span><span class="w"> </span><span class="nx">security</span><span class="w"> </span><span class="nx">integrations</span>
<span class="err">└──</span><span class="w"> </span><span class="nx">sia_service</span><span class="o">/</span><span class="w">             </span><span class="err">#</span><span class="w"> </span><span class="nx">AI</span><span class="o">/</span><span class="nx">ML</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">security</span><span class="w"> </span><span class="nx">insights</span>
</code></pre></div>

<h3 id="22-current-database-design">2.2 Current Database Design</h3>
<div class="highlight"><pre><span></span><code>Databases:
├── fkart_incidents (Core DB)     # Main SOAR database
├── meta_db                        # Sharding metadata
├── admin                          # Authentication
└── tenant_&lt;code&gt;_db              # Per-tenant databases (MSSP)
</code></pre></div>

<h3 id="23-existing-mongodb-configuration">2.3 Existing MongoDB Configuration</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Current mongod.conf</span>
<span class="nt">storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">dbPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/db</span>
<span class="nt">net</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bindIpAll</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27017</span>
<span class="nt">security</span><span class="p">:</span>
<span class="w">  </span><span class="nt">authorization</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enabled</span>
<span class="w">  </span><span class="nt">keyFile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/testkey</span>
</code></pre></div>

<hr />
<h2 id="3-sharding-architecture-design">3. Sharding Architecture Design</h2>
<h3 id="31-high-level-architecture-diagram">3.1 High-Level Architecture Diagram</h3>
<div class="mermaid">
graph TB
    LB[Load Balancer<br/>HAProxy / AWS ALB / Nginx]

    subgraph QueryRouters["Query Router Layer"]
        M1[Mongos #1<br/>Port: 27017]
        M2[Mongos #2<br/>Port: 27017]
        M3[Mongos #3<br/>Port: 27017]
    end

    subgraph ConfigLayer["Config Server Replica Set<br/>(cfgrs)<br/>Port: 28017"]
        CS1[Config Server 1<br/>Primary]
        CS2[Config Server 2<br/>Secondary]
        CS3[Config Server 3<br/>Secondary]
    end

    subgraph ShardLayer["Shard Layer"]
        subgraph Shard1["Shard 1 Replica Set - shard1rs - Port: 29017"]
            S1P[Primary<br/>Primary Host]
            S1S[Secondary<br/>Secondary Host]
            S1A[Arbiter<br/>Arbiter Host]
        end

        subgraph Shard2["Shard 2 Replica Set - shard2rs - Port: 29018"]
            S2P[Primary<br/>Primary Host]
            S2S[Secondary<br/>Secondary Host]
            S2A[Arbiter<br/>Arbiter Host]
        end

        subgraph ShardN["Shard N Replica Set - shardNrs - Port: 29066<br/>Up to 50 shards"]
            SNP[Primary<br/>Primary Host]
            SNS[Secondary<br/>Secondary Host]
            SNA[Arbiter<br/>Arbiter Host]
        end
    end

    subgraph MetaLayer["Meta Database Replica Set<br/>(metars)<br/>Port: 27018"]
        MP[Meta Primary<br/>Primary Host]
        MS[Meta Secondary<br/>Secondary Host]
        MA[Meta Arbiter<br/>Arbiter Host]
    end

    LB --> M1
    LB --> M2
    LB --> M3

    M1 --> ConfigLayer
    M2 --> ConfigLayer
    M3 --> ConfigLayer

    M1 --> ShardLayer
    M2 --> ShardLayer
    M3 --> ShardLayer

    ConfigLayer --> MetaLayer
</div>

<h3 id="32-port-allocation-strategy">3.2 Port Allocation Strategy</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Port Range</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>Mongos</td>
<td>27017</td>
<td>Query Router (Application Connection)</td>
</tr>
<tr>
<td>Meta DB</td>
<td>27018</td>
<td>Sharding Metadata Storage</td>
</tr>
<tr>
<td>Config Server</td>
<td>28017</td>
<td>Sharding Config Replica Set</td>
</tr>
<tr>
<td>Shard 1</td>
<td>29017</td>
<td>First Data Shard</td>
</tr>
<tr>
<td>Shard 2</td>
<td>29018</td>
<td>Second Data Shard</td>
</tr>
<tr>
<td>Shard N</td>
<td>29017 + (N-1)</td>
<td>Additional Shards (up to 29066)</td>
</tr>
</tbody>
</table>
<h3 id="33-connection-string-formats">3.3 Connection String Formats</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Mongos Connection (Recommended for Applications)</span>
<span class="nx">mongodb</span><span class="p">:</span><span class="c1">//root:S3cur@A_b3st@mongos1:27017,mongos2:27017,mongos3:27017/?authSource=admin</span>

<span class="c1">// Direct Shard Connection (Administrative)</span>
<span class="nx">mongodb</span><span class="p">:</span><span class="c1">//root:S3cur@A_b3st@shard1-primary:29017,shard1-secondary:29017/?replicaSet=shard1rs</span>

<span class="c1">// Meta DB Connection</span>
<span class="nx">mongodb</span><span class="p">:</span><span class="c1">//root:S3cur@A_b3st@meta-primary:27018,meta-secondary:27018/?replicaSet=metars</span>
</code></pre></div>

<hr />
<h2 id="4-component-details">4. Component Details</h2>
<h3 id="41-mongos-query-router">4.1 Mongos (Query Router)</h3>
<p><strong>Purpose</strong>: Routes queries to appropriate shards based on shard key</p>
<p><strong>Configuration</strong> (<code>/etc/mongos.conf</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nt">systemLog</span><span class="p">:</span>
<span class="w">  </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">file</span>
<span class="w">  </span><span class="nt">logAppend</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/log/mongodb/mongos.log</span>
<span class="w">  </span><span class="nt">logRotate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reopen</span>

<span class="nt">processManagement</span><span class="p">:</span>
<span class="w">  </span><span class="nt">timeZoneInfo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/zoneinfo</span>

<span class="nt">net</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bindIpAll</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27017</span>

<span class="nt">security</span><span class="p">:</span>
<span class="w">  </span><span class="nt">keyFile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/testkey</span>

<span class="nt">sharding</span><span class="p">:</span>
<span class="w">  </span><span class="nt">configDB</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cfgrs/config1:28017,config2:28017,config3:28017</span>
</code></pre></div>

<p><strong>Docker Service</strong> (<code>zona_services/custom_mongos/Dockerfile</code>):</p>
<div class="highlight"><pre><span></span><code><span class="k">FROM</span><span class="w"> </span><span class="s">mongo:7.0</span>
<span class="k">COPY</span><span class="w"> </span>config/limits.conf<span class="w"> </span>/etc/security/limits.conf
<span class="k">COPY</span><span class="w"> </span>config/mongos.conf<span class="w"> </span>/etc/mongos.conf
<span class="k">COPY</span><span class="w"> </span>config/testkey<span class="w"> </span>/etc/testkey
<span class="k">RUN</span><span class="w"> </span>chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span>/etc/testkey
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;mongos&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;-f&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;/etc/mongos.conf&quot;</span><span class="p">]</span>
</code></pre></div>

<h3 id="42-config-server-replica-set">4.2 Config Server Replica Set</h3>
<p><strong>Purpose</strong>: Stores cluster metadata, chunk distribution, and shard configuration</p>
<p><strong>Configuration</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">systemLog</span><span class="p">:</span>
<span class="w">  </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">file</span>
<span class="w">  </span><span class="nt">logAppend</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/log/mongodb/mongod.log</span>

<span class="nt">storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">dbPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/configdb</span>

<span class="nt">net</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bindIpAll</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">28017</span>

<span class="nt">security</span><span class="p">:</span>
<span class="w">  </span><span class="nt">authorization</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enabled</span>
<span class="w">  </span><span class="nt">keyFile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/testkey</span>

<span class="nt">replication</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replSetName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cfgrs</span>

<span class="nt">sharding</span><span class="p">:</span>
<span class="w">  </span><span class="nt">clusterRole</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configsvr</span>
</code></pre></div>

<h3 id="43-shard-servers">4.3 Shard Servers</h3>
<p><strong>Purpose</strong>: Store distributed data chunks</p>
<p><strong>Configuration</strong> (<code>zona_services/custom_mongodb_shard/config/mongod.conf</code>):</p>
<div class="highlight"><pre><span></span><code><span class="nt">systemLog</span><span class="p">:</span>
<span class="w">  </span><span class="nt">destination</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">file</span>
<span class="w">  </span><span class="nt">logAppend</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/log/mongodb/mongod.log</span>
<span class="w">  </span><span class="nt">logRotate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reopen</span>

<span class="nt">storage</span><span class="p">:</span>
<span class="w">  </span><span class="nt">dbPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data/db</span>

<span class="nt">processManagement</span><span class="p">:</span>
<span class="w">  </span><span class="nt">timeZoneInfo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/usr/share/zoneinfo</span>

<span class="nt">net</span><span class="p">:</span>
<span class="w">  </span><span class="nt">bindIpAll</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">27017</span>

<span class="nt">security</span><span class="p">:</span>
<span class="w">  </span><span class="nt">authorization</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">enabled</span>
<span class="w">  </span><span class="nt">keyFile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/testkey</span>

<span class="nt">replication</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replSetName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shardXrs</span>

<span class="nt">sharding</span><span class="p">:</span>
<span class="w">  </span><span class="nt">clusterRole</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shardsvr</span>
</code></pre></div>

<h3 id="44-meta-database">4.4 Meta Database</h3>
<p><strong>Purpose</strong>: Stores sharding configuration, HA status, and cluster membership</p>
<p><strong>Collections</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// meta_db database</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="s2">&quot;metadb_members&quot;</span><span class="p">)</span><span class="w">    </span><span class="c1">// Meta replica set members</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="s2">&quot;config_servers&quot;</span><span class="p">)</span><span class="w">    </span><span class="c1">// Config server members</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="s2">&quot;shards&quot;</span><span class="p">)</span><span class="w">            </span><span class="c1">// Shard replica set info</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="s2">&quot;ha_config&quot;</span><span class="p">)</span><span class="w">         </span><span class="c1">// High availability configuration</span>
</code></pre></div>

<h3 id="45-shard-handler-service">4.5 Shard Handler Service</h3>
<p><strong>Location</strong>: <code>zona_services/zona_shard_handler/</code></p>
<p><strong>Purpose</strong>: Manages shard lifecycle operations</p>
<p><strong>Endpoints</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Main endpoint for shard management</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">manageShardService</span><span class="o">/</span>
</code></pre></div>

<p><strong>Key Functions</strong> (from <code>securaa_lib/mongoclient/mongoclient.go</code>):</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Add new shard</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">AddNewShardService</span><span class="p">(</span><span class="nx">mongoDbHost</span><span class="p">,</span><span class="w"> </span><span class="nx">replicaSetName</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">configObject</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">ConfigStruct</span><span class="p">,</span><span class="w"> </span><span class="nx">conf</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span>

<span class="c1">// Remove shard</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">RemoveShardService</span><span class="p">(</span><span class="nx">mongoDbHost</span><span class="p">,</span><span class="w"> </span><span class="nx">replicaSetName</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">configObject</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">ConfigStruct</span><span class="p">,</span><span class="w"> </span><span class="nx">conf</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span>

<span class="c1">// Initialize replica set members</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">InitializeMembersInReplicaSet</span><span class="p">(</span><span class="nx">mongoDbHost</span><span class="p">,</span><span class="w"> </span><span class="nx">replicaSetName</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">replicaSetPort</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">members</span><span class="w"> </span><span class="p">[]</span><span class="nx">MemberConfig</span><span class="p">,</span><span class="w"> </span><span class="nx">configObject</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">ConfigStruct</span><span class="p">)</span>

<span class="c1">// Handle removing shards in progress</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">HandleRemovingShards</span><span class="p">(</span><span class="nx">configObject</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">ConfigStruct</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span>
</code></pre></div>

<hr />
<h2 id="5-collection-sharding-strategy">5. Collection Sharding Strategy</h2>
<h3 id="51-core-collections-analysis">5.1 Core Collections Analysis</h3>
<p>Based on codebase analysis, the following collections require sharding:</p>
<h4 id="511-high-volume-collections-priority-critical">5.1.1 High-Volume Collections (Priority: Critical)</h4>
<table>
<thead>
<tr>
<th>Collection</th>
<th>Shard Key</th>
<th>Strategy</th>
<th>Justification</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>zona_incidents</code></td>
<td><code>{tenantcode: 1, zona_z_incident_id: 1}</code></td>
<td>Range</td>
<td>Primary case data, queried by tenant</td>
</tr>
<tr>
<td><code>task_execution</code></td>
<td><code>{tenantcode: 1, taskid: 1}</code></td>
<td>Hashed</td>
<td>High write volume, distributed</td>
</tr>
<tr>
<td><code>playbooks_executions</code></td>
<td><code>{tenantcode: 1, playbook_id: 1}</code></td>
<td>Range</td>
<td>Execution history</td>
</tr>
<tr>
<td><code>auditCollection</code></td>
<td><code>{tenantcode: 1, date: 1}</code></td>
<td>Range</td>
<td>Time-series audit logs</td>
</tr>
<tr>
<td><code>zona_loginfo</code></td>
<td><code>{tenantcode: 1, _id: 1}</code></td>
<td>Hashed</td>
<td>Log aggregation</td>
</tr>
</tbody>
</table>
<h4 id="512-medium-volume-collections-priority-high">5.1.2 Medium-Volume Collections (Priority: High)</h4>
<table>
<thead>
<tr>
<th>Collection</th>
<th>Shard Key</th>
<th>Strategy</th>
<th>Justification</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>active_instance</code></td>
<td><code>{tenantcode: 1, integration_id: 1}</code></td>
<td>Range</td>
<td>Integration instances</td>
</tr>
<tr>
<td><code>playbooks</code></td>
<td><code>{tenantcode: 1, id: 1}</code></td>
<td>Range</td>
<td>Playbook definitions</td>
</tr>
<tr>
<td><code>tasks</code></td>
<td><code>{tenantcode: 1, id: 1}</code></td>
<td>Range</td>
<td>Task definitions</td>
</tr>
<tr>
<td><code>users</code></td>
<td><code>{tenantcode: 1, id: 1}</code></td>
<td>Range</td>
<td>User management</td>
</tr>
<tr>
<td><code>investigation</code></td>
<td><code>{tenantcode: 1, id: 1}</code></td>
<td>Range</td>
<td>Investigation data</td>
</tr>
</tbody>
</table>
<h4 id="513-low-volume-collections-unsharded">5.1.3 Low-Volume Collections (Unsharded)</h4>
<table>
<thead>
<tr>
<th>Collection</th>
<th>Justification</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>integration</code></td>
<td>Reference data, ~200 records</td>
</tr>
<tr>
<td><code>tenants</code></td>
<td>Master tenant list, low volume</td>
</tr>
<tr>
<td><code>roles</code></td>
<td>Permission definitions, static</td>
</tr>
<tr>
<td><code>incident_status</code></td>
<td>Enumeration data</td>
</tr>
<tr>
<td><code>incident_severities</code></td>
<td>Enumeration data</td>
</tr>
<tr>
<td><code>system</code></td>
<td>System configuration</td>
</tr>
<tr>
<td><code>current_release</code></td>
<td>Version info</td>
</tr>
</tbody>
</table>
<h3 id="52-sharding-commands">5.2 Sharding Commands</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Connect to mongos</span>
<span class="nx">mongosh</span><span class="w"> </span><span class="nx">mongodb</span><span class="o">:</span><span class="c1">//root:password@mongos:27017/admin</span>

<span class="c1">// Enable sharding on database</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">enableSharding</span><span class="p">(</span><span class="s2">&quot;fkart_incidents&quot;</span><span class="p">)</span>

<span class="c1">// Shard high-volume collections</span>
<span class="c1">// Incidents - Range sharding for tenant isolation</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">shardCollection</span><span class="p">(</span><span class="s2">&quot;fkart_incidents.zona_incidents&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;zona_z_incident_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// Task executions - Hashed for write distribution</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">shardCollection</span><span class="p">(</span><span class="s2">&quot;fkart_incidents.task_execution&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;hashed&quot;</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// Playbook executions</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">shardCollection</span><span class="p">(</span><span class="s2">&quot;fkart_incidents.playbooks_executions&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;playbook_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// Audit logs - Range for time-based queries</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">shardCollection</span><span class="p">(</span><span class="s2">&quot;fkart_incidents.auditCollection&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;date&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// Active instances</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">shardCollection</span><span class="p">(</span><span class="s2">&quot;fkart_incidents.active_instance&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;integration_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
</code></pre></div>

<h3 id="53-index-strategy">5.3 Index Strategy</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// zona_incidents - Critical indexes</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">zona_incidents</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;zona_z_incident_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;incident_id_idx&quot;</span><span class="w"> </span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">zona_incidents</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_status_idx&quot;</span><span class="w"> </span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">zona_incidents</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;createddate&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_date_idx&quot;</span><span class="w"> </span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">zona_incidents</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;zona_z_instance_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;get_instance_id&quot;</span><span class="w"> </span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">zona_incidents</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;zona_z_severity&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;createddate&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_severity_date_idx&quot;</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// task_execution - Performance indexes</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">task_execution</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;taskid&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;utils_task_index&quot;</span><span class="w"> </span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">task_execution</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_status_idx&quot;</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// playbooks_executions</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">playbooks_executions</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;caseid&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_case_idx&quot;</span><span class="w"> </span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">playbooks_executions</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;createddate&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_status_date_idx&quot;</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// auditCollection</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">auditCollection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;date&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_date_idx&quot;</span><span class="w"> </span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">auditCollection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;object&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;action&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_object_action_idx&quot;</span><span class="w"> </span><span class="p">})</span>
</code></pre></div>

<h3 id="54-chunk-management">5.4 Chunk Management</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Pre-split chunks for known tenants</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">splitAt</span><span class="p">(</span><span class="s2">&quot;fkart_incidents.zona_incidents&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_a&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;zona_z_incident_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">MinKey</span><span class="w"> </span><span class="p">})</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">splitAt</span><span class="p">(</span><span class="s2">&quot;fkart_incidents.zona_incidents&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_b&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;zona_z_incident_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">MinKey</span><span class="w"> </span><span class="p">})</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">splitAt</span><span class="p">(</span><span class="s2">&quot;fkart_incidents.zona_incidents&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_c&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;zona_z_incident_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">MinKey</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// Move chunks for tenant isolation (optional)</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">moveChunk</span><span class="p">(</span><span class="s2">&quot;fkart_incidents.zona_incidents&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="s2">&quot;tenantcode&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_a&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;zona_z_incident_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">MinKey</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="s2">&quot;shard1rs&quot;</span><span class="p">)</span>

<span class="c1">// Set chunk size (default: 128MB, adjust based on workload)</span>
<span class="nx">use</span><span class="w"> </span><span class="nx">config</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;chunksize&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="mf">64</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">},</span><span class="w">  </span><span class="c1">// 64MB for faster balancing</span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="nx">upsert</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="6-high-availability-configuration">6. High Availability Configuration</h2>
<h3 id="61-replica-set-configuration">6.1 Replica Set Configuration</h3>
<p><strong>Primary Server Priority Configuration</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// From securaa_lib/mongoclient/mongoclient.go</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">ChangingPriorityOfPrimary</span><span class="p">(</span><span class="nx">replicaSetConfig</span><span class="w"> </span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">,</span><span class="w"> </span><span class="nx">mongoDbHost</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">replicaSetPort</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">priority</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
</code></pre></div>

<p><strong>Member Configuration Structure</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">MemberConfig</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Name</span><span class="w">       </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;name&quot; bson:&quot;name&quot;`</span>
<span class="w">    </span><span class="nx">ServerIP</span><span class="w">   </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;server_ip&quot; bson:&quot;server_ip&quot;`</span>
<span class="w">    </span><span class="nx">Port</span><span class="w">       </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;port&quot; bson:&quot;port&quot;`</span>
<span class="w">    </span><span class="nx">MemberID</span><span class="w">   </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;member_id&quot; bson:&quot;member_id&quot;`</span>
<span class="w">    </span><span class="nx">MemberType</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;member_type&quot; bson:&quot;member_type&quot;`</span><span class="w"> </span><span class="c1">// &quot;replica&quot; or &quot;arbiter&quot;</span>
<span class="w">    </span><span class="nx">ServerType</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;server_type&quot; bson:&quot;server_type&quot;`</span><span class="w"> </span><span class="c1">// &quot;primary&quot;, &quot;secondary&quot;, &quot;arbiter&quot;</span>
<span class="w">    </span><span class="nx">Status</span><span class="w">     </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;status&quot; bson:&quot;status&quot;`</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="62-failover-configuration">6.2 Failover Configuration</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Replica set configuration with failover settings</span>
<span class="nx">rs</span><span class="p">.</span><span class="nx">reconfig</span><span class="p">({</span>
<span class="w">    </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard1rs&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">members</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;primary:29017&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;secondary:29017&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">priority</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="nx">host</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;arbiter:29017&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">arbiterOnly</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nx">settings</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">heartbeatTimeoutSecs</span><span class="o">:</span><span class="w"> </span><span class="mf">10</span><span class="p">,</span>
<span class="w">        </span><span class="nx">electionTimeoutMillis</span><span class="o">:</span><span class="w"> </span><span class="mf">10000</span><span class="p">,</span>
<span class="w">        </span><span class="nx">catchUpTimeoutMillis</span><span class="o">:</span><span class="w"> </span><span class="mf">60000</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">})</span>
</code></pre></div>

<h3 id="63-connection-pool-settings">6.3 Connection Pool Settings</h3>
<p>From <code>securaa_lib/mongoclient/mongoclient.go</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">GetMongosClient</span><span class="p">(</span><span class="nx">conf</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="nx">options</span><span class="p">.</span><span class="nx">ClientOptions</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">clientOptions</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">Client</span><span class="p">().</span>
<span class="w">        </span><span class="nx">ApplyURI</span><span class="p">(</span><span class="nx">uri</span><span class="p">).</span>
<span class="w">        </span><span class="nx">SetRetryWrites</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span>
<span class="w">        </span><span class="nx">SetMaxPoolSize</span><span class="p">(</span><span class="mi">50</span><span class="p">).</span><span class="w">                          </span><span class="c1">// Maximum connections</span>
<span class="w">        </span><span class="nx">SetMinPoolSize</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="w">                           </span><span class="c1">// Minimum connections</span>
<span class="w">        </span><span class="nx">SetServerSelectionTimeout</span><span class="p">(</span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">).</span><span class="w"> </span><span class="c1">// Time to find mongos</span>
<span class="w">        </span><span class="nx">SetConnectTimeout</span><span class="p">(</span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">).</span><span class="w">         </span><span class="c1">// TCP connection timeout</span>
<span class="w">        </span><span class="nx">SetSocketTimeout</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">).</span><span class="w">           </span><span class="c1">// Long-running ops timeout</span>
<span class="w">        </span><span class="nx">SetHeartbeatInterval</span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span><span class="w">        </span><span class="c1">// Node liveness checks</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">GetMongoClientV2</span><span class="p">(</span><span class="nx">configStruct</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">ConfigStruct</span><span class="p">,</span><span class="w"> </span><span class="nx">replicaSetName</span><span class="p">,</span><span class="w"> </span><span class="nx">mongoHost</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">mongodbPort</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">clientOptions</span><span class="p">.</span><span class="nx">SetMaxPoolSize</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>
<span class="w">    </span><span class="nx">clientOptions</span><span class="p">.</span><span class="nx">SetMaxConnIdleTime</span><span class="p">(</span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="64-readwrite-concerns">6.4 Read/Write Concerns</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Recommended settings for SECURAA</span>
<span class="c1">// Write Concern: majority for critical operations</span>
<span class="nx">writeConcern</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">writeconcern</span><span class="p">.</span><span class="nx">Majority</span><span class="p">()</span>
<span class="nx">writeConcern</span><span class="p">.</span><span class="nx">WTimeout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>

<span class="c1">// Read Concern: majority for consistency</span>
<span class="nx">readConcern</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readconcern</span><span class="p">.</span><span class="nx">Majority</span><span class="p">()</span>

<span class="c1">// Read Preference: primaryPreferred for read-heavy ops</span>
<span class="nx">readPref</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">readpref</span><span class="p">.</span><span class="nx">PrimaryPreferred</span><span class="p">()</span>
</code></pre></div>

<hr />
<h2 id="7-deployment-architecture">7. Deployment Architecture</h2>
<h3 id="71-docker-swarm-deployment">7.1 Docker Swarm Deployment</h3>
<p><strong>Service Stack Definition</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.8&#39;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># Mongos Query Routers</span>
<span class="w">  </span><span class="nt">mongos</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">665853670667.dkr.ecr.us-east-2.amazonaws.com/custom_mongos:mongo_7.0</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.role == manager</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;27017:27017&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">securaa-swarm</span>
<span class="w">    </span><span class="nt">secrets</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongodb_keyfile</span>

<span class="w">  </span><span class="c1"># Config Server Replica Set</span>
<span class="w">  </span><span class="nt">config_server</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">665853670667.dkr.ecr.us-east-2.amazonaws.com/custom_mongodb_shard:mongo_7.0</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">max_replicas_per_node</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;28017:27017&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config_data:/data/configdb</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;mongod&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--configsvr&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--replSet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;cfgrs&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--port&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;27017&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;--keyFile&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;/etc/testkey&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">securaa-swarm</span>

<span class="w">  </span><span class="c1"># Meta Database Replica Set</span>
<span class="w">  </span><span class="nt">meta_db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">665853670667.dkr.ecr.us-east-2.amazonaws.com/custom_mongodb_replica:mongoreplic_7.0</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">max_replicas_per_node</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;27018:27017&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">meta_data:/data/db</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">securaa-swarm</span>

<span class="w">  </span><span class="c1"># Shard Handler Service</span>
<span class="w">  </span><span class="nt">zona_shard_handler</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">665853670667.dkr.ecr.us-east-2.amazonaws.com/zona_shard_handler:dev_6.0</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">placement</span><span class="p">:</span>
<span class="w">        </span><span class="nt">constraints</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.role == manager</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8253:8253&quot;</span>
<span class="w">    </span><span class="nt">networks</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">securaa-swarm</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">config_data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">meta_data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">shard1_data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">shard2_data</span><span class="p">:</span>

<span class="nt">networks</span><span class="p">:</span>
<span class="w">  </span><span class="nt">securaa-swarm</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="nt">secrets</span><span class="p">:</span>
<span class="w">  </span><span class="nt">mongodb_keyfile</span><span class="p">:</span>
<span class="w">    </span><span class="nt">external</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>

<h3 id="72-shard-provisioning-process">7.2 Shard Provisioning Process</h3>
<p><strong>Add New Shard</strong> (from <code>securaa_lib/mongoclient/mongoclient.go</code>):</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">setupNewShard</span><span class="p">(</span><span class="nx">cli</span><span class="w"> </span><span class="o">*</span><span class="nx">client</span><span class="p">.</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="nx">mongoDbHost</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">replicaSet</span><span class="w"> </span><span class="nx">ReplicaSet</span><span class="p">,</span>
<span class="w">    </span><span class="nx">configObject</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">ConfigStruct</span><span class="p">,</span><span class="w"> </span><span class="nx">conf</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// 1. Create shard service with no auth (initial setup)</span>
<span class="w">    </span><span class="nx">serviceCtx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">docker</span><span class="p">.</span><span class="nx">MongoShardServiceContext</span><span class="p">(</span><span class="nx">serviceName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">common</span><span class="p">.</span><span class="nx">MONGO_SHARDING_NOAUTH_DOCKER_TAG</span><span class="p">,</span><span class="w"> </span><span class="nx">shardPort</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="nx">replicaSetName</span><span class="p">,</span><span class="w"> </span><span class="nx">common</span><span class="p">.</span><span class="nx">CLUSTERROLE_SHARD_SERVER</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 2. Initialize as replica set</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">InitializeReplicaSet</span><span class="p">(</span><span class="nx">mongoShardDbClient</span><span class="p">,</span><span class="w"> </span><span class="nx">mongoDbHost</span><span class="p">,</span>
<span class="w">        </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">shardPort</span><span class="p">),</span><span class="w"> </span><span class="nx">replicaSetName</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 3. Create MongoDB user</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">CreateMongoUser</span><span class="p">(</span><span class="nx">mongoShardDbClient</span><span class="p">,</span><span class="w"> </span><span class="nx">conf</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 4. Recreate with auth enabled</span>
<span class="w">    </span><span class="nx">serviceCtx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">docker</span><span class="p">.</span><span class="nx">MongoShardServiceContext</span><span class="p">(</span><span class="nx">serviceName</span><span class="p">,</span>
<span class="w">        </span><span class="nx">common</span><span class="p">.</span><span class="nx">MONGODB_DOCKER_TAG</span><span class="p">,</span><span class="w"> </span><span class="nx">shardPort</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="nx">replicaSetName</span><span class="p">,</span><span class="w"> </span><span class="nx">common</span><span class="p">.</span><span class="nx">CLUSTERROLE_SHARD_SERVER</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 5. Add shard to cluster via mongos</span>
<span class="w">    </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">AddNewShard</span><span class="p">(</span><span class="nx">mongosClient</span><span class="p">,</span><span class="w"> </span><span class="nx">mongoDbHost</span><span class="p">,</span>
<span class="w">        </span><span class="nx">strconv</span><span class="p">.</span><span class="nx">Itoa</span><span class="p">(</span><span class="nx">shardPort</span><span class="p">),</span><span class="w"> </span><span class="nx">replicaSetName</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="73-environment-configuration">7.3 Environment Configuration</h3>
<p><strong>Required Environment Variables</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># MongoDB Connection</span>
<span class="nv">MONGO_DB_HOST</span><span class="o">=</span>primary-host-ip
<span class="nv">MONGO_PORT</span><span class="o">=</span><span class="m">27017</span>
<span class="nv">MONGO_USERNAME</span><span class="o">=</span>root
<span class="nv">MONGO_PASSWORD</span><span class="o">=</span>S3cur@A_b3st
<span class="nv">MONGO_AUTH_DB</span><span class="o">=</span>admin
<span class="nv">MONGO_DATABASE</span><span class="o">=</span>fkart_incidents

<span class="c1"># Sharding Configuration</span>
<span class="nv">CONFIG_SERVER_RS</span><span class="o">=</span>cfgrs
<span class="nv">CONFIG_SERVER_HOSTS</span><span class="o">=</span>config1:28017,config2:28017,config3:28017
<span class="nv">META_DB_RS</span><span class="o">=</span>metars
<span class="nv">META_DB_PORT</span><span class="o">=</span><span class="m">27018</span>

<span class="c1"># Docker Registry</span>
<span class="nv">DOCKER_REGISTRY</span><span class="o">=</span><span class="m">665853670667</span>.dkr.ecr.us-east-2.amazonaws.com
<span class="nv">MONGODB_DOCKER_TAG</span><span class="o">=</span>mongo_7.0
<span class="nv">MONGODB_REPLICA_TAG</span><span class="o">=</span>mongoreplic_7.0
</code></pre></div>

<hr />
<h2 id="8-data-flow-architecture">8. Data Flow Architecture</h2>
<h3 id="81-write-path">8.1 Write Path</h3>
<div class="mermaid">
graph LR
    SIEM[SIEM/<br/>Integration]
    ZS[zona_siem<br/>Go Service]
    M[Mongos<br/>Query Router]
    SP[Shard<br/>Primary]
    SS[Shard<br/>Secondary]

    SIEM --> ZS
    ZS --> M
    M --> SP
    SP --> SS
</div>

<h3 id="82-read-path">8.2 Read Path</h3>
<div class="mermaid">
graph TB
    UI[UI/API<br/>Request]
    M[Mongos<br/>Query Router]
    SG{If scatter-<br/>gather query}
    SD[Shard<br/>based on<br/>shard key]
    S1[Shard 1]
    S2[Shard 2]
    SN[Shard N]

    UI --> M
    M --> SG
    SG -->|Single Shard| SD
    SG -->|Multiple Shards| S1
    SG -->|Multiple Shards| S2
    SG -->|Multiple Shards| SN
</div>

<h3 id="83-case-ingestion-flow">8.3 Case Ingestion Flow</h3>
<div class="mermaid">
graph LR
    subgraph CaseIngestion["Case Ingestion Pipeline"]
        SIEM[SIEM<br/>QRadar<br/>Splunk<br/>Sentinel]
        KAFKA[Kafka<br/>Topic: case_queue]
        CONSUMER[zona_case_consumer<br/>Batch]
        INCIDENTS[zona_incidents<br/>Collection<br/>Sharded]

        SIEM --> KAFKA
        KAFKA --> CONSUMER
        CONSUMER --> INCIDENTS
    end

    CONTROLLERS[Controllers zona_batch/zona_case_consumer/controllers/:<br/>• qradarController.go<br/>• splunkController.go<br/>• azuresentinelController.go<br/>• wazuhController.go<br/>• crowdstrikeController.go<br/>• elasticController.go<br/>• sentinelOneController.go<br/>• securonixController.go]

    CONSUMER -.-> CONTROLLERS
</div>

<hr />
<h2 id="9-scaling-strategies">9. Scaling Strategies</h2>
<h3 id="91-horizontal-scaling">9.1 Horizontal Scaling</h3>
<p><strong>Add Shard via API</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Using zona_shard_handler service</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://zona_shard_handler:8253/manageShardService/<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-H<span class="w"> </span><span class="s2">&quot;Content-Type: application/json&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-d<span class="w"> </span><span class="s1">&#39;{</span>
<span class="s1">    &quot;action&quot;: &quot;start&quot;,</span>
<span class="s1">    &quot;replicaSet&quot;: &quot;shard3rs&quot;,</span>
<span class="s1">    &quot;memberConfig&quot;: {</span>
<span class="s1">      &quot;name&quot;: &quot;mongo_shard3_repl&quot;,</span>
<span class="s1">      &quot;port&quot;: 29019,</span>
<span class="s1">      &quot;memberType&quot;: &quot;replica&quot;</span>
<span class="s1">    }</span>
<span class="s1">  }&#39;</span>
</code></pre></div>

<p><strong>Scaling Triggers</strong>:
| Metric | Threshold | Action |
|--------|-----------|--------|
| Chunk Count per Shard | &gt; 1000 | Add new shard |
| Storage Utilization | &gt; 70% | Add new shard |
| Query Latency P95 | &gt; 500ms | Scale mongos, add indexes |
| Connection Count | &gt; 80% pool | Increase pool size |</p>
<h3 id="92-vertical-scaling">9.2 Vertical Scaling</h3>
<p><strong>Resource Recommendations</strong>:
| Component | CPU | RAM | Storage | IOPS |
|-----------|-----|-----|---------|------|
| Mongos | 4 cores | 8GB | 50GB SSD | 1000 |
| Config Server | 2 cores | 4GB | 100GB SSD | 500 |
| Shard Primary | 8 cores | 32GB | 500GB SSD | 3000 |
| Shard Secondary | 8 cores | 32GB | 500GB SSD | 2000 |
| Arbiter | 1 core | 1GB | 10GB | 100 |</p>
<h3 id="93-auto-scaling-configuration">9.3 Auto-Scaling Configuration</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Docker Swarm auto-scaling (via external orchestrator)</span>
<span class="nt">scaling</span><span class="p">:</span>
<span class="w">  </span><span class="nt">mongos</span><span class="p">:</span>
<span class="w">    </span><span class="nt">min_replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">max_replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">    </span><span class="nt">target_cpu_utilization</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">70%</span>

<span class="w">  </span><span class="nt">zona_siem</span><span class="p">:</span>
<span class="w">    </span><span class="nt">min_replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">max_replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
<span class="w">    </span><span class="nt">target_cpu_utilization</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">60%</span>

<span class="w">  </span><span class="nt">zona_playbook</span><span class="p">:</span>
<span class="w">    </span><span class="nt">min_replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">    </span><span class="nt">max_replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
<span class="w">    </span><span class="nt">target_cpu_utilization</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">65%</span>
</code></pre></div>

<hr />
<h2 id="10-operational-procedures">10. Operational Procedures</h2>
<h3 id="101-adding-a-new-shard">10.1 Adding a New Shard</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Step 1: Deploy shard replica set containers</span>
docker<span class="w"> </span>service<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>mongo_shard3_repl<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--replicas<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--network<span class="w"> </span>securaa-swarm<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--publish<span class="w"> </span><span class="m">29019</span>:27017<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--mount<span class="w"> </span><span class="nv">type</span><span class="o">=</span>volume,source<span class="o">=</span>shard3_data,target<span class="o">=</span>/data/db<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="m">665853670667</span>.dkr.ecr.us-east-2.amazonaws.com/custom_mongodb_shard:mongo_7.0

<span class="c1"># Step 2: Initialize replica set</span>
mongosh<span class="w"> </span>mongodb://shard3-host:29019<span class="w"> </span>--eval<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">rs.initiate({</span>
<span class="s1">  _id: &quot;shard3rs&quot;,</span>
<span class="s1">  members: [</span>
<span class="s1">    { _id: 0, host: &quot;shard3-primary:29019&quot;, priority: 2 },</span>
<span class="s1">    { _id: 1, host: &quot;shard3-secondary:29019&quot;, priority: 1 },</span>
<span class="s1">    { _id: 2, host: &quot;shard3-arbiter:29019&quot;, arbiterOnly: true }</span>
<span class="s1">  ]</span>
<span class="s1">})&#39;</span>

<span class="c1"># Step 3: Add shard to cluster</span>
mongosh<span class="w"> </span>mongodb://mongos:27017/admin<span class="w"> </span>--eval<span class="w"> </span><span class="s1">&#39;</span>
<span class="s1">sh.addShard(&quot;shard3rs/shard3-primary:29019,shard3-secondary:29019&quot;)&#39;</span>

<span class="c1"># Step 4: Verify</span>
sh.status<span class="o">()</span>
</code></pre></div>

<h3 id="102-removing-a-shard">10.2 Removing a Shard</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Step 1: Start draining</span>
<span class="nx">use</span><span class="w"> </span><span class="nx">admin</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">adminCommand</span><span class="p">({</span><span class="w"> </span><span class="nx">removeShard</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard2rs&quot;</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// Step 2: Monitor progress (repeat until complete)</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">adminCommand</span><span class="p">({</span><span class="w"> </span><span class="nx">removeShard</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard2rs&quot;</span><span class="w"> </span><span class="p">})</span>
<span class="c1">// Returns: { state: &quot;ongoing&quot;, remaining: { chunks: N, dbs: N } }</span>

<span class="c1">// Step 3: Move primary databases off shard</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">adminCommand</span><span class="p">({</span><span class="w"> </span><span class="nx">movePrimary</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant_db&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">to</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;shard1rs&quot;</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// Step 4: Wait for completion</span>
<span class="c1">// Returns: { state: &quot;completed&quot; }</span>

<span class="c1">// Step 5: Remove Docker service</span>
<span class="nx">docker</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="nx">rm</span><span class="w"> </span><span class="nx">mongo_shard2_repl</span>
</code></pre></div>

<h3 id="103-balancer-management">10.3 Balancer Management</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Check balancer status</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">getBalancerState</span><span class="p">()</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">isBalancerRunning</span><span class="p">()</span>

<span class="c1">// Stop balancer (for maintenance)</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">stopBalancer</span><span class="p">()</span>

<span class="c1">// Start balancer</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">startBalancer</span><span class="p">()</span>

<span class="c1">// Configure balancing window (avoid peak hours)</span>
<span class="nx">use</span><span class="w"> </span><span class="nx">config</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">updateOne</span><span class="p">(</span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;balancer&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="nx">$set</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="nx">activeWindow</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">start</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;02:00&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">stop</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;06:00&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">       </span><span class="nx">_secondaryThrottle</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">   </span><span class="p">}},</span>
<span class="w">   </span><span class="p">{</span><span class="w"> </span><span class="nx">upsert</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="104-backup-procedures">10.4 Backup Procedures</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Mongodump from mongos (consistent backup)</span>
mongodump<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--uri<span class="o">=</span><span class="s2">&quot;mongodb://root:password@mongos:27017&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="o">=</span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--oplog<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--out<span class="o">=</span>/backup/<span class="k">$(</span>date<span class="w"> </span>+%Y%m%d<span class="k">)</span>

<span class="c1"># Per-shard backup (for large clusters)</span>
<span class="k">for</span><span class="w"> </span>shard<span class="w"> </span><span class="k">in</span><span class="w"> </span>shard1rs<span class="w"> </span>shard2rs<span class="w"> </span>shard3rs<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">  </span>mongodump<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--uri<span class="o">=</span><span class="s2">&quot;mongodb://root:password@</span><span class="si">${</span><span class="nv">shard</span><span class="si">}</span><span class="s2">-primary:29017&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--authenticationDatabase<span class="o">=</span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--oplog<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>--out<span class="o">=</span>/backup/<span class="k">$(</span>date<span class="w"> </span>+%Y%m%d<span class="k">)</span>/<span class="si">${</span><span class="nv">shard</span><span class="si">}</span>
<span class="k">done</span>

<span class="c1"># Config server backup</span>
mongodump<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--uri<span class="o">=</span><span class="s2">&quot;mongodb://root:password@config1:28017&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--authenticationDatabase<span class="o">=</span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--out<span class="o">=</span>/backup/<span class="k">$(</span>date<span class="w"> </span>+%Y%m%d<span class="k">)</span>/config
</code></pre></div>

<hr />
<h2 id="11-monitoring-and-alerting">11. Monitoring and Alerting</h2>
<h3 id="111-key-metrics">11.1 Key Metrics</h3>
<p><strong>Cluster Health</strong>:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Shard status</span>
<span class="nx">sh</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span>

<span class="c1">// Replica set status</span>
<span class="nx">rs</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span>

<span class="c1">// Current operations</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">currentOp</span><span class="p">()</span>

<span class="c1">// Server statistics</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">serverStatus</span><span class="p">()</span>
</code></pre></div>

<p><strong>Performance Metrics</strong>:
| Metric | Source | Alert Threshold |
|--------|--------|-----------------|
| <code>opcounters.query</code> | serverStatus | &gt; 10000/s |
| <code>opcounters.insert</code> | serverStatus | &gt; 5000/s |
| <code>connections.current</code> | serverStatus | &gt; 80% of available |
| <code>repl.lag</code> | rs.status() | &gt; 10 seconds |
| <code>chunks.imbalance</code> | sh.status() | &gt; 20% difference |
| <code>storage.dataSize</code> | collStats | &gt; 80% allocated |</p>
<h3 id="112-monitoring-integration">11.2 Monitoring Integration</h3>
<p><strong>InfluxDB/Telegraf Configuration</strong> (from <code>zona_services/custom_telegraf/</code>):</p>
<div class="highlight"><pre><span></span><code><span class="k">[[inputs.mongodb]]</span>
<span class="w">  </span><span class="n">servers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;mongodb://root:password@mongos:27017/admin&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="n">gather_perdb_stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="n">gather_col_stats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="n">col_stats_dbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;fkart_incidents&quot;</span><span class="p">]</span>

<span class="k">[[outputs.influxdb_v2]]</span>
<span class="w">  </span><span class="n">urls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;http://influxdb:8086&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;${INFLUXDB_TOKEN}&quot;</span>
<span class="w">  </span><span class="n">organization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;securaa&quot;</span>
<span class="w">  </span><span class="n">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;stats&quot;</span>
</code></pre></div>

<h3 id="113-alerting-rules">11.3 Alerting Rules</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># Prometheus alerting rules</span>
<span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongodb_sharding</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MongoDBReplicaSetLag</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongodb_rs_members_replicationLag &gt; 10</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;MongoDB</span><span class="nv"> </span><span class="s">replica</span><span class="nv"> </span><span class="s">lag</span><span class="nv"> </span><span class="s">detected&quot;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MongoDBShardImbalance</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">abs(mongodb_shard_chunks - avg(mongodb_shard_chunks)) &gt; 100</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;MongoDB</span><span class="nv"> </span><span class="s">shard</span><span class="nv"> </span><span class="s">chunk</span><span class="nv"> </span><span class="s">imbalance&quot;</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MongoDBHighConnections</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mongodb_connections_current / mongodb_connections_available &gt; 0.8</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;MongoDB</span><span class="nv"> </span><span class="s">connection</span><span class="nv"> </span><span class="s">pool</span><span class="nv"> </span><span class="s">near</span><span class="nv"> </span><span class="s">exhaustion&quot;</span>
</code></pre></div>

<hr />
<h2 id="12-disaster-recovery">12. Disaster Recovery</h2>
<h3 id="121-recovery-scenarios">12.1 Recovery Scenarios</h3>
<p><strong>Scenario 1: Single Shard Primary Failure</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Automatic failover via replica set election</span>
<span class="c1"># Monitor: rs.status() on affected shard</span>
<span class="c1"># Recovery time: 10-30 seconds (election timeout)</span>
</code></pre></div>

<p><strong>Scenario 2: Entire Shard Failure</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># 1. Stop queries to affected shard</span>
sh.disableBalancing<span class="o">(</span><span class="s2">&quot;fkart_incidents.zona_incidents&quot;</span><span class="o">)</span>

<span class="c1"># 2. Restore from backup to new nodes</span>
mongorestore<span class="w"> </span>--uri<span class="o">=</span><span class="s2">&quot;mongodb://new-shard-primary:29017&quot;</span><span class="w"> </span>/backup/shardXrs

<span class="c1"># 3. Reconfigure replica set</span>
rs.reconfig<span class="o">({</span><span class="w"> </span>...<span class="w"> </span>new<span class="w"> </span>members<span class="w"> </span>...<span class="w"> </span><span class="o">})</span>

<span class="c1"># 4. Re-add to cluster</span>
sh.addShard<span class="o">(</span><span class="s2">&quot;shardXrs/new-primary:29017&quot;</span><span class="o">)</span>

<span class="c1"># 5. Re-enable balancing</span>
sh.enableBalancing<span class="o">(</span><span class="s2">&quot;fkart_incidents.zona_incidents&quot;</span><span class="o">)</span>
</code></pre></div>

<p><strong>Scenario 3: Config Server Failure</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1"># Config servers use replica set - automatic failover</span>
<span class="c1"># If majority lost:</span>
<span class="c1"># 1. Restore config database from backup</span>
<span class="c1"># 2. Reconfigure replica set</span>
<span class="c1"># WARNING: Cluster operations blocked until config servers available</span>
</code></pre></div>

<h3 id="122-backuprestore-strategy">12.2 Backup/Restore Strategy</h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Backup Frequency</th>
<th>Retention</th>
<th>Method</th>
</tr>
</thead>
<tbody>
<tr>
<td>Config Servers</td>
<td>Every 6 hours</td>
<td>7 days</td>
<td>mongodump with oplog</td>
</tr>
<tr>
<td>Shards</td>
<td>Daily full, hourly incremental</td>
<td>30 days</td>
<td>Filesystem snapshots</td>
</tr>
<tr>
<td>Meta DB</td>
<td>Every 6 hours</td>
<td>7 days</td>
<td>mongodump</td>
</tr>
</tbody>
</table>
<h3 id="123-rporto-targets">12.3 RPO/RTO Targets</h3>
<table>
<thead>
<tr>
<th>Scenario</th>
<th>RPO</th>
<th>RTO</th>
</tr>
</thead>
<tbody>
<tr>
<td>Single node failure</td>
<td>0 (replication)</td>
<td>&lt; 30 seconds</td>
</tr>
<tr>
<td>Shard failure</td>
<td>&lt; 1 hour</td>
<td>&lt; 4 hours</td>
</tr>
<tr>
<td>Complete cluster failure</td>
<td>&lt; 24 hours</td>
<td>&lt; 8 hours</td>
</tr>
<tr>
<td>Region failure (DR)</td>
<td>&lt; 24 hours</td>
<td>&lt; 24 hours</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="appendix-a-collection-reference">Appendix A: Collection Reference</h2>
<h3 id="complete-collection-list-from-securaa_libconfigservergo">Complete Collection List (from <code>securaa_lib/config/server.go</code>)</h3>
<div class="highlight"><pre><span></span><code>Core Collections:
├── tenants                    # Tenant management (MSSP)
├── users                      # User accounts
├── roles                      # Permission roles
├── user_session               # Active sessions
├── user_groups                # User grouping

Case Management:
├── zona_incidents             # Security incidents/cases (HIGH VOLUME)
├── incident_categories        # Case categorization
├── incident_status            # Status definitions
├── incident_severities        # Severity levels
├── investigation              # Investigation records
├── casegroup                  # Case grouping

Automation:
├── playbooks                  # Playbook definitions
├── playbooks_executions       # Execution history (HIGH VOLUME)
├── tasks                      # Task definitions
├── task_execution             # Task execution logs (HIGH VOLUME)
├── pre_process_rules          # Pre-processing rules
├── approvals                  # Approval workflows

Integration:
├── integration                # Integration catalog
├── active_instance            # Active integration instances
├── feeds                      # Threat intelligence feeds

Audit &amp; Logging:
├── auditCollection            # Audit trail (HIGH VOLUME)
├── zona_loginfo               # System logs

Configuration:
├── system                     # System settings
├── securaa_license            # License information
├── current_release            # Version info
├── sla                        # SLA definitions
├── shifts                     # Shift management

Reports &amp; Dashboards:
├── reports                    # Report definitions
├── report_collection          # Report data
├── custom_dashboard           # Dashboard configs
├── zona_widgets               # Widget definitions
</code></pre></div>

<hr />
<h2 id="appendix-b-docker-image-tags">Appendix B: Docker Image Tags</h2>
<table>
<thead>
<tr>
<th>Image</th>
<th>Tag</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>custom_mongodb_shard</code></td>
<td><code>mongo_7.0</code></td>
<td>Shard server with auth</td>
</tr>
<tr>
<td><code>custom_mongodb_shard</code></td>
<td><code>mongo_noauth_7.0</code></td>
<td>Shard server initial setup</td>
</tr>
<tr>
<td><code>custom_mongos</code></td>
<td><code>mongo_7.0</code></td>
<td>Query router</td>
</tr>
<tr>
<td><code>custom_mongodb_replica</code></td>
<td><code>mongoreplic_7.0</code></td>
<td>Standard replica set</td>
</tr>
<tr>
<td><code>custom_mongodb_replica_incremental</code></td>
<td><code>release_repl_incremental</code></td>
<td>Incremental backup support</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="appendix-c-port-reference">Appendix C: Port Reference</h2>
<table>
<thead>
<tr>
<th>Port</th>
<th>Service</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>27017</td>
<td>Mongos</td>
<td>Application connection</td>
</tr>
<tr>
<td>27018</td>
<td>Meta DB</td>
<td>Sharding metadata</td>
</tr>
<tr>
<td>28017</td>
<td>Config Server</td>
<td>Cluster configuration</td>
</tr>
<tr>
<td>29017</td>
<td>Shard 1</td>
<td>First data shard</td>
</tr>
<tr>
<td>29018</td>
<td>Shard 2</td>
<td>Second data shard</td>
</tr>
<tr>
<td>29019-29066</td>
<td>Shards 3-50</td>
<td>Additional shards</td>
</tr>
<tr>
<td>8253</td>
<td>Shard Handler</td>
<td>Shard management API</td>
</tr>
<tr>
<td>8251</td>
<td>Arbiter Handler</td>
<td>Arbiter management API</td>
</tr>
<tr>
<td>8250</td>
<td>Health Check</td>
<td>Primary server health</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="appendix-d-troubleshooting">Appendix D: Troubleshooting</h2>
<h3 id="common-issues">Common Issues</h3>
<p><strong>Issue: Shard not accepting writes</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Check if shard is primary</span>
<span class="nx">rs</span><span class="p">.</span><span class="nx">isMaster</span><span class="p">()</span>

<span class="c1">// Check replication status</span>
<span class="nx">rs</span><span class="p">.</span><span class="nx">status</span><span class="p">()</span>

<span class="c1">// Force reconfiguration if needed</span>
<span class="nx">rs</span><span class="p">.</span><span class="nx">reconfig</span><span class="p">(</span><span class="nx">rs</span><span class="p">.</span><span class="nx">conf</span><span class="p">(),</span><span class="w"> </span><span class="p">{</span><span class="nx">force</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">})</span>
</code></pre></div>

<p><strong>Issue: Slow queries</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Enable profiler</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">setProfilingLevel</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">slowms</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// Analyze slow queries</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">system</span><span class="p">.</span><span class="nx">profile</span><span class="p">.</span><span class="nx">find</span><span class="p">().</span><span class="nx">sort</span><span class="p">({</span><span class="w"> </span><span class="nx">ts</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="w"> </span><span class="p">}).</span><span class="nx">limit</span><span class="p">(</span><span class="mf">10</span><span class="p">)</span>

<span class="c1">// Check explain plan</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">zona_incidents</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">tenantcode</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;x&quot;</span><span class="w"> </span><span class="p">}).</span><span class="nx">explain</span><span class="p">(</span><span class="s2">&quot;executionStats&quot;</span><span class="p">)</span>
</code></pre></div>

<p><strong>Issue: Chunk migration stuck</strong></p>
<div class="highlight"><pre><span></span><code><span class="c1">// Check migration status</span>
<span class="nx">use</span><span class="w"> </span><span class="nx">config</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">locks</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;balancer&quot;</span><span class="w"> </span><span class="p">})</span>

<span class="c1">// Abort stuck migration</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">adminCommand</span><span class="p">({</span><span class="w"> </span><span class="nx">balancerStop</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">locks</span><span class="p">.</span><span class="nx">remove</span><span class="p">({</span><span class="w"> </span><span class="nx">_id</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;balancer&quot;</span><span class="w"> </span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">adminCommand</span><span class="p">({</span><span class="w"> </span><span class="nx">balancerStart</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">})</span>
</code></pre></div>

<hr />
<h2 id="document-history">Document History</h2>
<table>
<thead>
<tr>
<th>Version</th>
<th>Date</th>
<th>Author</th>
<th>Changes</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.0</td>
<td>December 2024</td>
<td>System Architect</td>
<td>Initial comprehensive architecture</td>
</tr>
</tbody>
</table>
<hr />
<p><em>This document is auto-generated based on codebase analysis and should be reviewed by the infrastructure team before implementation.</em></p>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Securaa Security Platform. All rights reserved.</p>
        <p>Documentation generated on December 18, 2025</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#4f46e5',
                primaryTextColor: '#1f2937',
                primaryBorderColor: '#818cf8',
                lineColor: '#6b7280',
                secondaryColor: '#f3f4f6',
                tertiaryColor: '#e5e7eb',
                background: '#ffffff',
                mainBkg: '#f9fafb',
                secondBkg: '#f3f4f6',
                border1: '#e5e7eb',
                border2: '#d1d5db',
                fontFamily: 'Inter, sans-serif',
                fontSize: '14px',
                nodeBorder: '#4f46e5',
                clusterBkg: '#f0f4f8',
                clusterBorder: '#818cf8',
                edgeLabelBackground: '#ffffff'
            },
            flowchart: {
                htmlLabels: true,
                useMaxWidth: true,
                curve: 'basis',
                padding: 15,
                nodeSpacing: 50,
                rankSpacing: 50
            },
            sequence: {
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: true,
                useMaxWidth: true
            },
            er: {
                useMaxWidth: true,
                entityPadding: 15,
                fontSize: 12
            },
            class: {
                useMaxWidth: true,
                padding: 10
            },
            gantt: {
                useMaxWidth: true,
                barHeight: 20,
                barGap: 4,
                topPadding: 50,
                leftPadding: 75
            },
            pie: {
                useMaxWidth: true,
                textPosition: 0.5
            },
            mindmap: {
                useMaxWidth: true,
                padding: 10
            },
            securityLevel: 'loose',
            logLevel: 'error'
        });

        // Re-render mermaid diagrams after page load for better sizing
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.querySelectorAll('.mermaid').forEach(function(el) {
                    if (el.getAttribute('data-processed') !== 'true') {
                        mermaid.init(undefined, el);
                    }
                });
            }, 100);
        });
    </script>
</body>
</html>
