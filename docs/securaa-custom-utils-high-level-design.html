<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Securaa Platform Documentation - Securaa Custom Utils - High Level Design">
    <title>Securaa Custom Utils - High Level Design - Securaa Documentation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>

:root {
    --primary-color: #4f46e5;
    --primary-dark: #3730a3;
    --primary-light: #818cf8;
    --secondary-color: #06b6d4;
    --accent-color: #f59e0b;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --text-muted: #9ca3af;
    --bg-primary: #ffffff;
    --bg-secondary: #f9fafb;
    --bg-tertiary: #f3f4f6;
    --border-color: #e5e7eb;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    scroll-behavior: smooth;
    font-size: 16px;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.7;
    color: var(--text-primary);
    background-color: var(--bg-secondary);
}

/* Header */
.main-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 1rem 2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: var(--shadow-lg);
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-logo {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.025em;
}

.header-logo span {
    color: var(--secondary-color);
}

/* Navigation */
.documentation-nav {
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border-color);
    padding: 0.75rem 2rem;
    position: sticky;
    top: 60px;
    z-index: 999;
    box-shadow: var(--shadow-sm);
}

.nav-links {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    justify-content: center;
}

.nav-links a {
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
}

.nav-links a:hover {
    color: var(--primary-color);
    background: var(--bg-tertiary);
}

/* Main Content */
.main-content {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 2.5rem;
    background: var(--bg-primary);
    border-radius: 1rem;
    box-shadow: var(--shadow-md);
}

/* Typography */
h1, h2, h3, h4, h5, h6 {
    color: var(--text-primary);
    font-weight: 700;
    line-height: 1.3;
    margin-top: 2rem;
    margin-bottom: 1rem;
}

h1 {
    font-size: 2.5rem;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    padding-bottom: 0.75rem;
    border-bottom: 3px solid var(--primary-color);
    margin-top: 0;
}

h2 {
    font-size: 1.875rem;
    color: var(--primary-dark);
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0.5rem;
}

h3 {
    font-size: 1.5rem;
    color: var(--text-primary);
}

h4 {
    font-size: 1.25rem;
    color: var(--text-secondary);
}

h5 {
    font-size: 1.125rem;
}

h6 {
    font-size: 1rem;
    color: var(--text-muted);
}

p {
    margin-bottom: 1rem;
    color: var(--text-primary);
}

/* Links */
a {
    color: var(--primary-color);
    text-decoration: none;
    transition: color 0.2s ease;
}

a:hover {
    color: var(--primary-dark);
    text-decoration: underline;
}

/* Lists */
ul, ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
}

li {
    margin-bottom: 0.5rem;
}

li > ul, li > ol {
    margin-top: 0.5rem;
    margin-bottom: 0;
}

/* Code Blocks */
pre {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 1.25rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.5rem 0;
    font-size: 0.875rem;
    line-height: 1.6;
    box-shadow: var(--shadow-md);
}

code {
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 0.875em;
}

:not(pre) > code {
    background: var(--bg-tertiary);
    color: var(--primary-dark);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}

/* Tables */
table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.9rem;
    box-shadow: var(--shadow-sm);
    border-radius: 0.5rem;
    overflow: hidden;
}

thead {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
}

th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
}

td {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

tr:nth-child(even) {
    background: var(--bg-secondary);
}

tr:hover {
    background: var(--bg-tertiary);
}

/* Blockquotes */
blockquote {
    border-left: 4px solid var(--primary-color);
    padding: 1rem 1.5rem;
    margin: 1.5rem 0;
    background: var(--bg-secondary);
    border-radius: 0 0.5rem 0.5rem 0;
    font-style: italic;
    color: var(--text-secondary);
}

blockquote p:last-child {
    margin-bottom: 0;
}

/* Mermaid Diagrams - Enhanced Styling */
.mermaid {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 2rem 0;
    padding: 1.5rem;
    background: linear-gradient(135deg, #fafbfc 0%, #f0f4f8 100%);
    border-radius: 0.75rem;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    overflow-x: auto;
    overflow-y: visible;
    min-height: 200px;
}

.mermaid svg {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
}

/* Ensure diagrams scale properly */
.mermaid[data-processed="true"] {
    min-height: auto;
}

/* Diagram container for better control */
.diagram-container {
    width: 100%;
    overflow-x: auto;
    padding: 1rem 0;
}

/* HR Styling */
hr {
    border: none;
    border-top: 2px solid var(--border-color);
    margin: 2.5rem 0;
}

/* Table of Contents */
.toc {
    background: var(--bg-secondary);
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border-color);
}

.toc-title {
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 1rem;
    font-size: 1.125rem;
}

.toc ul {
    list-style: none;
    padding-left: 0;
}

.toc li {
    margin-bottom: 0.5rem;
}

.toc a {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.toc a:hover {
    color: var(--primary-color);
}

/* Document Info Box */
.doc-info {
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    font-size: 0.875rem;
}

.doc-info strong {
    color: var(--primary-color);
}

/* Footer */
.footer {
    text-align: center;
    padding: 2rem;
    background: var(--bg-tertiary);
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-top: 2rem;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
}

::-webkit-scrollbar-thumb {
    background: var(--text-muted);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}

/* Print Styles */
@media print {
    .main-header, .documentation-nav, .footer {
        display: none !important;
    }

    .main-content {
        max-width: none;
        margin: 0;
        padding: 20px;
        box-shadow: none;
        border-radius: 0;
    }

    body {
        background: white;
        font-size: 11pt;
    }

    h1 {
        font-size: 24pt;
        -webkit-text-fill-color: var(--primary-dark);
        page-break-after: avoid;
    }

    h2, h3, h4 {
        page-break-after: avoid;
    }

    pre {
        background: #f5f5f5 !important;
        color: #333 !important;
        border: 1px solid #ddd;
        page-break-inside: avoid;
        font-size: 9pt;
    }

    table {
        page-break-inside: avoid;
    }

    .mermaid {
        page-break-inside: avoid;
        background: white !important;
        border: 1px solid #ddd;
        max-width: 100% !important;
    }

    .mermaid svg {
        max-width: 100% !important;
        max-height: 700px !important;
    }

    a {
        color: var(--primary-dark) !important;
        text-decoration: none !important;
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .main-content {
        margin: 1rem;
        padding: 1.5rem;
        border-radius: 0.5rem;
    }

    h1 {
        font-size: 1.75rem;
    }

    h2 {
        font-size: 1.5rem;
    }

    .nav-links {
        gap: 0.75rem;
    }

    .nav-links a {
        font-size: 0.75rem;
        padding: 0.375rem 0.5rem;
    }

    pre {
        font-size: 0.8rem;
        padding: 1rem;
    }

    table {
        font-size: 0.8rem;
    }

    th, td {
        padding: 0.5rem;
    }
}

/* Animation for smooth transitions */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.main-content {
    animation: fadeIn 0.3s ease-out;
}

/* Index-specific styles */
.hero {
    text-align: center;
    padding: 3rem 0;
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    border-radius: 1rem;
    margin-bottom: 3rem;
}

.hero h1 {
    font-size: 3rem;
    margin-bottom: 1rem;
    border: none;
    padding: 0;
}

.hero p {
    font-size: 1.25rem;
    color: var(--text-secondary);
    max-width: 600px;
    margin: 0 auto;
}

.doc-sections {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.doc-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
}

.doc-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-light);
}

.doc-card h3 {
    color: var(--primary-color);
    font-size: 1.25rem;
    margin-top: 0;
    margin-bottom: 0.75rem;
}

.doc-card p {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.doc-card .links {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.doc-card .links a {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
    background: var(--bg-secondary);
    border-radius: 0.375rem;
    transition: all 0.2s ease;
}

.doc-card .links a:hover {
    background: var(--primary-color);
    color: white;
    text-decoration: none;
}

.section-title {
    font-size: 1.75rem;
    color: var(--primary-dark);
    margin-top: 3rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-color);
}

    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <div class="header-logo">Securaa<span>Docs</span></div>
            <div class="header-meta">
                <span>Generated: December 18, 2025</span>
            </div>
        </div>
    </header>

    <nav class="documentation-nav">
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="securaa-platform-high-level-design.html">Platform</a>
            <a href="securaa-playbook-high-level-design.html">Playbook</a>
            <a href="securaa-siem-high-level-design.html">SIEM</a>
            <a href="securaa-user-high-level-design.html">User Service</a>
            <a href="securaa-custom-services-high-level-design.html">Custom Services</a>
            <a href="sia-service-high-level-design.html">SIA Service</a>
            <a href="securaa-ris-high-level-design.html">RIS</a>
        </div>
    </nav>

    <main class="main-content">
        <h1 id="zona-custom-utils-service-high-level-design-hld">Zona Custom Utils Service - High-Level Design (HLD)</h1>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#executive-summary">Executive Summary</a></li>
<li><a href="#system-overview">System Overview</a></li>
<li><a href="#business-requirements">Business Requirements</a></li>
<li><a href="#solution-architecture">Solution Architecture</a></li>
<li><a href="#component-architecture">Component Architecture</a></li>
<li><a href="#data-architecture">Data Architecture</a></li>
<li><a href="#security-architecture">Security Architecture</a></li>
<li><a href="#performance-architecture">Performance Architecture</a></li>
<li><a href="#deployment-architecture">Deployment Architecture</a></li>
<li><a href="#integration-architecture">Integration Architecture</a></li>
<li><a href="#business-process-flows">Business Process Flows</a></li>
<li><a href="#non-functional-requirements">Non-Functional Requirements</a></li>
</ol>
<h2 id="executive-summary">Executive Summary</h2>
<p>The Zona Custom Utils Service is a microservice designed to enable users to create, manage, and execute custom utility functions in a secure, multi-tenant environment. The service supports Python-based transformers and scripts, providing isolated execution environments through containerization while maintaining comprehensive audit trails and performance optimization.</p>
<h3 id="key-business-value">Key Business Value</h3>
<ul>
<li><strong>Extensibility</strong>: Allows users to create custom data processing utilities</li>
<li><strong>Security</strong>: Provides secure code validation and isolated execution</li>
<li><strong>Multi-tenancy</strong>: Supports multiple tenants with data isolation</li>
<li><strong>Scalability</strong>: Designed for high-volume, concurrent operations</li>
<li><strong>Compliance</strong>: Comprehensive audit logging for regulatory requirements</li>
</ul>
<h3 id="solution-approach">Solution Approach</h3>
<ul>
<li><strong>Microservice Architecture</strong>: Self-contained service with clear boundaries</li>
<li><strong>Container-based Execution</strong>: Docker containers for secure Python code execution</li>
<li><strong>Multi-tier Caching</strong>: Redis and in-memory caching for performance</li>
<li><strong>Multi-tenant Data Model</strong>: Isolated data storage per tenant</li>
<li><strong>Event-driven Processing</strong>: Asynchronous operations for non-critical tasks</li>
</ul>
<h2 id="system-overview">System Overview</h2>
<div class="mermaid">
graph TB
    subgraph "External Interfaces"
        WEB[Web UI]
        API[REST API Clients]
    end

    subgraph "API Gateway Layer"
        LB[Load Balancer]
        SSL[SSL Termination]
        AUTH[Authentication Gateway]
    end

    subgraph "Zona Custom Utils Service"
        APP[Application Layer]
        BL[Business Logic Layer]
        DATA[Data Access Layer]
        INFRA[Infrastructure Layer]
    end

    subgraph "Data Storage"
        MONGO[(MongoDB Cluster)]
        REDIS[(Redis Cluster)]
        FS[File System Storage]
    end

    subgraph "External Services"
        DOCKER[Docker Engine]
        LOGGING[Logging Service]
        MONITORING[Monitoring Service]
    end

    WEB --> LB
    API --> LB

    LB --> SSL
    SSL --> AUTH
    AUTH --> APP

    APP --> BL
    BL --> DATA
    DATA --> INFRA

    DATA --> MONGO
    DATA --> REDIS
    INFRA --> FS
    INFRA --> DOCKER

    APP --> LOGGING
    APP --> MONITORING
</div>

<h3 id="system-context">System Context</h3>
<p>The Zona Custom Utils Service operates within a larger ecosystem of microservices, providing custom utility management capabilities. It integrates with:</p>
<ul>
<li><strong>Authentication Services</strong>: For user authentication and authorization</li>
<li><strong>Tenant Management</strong>: For multi-tenant configuration and isolation</li>
<li><strong>Container Orchestration</strong>: For isolated execution environments</li>
<li><strong>Monitoring Infrastructure</strong>: For observability and alerting</li>
<li><strong>Storage Services</strong>: For persistent data and file management</li>
</ul>
<h2 id="business-requirements">Business Requirements</h2>
<h3 id="functional-requirements">Functional Requirements</h3>
<h4 id="fr-001-custom-utility-management">FR-001: Custom Utility Management</h4>
<ul>
<li>Users must be able to create custom Python utilities</li>
<li>System must validate Python syntax and security</li>
<li>Users must be able to update existing utilities</li>
<li>Users must be able to delete utilities they own</li>
<li>System must maintain version history</li>
</ul>
<h4 id="fr-002-code-validation-and-security">FR-002: Code Validation and Security</h4>
<ul>
<li>System must validate Python syntax before saving</li>
<li>System must scan for prohibited code patterns</li>
<li>System must prevent execution of malicious code</li>
<li>System must provide detailed validation feedback</li>
</ul>
<h4 id="fr-003-utility-execution">FR-003: Utility Execution</h4>
<ul>
<li>Users must be able to execute their custom utilities</li>
<li>System must provide real-time execution output</li>
<li>System must support parameterized execution</li>
<li>System must handle execution timeouts gracefully</li>
</ul>
<h4 id="fr-004-multi-tenant-support">FR-004: Multi-tenant Support</h4>
<ul>
<li>System must isolate data between tenants</li>
<li>System must support tenant-specific configurations</li>
<li>System must enable cross-tenant utility copying</li>
<li>System must maintain tenant-level audit trails</li>
</ul>
<h4 id="fr-005-exportimport-functionality">FR-005: Export/Import Functionality</h4>
<ul>
<li>Users must be able to export utilities</li>
<li>Users must be able to import utilities</li>
<li>System must support bulk operations</li>
<li>System must validate imported utilities</li>
</ul>
<h4 id="fr-006-audit-and-compliance">FR-006: Audit and Compliance</h4>
<ul>
<li>System must log all user actions</li>
<li>System must maintain execution history</li>
<li>System must provide compliance reporting</li>
<li>System must support data retention policies</li>
</ul>
<h3 id="non-functional-requirements">Non-Functional Requirements</h3>
<h4 id="nfr-001-performance">NFR-001: Performance</h4>
<ul>
<li>API response time &lt; 500ms for read operations</li>
<li>API response time &lt; 2s for write operations</li>
<li>System must support 1000+ concurrent users</li>
<li>Utility execution timeout &lt; 300 seconds</li>
</ul>
<h4 id="nfr-002-scalability">NFR-002: Scalability</h4>
<ul>
<li>System must scale horizontally</li>
<li>Must support 100+ tenants</li>
<li>Must handle 10,000+ utilities per tenant</li>
<li>Database must support sharding</li>
</ul>
<h4 id="nfr-003-availability">NFR-003: Availability</h4>
<ul>
<li>System uptime &gt; 99.9%</li>
<li>Recovery time &lt; 5 minutes</li>
<li>Data backup every 24 hours</li>
<li>Multi-region disaster recovery</li>
</ul>
<h4 id="nfr-004-security">NFR-004: Security</h4>
<ul>
<li>All data encrypted at rest and in transit</li>
<li>Role-based access control</li>
<li>Code execution in isolated environments</li>
<li>Regular security audits</li>
</ul>
<h4 id="nfr-005-usability">NFR-005: Usability</h4>
<ul>
<li>Intuitive web interface</li>
<li>Comprehensive API documentation</li>
<li>Real-time feedback and validation</li>
<li>Multi-language support</li>
</ul>
<h2 id="solution-architecture">Solution Architecture</h2>
<h3 id="architectural-principles">Architectural Principles</h3>
<ol>
<li><strong>Single Responsibility</strong>: Each component has a well-defined purpose</li>
<li><strong>Loose Coupling</strong>: Components interact through well-defined interfaces</li>
<li><strong>High Cohesion</strong>: Related functionality is grouped together</li>
<li><strong>Separation of Concerns</strong>: Clear boundaries between different aspects</li>
<li><strong>Fail-Safe Design</strong>: Graceful degradation under failure conditions</li>
</ol>
<h3 id="architecture-patterns">Architecture Patterns</h3>
<ul>
<li><strong>Layered Architecture</strong>: Clear separation between presentation, business, and data layers</li>
<li><strong>Repository Pattern</strong>: Abstracted data access layer</li>
<li><strong>Builder Pattern</strong>: Complex object construction</li>
<li><strong>Middleware Pattern</strong>: Cross-cutting concerns handling</li>
<li><strong>Circuit Breaker</strong>: Fault tolerance for external service calls</li>
</ul>
<h3 id="technology-decisions">Technology Decisions</h3>
<h4 id="programming-language-go">Programming Language: Go</h4>
<p><strong>Rationale</strong>: 
- High performance and low latency
- Excellent concurrency support
- Strong ecosystem for microservices
- Easy deployment and maintenance</p>
<h4 id="database-mongodb">Database: MongoDB</h4>
<p><strong>Rationale</strong>:
- Document-based model fits utility metadata
- Horizontal scaling capabilities
- Rich querying capabilities
- Multi-tenant support</p>
<h4 id="cache-redis">Cache: Redis</h4>
<p><strong>Rationale</strong>:
- High-performance in-memory storage
- Advanced data structures
- Pub/Sub capabilities
- Clustering support</p>
<h4 id="container-runtime-docker">Container Runtime: Docker</h4>
<p><strong>Rationale</strong>:
- Isolated execution environment
- Resource management
- Portability across environments
- Extensive ecosystem</p>
<h2 id="component-architecture">Component Architecture</h2>
<div class="mermaid">
graph TB
    subgraph "Presentation Layer"
        HTTP[HTTP Router]
        MIDDLEWARE[Middleware Stack]
        CONTROLLERS[Controllers]
    end

    subgraph "Business Logic Layer"
        SERVICES[Services]
        BUILDERS[Builders]
        VALIDATORS[Validators]
    end

    subgraph "Data Access Layer"
        REPOSITORIES[Repositories]
        MODELS[Data Models]
        CACHE[Cache Layer]
    end

    subgraph "Infrastructure Layer"
        DOCKER_MGR[Container Manager]
        FILE_MGR[File Manager]
        AUDIT[Audit Logger]
        METRICS[Metrics Collector]
    end

    HTTP --> MIDDLEWARE
    MIDDLEWARE --> CONTROLLERS
    CONTROLLERS --> SERVICES
    SERVICES --> BUILDERS
    SERVICES --> VALIDATORS
    SERVICES --> REPOSITORIES
    REPOSITORIES --> MODELS
    REPOSITORIES --> CACHE
    SERVICES --> DOCKER_MGR
    SERVICES --> FILE_MGR
    SERVICES --> AUDIT
    SERVICES --> METRICS
</div>

<h3 id="component-responsibilities">Component Responsibilities</h3>
<h4 id="presentation-layer">Presentation Layer</h4>
<ul>
<li><strong>HTTP Router</strong>: Route incoming requests to appropriate controllers</li>
<li><strong>Middleware Stack</strong>: Handle authentication, logging, and cross-cutting concerns</li>
<li><strong>Controllers</strong>: Process HTTP requests and generate responses</li>
</ul>
<h4 id="business-logic-layer">Business Logic Layer</h4>
<ul>
<li><strong>Services</strong>: Implement core business logic and orchestrate operations</li>
<li><strong>Builders</strong>: Construct complex objects and configurations</li>
<li><strong>Validators</strong>: Validate input data and business rules</li>
</ul>
<h4 id="data-access-layer">Data Access Layer</h4>
<ul>
<li><strong>Repositories</strong>: Abstract data access operations</li>
<li><strong>Data Models</strong>: Define data structures and relationships</li>
<li><strong>Cache Layer</strong>: Provide high-performance data access</li>
</ul>
<h4 id="infrastructure-layer">Infrastructure Layer</h4>
<ul>
<li><strong>Container Manager</strong>: Manage Docker container lifecycle</li>
<li><strong>File Manager</strong>: Handle file system operations</li>
<li><strong>Audit Logger</strong>: Record audit trails and compliance data</li>
<li><strong>Metrics Collector</strong>: Gather performance and operational metrics</li>
</ul>
<h2 id="data-architecture">Data Architecture</h2>
<h3 id="logical-data-model">Logical Data Model</h3>
<div class="mermaid">
erDiagram
    TENANT {
        int id PK
        string tenantcode UK
        string name
        string status
        string db_host
        string connection_status
    }

    CUSTOM_UTIL {
        int id PK
        string name UK
        string tenantcode FK
        int userid FK
        string description
        string status
        string category
        text filecontents
        bigint createddate
        bigint updateddate
        text input_params
        text output_fields
        array playbook_names
    }

    TASK_EXECUTION {
        string id PK
        int taskid FK
        int userid FK
        string tenantcode FK
        bigint createddate
        text request
        text response
        string status
        float execution_time
    }

    AUDIT_LOG {
        string id PK
        string tenantcode FK
        int userid FK
        string action
        string resource
        bigint timestamp
        text details
    }

    TENANT ||--o{ CUSTOM_UTIL : contains
    CUSTOM_UTIL ||--o{ TASK_EXECUTION : executes
    TENANT ||--o{ AUDIT_LOG : generates
</div>

<h3 id="data-storage-strategy">Data Storage Strategy</h3>
<h4 id="primary-data-storage-mongodb">Primary Data Storage (MongoDB)</h4>
<ul>
<li><strong>Collections</strong>: Utilities, executions, audit logs, tenants</li>
<li><strong>Sharding Strategy</strong>: Shard by tenant code for horizontal scaling</li>
<li><strong>Replica Sets</strong>: 3-node replica sets for high availability</li>
<li><strong>Backup Strategy</strong>: Daily backups with point-in-time recovery</li>
</ul>
<h4 id="cache-strategy-redis">Cache Strategy (Redis)</h4>
<ul>
<li><strong>L1 Cache</strong>: Application-level caching (5 minutes TTL)</li>
<li><strong>L2 Cache</strong>: Redis caching (1 hour TTL)</li>
<li><strong>Cache Keys</strong>: Hierarchical naming convention</li>
<li><strong>Eviction Policy</strong>: LRU with memory limit enforcement</li>
</ul>
<h4 id="file-storage">File Storage</h4>
<ul>
<li><strong>Code Files</strong>: Encrypted Python files on network storage</li>
<li><strong>Logs</strong>: Execution logs on distributed file system</li>
<li><strong>Backups</strong>: Compressed archives on object storage</li>
</ul>
<h3 id="data-security">Data Security</h3>
<ul>
<li><strong>Encryption at Rest</strong>: AES-256 encryption for all stored data</li>
<li><strong>Encryption in Transit</strong>: TLS 1.3 for all network communication</li>
<li><strong>Data Masking</strong>: Sensitive data masked in logs and non-production environments</li>
<li><strong>Access Control</strong>: Role-based access with principle of least privilege</li>
</ul>
<h2 id="security-architecture">Security Architecture</h2>
<h3 id="security-layers">Security Layers</h3>
<div class="mermaid">
graph TB
    subgraph "Perimeter Security"
        WAF[Web Application Firewall]
        DDOS[DDoS Protection]
        FIREWALL[Network Firewall]
    end

    subgraph "Application Security"
        AUTH[Authentication]
        AUTHZ[Authorization]
        INPUT_VAL[Input Validation]
        CODE_SCAN[Code Scanning]
    end

    subgraph "Data Security"
        ENCRYPT[Data Encryption]
        MASKING[Data Masking]
        BACKUP_SEC[Secure Backup]
    end

    subgraph "Runtime Security"
        CONTAINER_SEC[Container Security]
        ISOLATION[Process Isolation]
        MONITORING[Security Monitoring]
    end

    WAF --> DDOS
    DDOS --> FIREWALL
    FIREWALL --> AUTH
    AUTH --> AUTHZ
    AUTHZ --> INPUT_VAL
    INPUT_VAL --> CODE_SCAN
    CODE_SCAN --> ENCRYPT
    ENCRYPT --> MASKING
    MASKING --> BACKUP_SEC
    BACKUP_SEC --> CONTAINER_SEC
    CONTAINER_SEC --> ISOLATION
    ISOLATION --> MONITORING
</div>

<h3 id="authentication-and-authorization">Authentication and Authorization</h3>
<h4 id="authentication-flow">Authentication Flow</h4>
<ol>
<li>User provides credentials to authentication service</li>
<li>Authentication service validates credentials</li>
<li>JWT token issued with user claims and permissions</li>
<li>Token included in subsequent API requests</li>
<li>Service validates token and extracts user context</li>
</ol>
<h4 id="authorization-model">Authorization Model</h4>
<ul>
<li><strong>Role-Based Access Control (RBAC)</strong></li>
<li><strong>Tenant-based isolation</strong></li>
<li><strong>Resource-level permissions</strong></li>
<li><strong>Operation-level granularity</strong></li>
</ul>
<h4 id="permission-matrix">Permission Matrix</h4>
<table>
<thead>
<tr>
<th>Role</th>
<th>Create Utils</th>
<th>Read Utils</th>
<th>Execute Utils</th>
<th>Delete Utils</th>
<th>Admin Functions</th>
</tr>
</thead>
<tbody>
<tr>
<td>User</td>
<td>Own</td>
<td>Own</td>
<td>Own</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td>Creator</td>
<td>Own</td>
<td>Own</td>
<td>Own</td>
<td>Own</td>
<td>No</td>
</tr>
<tr>
<td>Admin</td>
<td>All</td>
<td>All</td>
<td>All</td>
<td>All</td>
<td>Limited</td>
</tr>
<tr>
<td>Super Admin</td>
<td>All</td>
<td>All</td>
<td>All</td>
<td>All</td>
<td>All</td>
</tr>
</tbody>
</table>
<h3 id="code-security">Code Security</h3>
<h4 id="validation-rules">Validation Rules</h4>
<ul>
<li><strong>Syntax Validation</strong>: Python AST parsing</li>
<li><strong>Security Scanning</strong>: Pattern-based security checks</li>
<li><strong>Dependency Analysis</strong>: Package security assessment</li>
<li><strong>Resource Limits</strong>: Memory and CPU constraints</li>
</ul>
<h4 id="prohibited-patterns">Prohibited Patterns</h4>
<ul>
<li>File system access (<code>open()</code>, <code>file()</code>)</li>
<li>Network operations (<code>socket</code>, <code>urllib</code>, <code>requests</code>)</li>
<li>Process execution (<code>subprocess</code>, <code>os.system</code>)</li>
<li>System imports (<code>os</code>, <code>sys</code>, <code>subprocess</code>)</li>
</ul>
<h2 id="performance-architecture">Performance Architecture</h2>
<h3 id="performance-strategy">Performance Strategy</h3>
<div class="mermaid">
graph TD
    REQUEST[Incoming Request] --> CACHE_L1{L1 Cache}
    CACHE_L1 -->|Hit| RETURN_FAST[Return Cached]
    CACHE_L1 -->|Miss| CACHE_L2{L2 Cache}
    CACHE_L2 -->|Hit| UPDATE_L1[Update L1]
    CACHE_L2 -->|Miss| DATABASE[Database Query]
    UPDATE_L1 --> RETURN_FAST
    DATABASE --> OPTIMIZE{Optimized Query?}
    OPTIMIZE -->|Yes| FAST_QUERY[Execute Fast Query]
    OPTIMIZE -->|No| SLOW_QUERY[Execute Slow Query]
    FAST_QUERY --> CACHE_UPDATE[Update Caches]
    SLOW_QUERY --> CACHE_UPDATE
    CACHE_UPDATE --> RETURN_RESULT[Return Result]
</div>

<h3 id="performance-targets">Performance Targets</h3>
<h4 id="response-time-requirements">Response Time Requirements</h4>
<table>
<thead>
<tr>
<th>Operation</th>
<th>Target</th>
<th>Maximum</th>
</tr>
</thead>
<tbody>
<tr>
<td>Get Utility List</td>
<td>&lt; 200ms</td>
<td>500ms</td>
</tr>
<tr>
<td>Create Utility</td>
<td>&lt; 1s</td>
<td>2s</td>
</tr>
<tr>
<td>Validate Code</td>
<td>&lt; 500ms</td>
<td>1s</td>
</tr>
<tr>
<td>Execute Utility</td>
<td>&lt; 10s</td>
<td>300s</td>
</tr>
<tr>
<td>Export/Import</td>
<td>&lt; 5s</td>
<td>30s</td>
</tr>
</tbody>
</table>
<h4 id="throughput-requirements">Throughput Requirements</h4>
<table>
<thead>
<tr>
<th>Metric</th>
<th>Target</th>
<th>Peak</th>
</tr>
</thead>
<tbody>
<tr>
<td>Requests/Second</td>
<td>1000</td>
<td>5000</td>
</tr>
<tr>
<td>Concurrent Users</td>
<td>100</td>
<td>500</td>
</tr>
<tr>
<td>Utility Executions/Minute</td>
<td>60</td>
<td>300</td>
</tr>
</tbody>
</table>
<h3 id="optimization-strategies">Optimization Strategies</h3>
<h4 id="database-optimization">Database Optimization</h4>
<ul>
<li><strong>Indexing Strategy</strong>: Compound indexes for common query patterns</li>
<li><strong>Query Optimization</strong>: Aggregation pipelines for complex queries</li>
<li><strong>Connection Pooling</strong>: Reuse database connections</li>
<li><strong>Read Replicas</strong>: Distribute read load across replicas</li>
</ul>
<h4 id="caching-strategy">Caching Strategy</h4>
<ul>
<li><strong>Multi-level Caching</strong>: Application, Redis, and database caching</li>
<li><strong>Cache Warming</strong>: Pre-populate frequently accessed data</li>
<li><strong>Cache Invalidation</strong>: Event-driven cache updates</li>
<li><strong>Cache Partitioning</strong>: Distribute cache load</li>
</ul>
<h4 id="application-optimization">Application Optimization</h4>
<ul>
<li><strong>Goroutine Pooling</strong>: Reuse goroutines for concurrent operations</li>
<li><strong>Memory Management</strong>: Efficient memory allocation and garbage collection</li>
<li><strong>Compression</strong>: Compress large responses</li>
<li><strong>Connection Reuse</strong>: HTTP connection pooling</li>
</ul>
<h2 id="deployment-architecture">Deployment Architecture</h2>
<h3 id="production-environment">Production Environment</h3>
<div class="mermaid">
graph TB
    subgraph "Load Balancer Tier"
        LB1[Load Balancer 1]
        LB2[Load Balancer 2]
    end

    subgraph "Application Tier"
        APP1[App Instance 1]
        APP2[App Instance 2]
        APP3[App Instance 3]
    end

    subgraph "Data Tier"
        MONGO_P[MongoDB Primary]
        MONGO_S1[MongoDB Secondary 1]
        MONGO_S2[MongoDB Secondary 2]
        REDIS_M[Redis Master]
        REDIS_S[Redis Slave]
    end

    subgraph "Container Tier"
        DOCKER1[Docker Host 1]
        DOCKER2[Docker Host 2]
        DOCKER3[Docker Host 3]
    end

    INTERNET[Internet] --> LB1
    INTERNET --> LB2
    LB1 --> APP1
    LB1 --> APP2
    LB2 --> APP2
    LB2 --> APP3
    APP1 --> MONGO_P
    APP2 --> MONGO_P
    APP3 --> MONGO_P
    MONGO_P --> MONGO_S1
    MONGO_P --> MONGO_S2
    APP1 --> REDIS_M
    APP2 --> REDIS_M
    APP3 --> REDIS_M
    REDIS_M --> REDIS_S
    APP1 --> DOCKER1
    APP2 --> DOCKER2
    APP3 --> DOCKER3
</div>

<h3 id="deployment-strategy">Deployment Strategy</h3>
<ul>
<li><strong>Blue-Green Deployment</strong>: Zero-downtime deployments</li>
<li><strong>Rolling Updates</strong>: Gradual rollout of new versions</li>
<li><strong>Canary Releases</strong>: Limited exposure testing</li>
<li><strong>Automated Rollback</strong>: Quick recovery from failed deployments</li>
</ul>
<h3 id="environment-management">Environment Management</h3>
<ul>
<li><strong>Development</strong>: Single instance for development and testing</li>
<li><strong>Staging</strong>: Production-like environment for validation</li>
<li><strong>Production</strong>: High-availability multi-instance deployment</li>
<li><strong>Disaster Recovery</strong>: Secondary region for business continuity</li>
</ul>
<h2 id="integration-architecture">Integration Architecture</h2>
<h3 id="external-service-integration">External Service Integration</h3>
<div class="mermaid">
graph LR
    subgraph "Zona Custom Utils"
        CORE[Core Service]
    end

    subgraph "Internal Services"
        AUTH_SVC[Authentication Service]
        TENANT_SVC[Tenant Management]
        AUDIT_SVC[Audit Service]
        NOTIFY_SVC[Notification Service]
    end

    subgraph "External Services"
        DOCKER_API[Docker Engine API]
        FILE_STORAGE[File Storage Service]
        MONITORING[Monitoring Service]
        LOGGING[Logging Service]
    end

    CORE <--> AUTH_SVC
    CORE <--> TENANT_SVC
    CORE --> AUDIT_SVC
    CORE --> NOTIFY_SVC
    CORE <--> DOCKER_API
    CORE <--> FILE_STORAGE
    CORE --> MONITORING
    CORE --> LOGGING
</div>

<h3 id="integration-patterns">Integration Patterns</h3>
<h4 id="synchronous-integration">Synchronous Integration</h4>
<ul>
<li><strong>REST API</strong>: For real-time operations requiring immediate response</li>
<li><strong>Direct Database Access</strong>: For high-performance data operations</li>
<li><strong>File System Access</strong>: For code storage and retrieval</li>
</ul>
<h4 id="asynchronous-integration">Asynchronous Integration</h4>
<ul>
<li><strong>Event Publishing</strong>: For audit logging and notifications</li>
<li><strong>Message Queues</strong>: For long-running operations</li>
<li><strong>Batch Processing</strong>: For bulk operations and maintenance tasks</li>
</ul>
<h2 id="business-process-flows">Business Process Flows</h2>
<h3 id="custom-utility-creation-flow">Custom Utility Creation Flow</h3>
<div class="mermaid">
sequenceDiagram
    participant User
    participant UI
    participant API
    participant Service
    participant Validator
    participant Storage
    participant Docker

    User->>UI: Create Utility
    UI->>API: POST /custom-utils
    API->>Service: Process Request
    Service->>Validator: Validate Code
    Validator->>Service: Validation Results

    alt Validation Failed
        Service->>API: Error Response
        API->>UI: Validation Errors
        UI->>User: Show Errors
    else Validation Passed
        Service->>Storage: Save Utility
        Service->>Docker: Update Config
        Service->>API: Success Response
        API->>UI: Confirmation
        UI->>User: Success Message
    end
</div>

<h3 id="utility-execution-flow">Utility Execution Flow</h3>
<div class="mermaid">
sequenceDiagram
    participant User
    participant UI
    participant API
    participant Service
    participant Container
    participant Storage

    User->>UI: Execute Utility
    UI->>API: POST /execute
    API->>Service: Execute Request
    Service->>Container: Start Execution
    Container->>Container: Run Python Code
    Container->>Service: Stream Output
    Service->>API: Real-time Results
    API->>UI: Stream Response
    UI->>User: Show Output
    Container->>Service: Final Results
    Service->>Storage: Store Results
    Service->>API: Completion
    API->>UI: Execution Complete
</div>

<h3 id="multi-tenant-deployment-flow">Multi-Tenant Deployment Flow</h3>
<div class="mermaid">
sequenceDiagram
    participant Admin
    participant Service
    participant MasterDB
    participant TenantDB
    participant Cache

    Admin->>Service: Deploy to New Tenant
    Service->>MasterDB: Get Source Utilities
    Service->>Service: Process Utilities

    loop For Each Utility
        Service->>TenantDB: Create Utility
        Service->>Cache: Clear Cache
        Service->>Service: Update Metadata
    end

    Service->>Admin: Deployment Complete
</div>

<h2 id="non-functional-requirements_1">Non-Functional Requirements</h2>
<h3 id="availability-requirements">Availability Requirements</h3>
<ul>
<li><strong>Uptime Target</strong>: 99.9% (8.76 hours downtime per year)</li>
<li><strong>Planned Maintenance</strong>: Maximum 4 hours per month</li>
<li><strong>Recovery Time Objective (RTO)</strong>: 15 minutes</li>
<li><strong>Recovery Point Objective (RPO)</strong>: 1 hour</li>
</ul>
<h3 id="scalability-requirements">Scalability Requirements</h3>
<ul>
<li><strong>Horizontal Scaling</strong>: Auto-scaling based on load</li>
<li><strong>Vertical Scaling</strong>: Resource scaling for individual instances</li>
<li><strong>Database Scaling</strong>: Sharding and read replicas</li>
<li><strong>Cache Scaling</strong>: Redis clustering for distributed caching</li>
</ul>
<h3 id="reliability-requirements">Reliability Requirements</h3>
<ul>
<li><strong>Mean Time Between Failures (MTBF)</strong>: &gt; 720 hours</li>
<li><strong>Mean Time To Recovery (MTTR)</strong>: &lt; 15 minutes</li>
<li><strong>Error Rate</strong>: &lt; 0.1% for API requests</li>
<li><strong>Data Consistency</strong>: Eventual consistency for non-critical data</li>
</ul>
<h3 id="maintainability-requirements">Maintainability Requirements</h3>
<ul>
<li><strong>Code Coverage</strong>: &gt; 80% for unit tests</li>
<li><strong>Documentation</strong>: Comprehensive API and architecture documentation</li>
<li><strong>Monitoring</strong>: Full observability with metrics, logs, and traces</li>
<li><strong>Deployment</strong>: Automated CI/CD pipeline with rollback capability</li>
</ul>
<h3 id="compliance-requirements">Compliance Requirements</h3>
<ul>
<li><strong>Data Privacy</strong>: GDPR and CCPA compliance</li>
<li><strong>Security Standards</strong>: SOC 2 Type II certification</li>
<li><strong>Audit Logging</strong>: Complete audit trail for all operations</li>
<li><strong>Data Retention</strong>: Configurable retention policies per tenant</li>
</ul>
<hr />
<p><em>This High-Level Design document provides a comprehensive overview of the Zona Custom Utils Service architecture, focusing on business requirements, solution approach, and architectural decisions. It serves as a foundation for detailed technical implementation and stakeholder communication.</em></p>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Securaa Security Platform. All rights reserved.</p>
        <p>Documentation generated on December 18, 2025</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#4f46e5',
                primaryTextColor: '#1f2937',
                primaryBorderColor: '#818cf8',
                lineColor: '#6b7280',
                secondaryColor: '#f3f4f6',
                tertiaryColor: '#e5e7eb',
                background: '#ffffff',
                mainBkg: '#f9fafb',
                secondBkg: '#f3f4f6',
                border1: '#e5e7eb',
                border2: '#d1d5db',
                fontFamily: 'Inter, sans-serif',
                fontSize: '14px',
                nodeBorder: '#4f46e5',
                clusterBkg: '#f0f4f8',
                clusterBorder: '#818cf8',
                edgeLabelBackground: '#ffffff'
            },
            flowchart: {
                htmlLabels: true,
                useMaxWidth: true,
                curve: 'basis',
                padding: 15,
                nodeSpacing: 50,
                rankSpacing: 50
            },
            sequence: {
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: true,
                useMaxWidth: true
            },
            er: {
                useMaxWidth: true,
                entityPadding: 15,
                fontSize: 12
            },
            class: {
                useMaxWidth: true,
                padding: 10
            },
            gantt: {
                useMaxWidth: true,
                barHeight: 20,
                barGap: 4,
                topPadding: 50,
                leftPadding: 75
            },
            pie: {
                useMaxWidth: true,
                textPosition: 0.5
            },
            mindmap: {
                useMaxWidth: true,
                padding: 10
            },
            securityLevel: 'loose',
            logLevel: 'error'
        });

        // Re-render mermaid diagrams after page load for better sizing
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.querySelectorAll('.mermaid').forEach(function(el) {
                    if (el.getAttribute('data-processed') !== 'true') {
                        mermaid.init(undefined, el);
                    }
                });
            }, 100);
        });
    </script>
</body>
</html>
