<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Securaa Platform Documentation - Securaa Playbook Service - Low Level Design">
    <title>Securaa Playbook Service - Low Level Design - Securaa Documentation</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>

:root {
    --primary-color: #4f46e5;
    --primary-dark: #3730a3;
    --primary-light: #818cf8;
    --secondary-color: #06b6d4;
    --accent-color: #f59e0b;
    --success-color: #10b981;
    --warning-color: #f59e0b;
    --error-color: #ef4444;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --text-muted: #9ca3af;
    --bg-primary: #ffffff;
    --bg-secondary: #f9fafb;
    --bg-tertiary: #f3f4f6;
    --border-color: #e5e7eb;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    scroll-behavior: smooth;
    font-size: 16px;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.7;
    color: var(--text-primary);
    background-color: var(--bg-secondary);
}

/* Header */
.main-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 1rem 2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: var(--shadow-lg);
}

.header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.header-logo {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.025em;
}

.header-logo span {
    color: var(--secondary-color);
}

/* Navigation */
.documentation-nav {
    background: var(--bg-primary);
    border-bottom: 1px solid var(--border-color);
    padding: 0.75rem 2rem;
    position: sticky;
    top: 60px;
    z-index: 999;
    box-shadow: var(--shadow-sm);
}

.nav-links {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
    justify-content: center;
}

.nav-links a {
    color: var(--text-secondary);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
    border-radius: 0.375rem;
    transition: all 0.2s ease;
}

.nav-links a:hover {
    color: var(--primary-color);
    background: var(--bg-tertiary);
}

/* Main Content */
.main-content {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 2.5rem;
    background: var(--bg-primary);
    border-radius: 1rem;
    box-shadow: var(--shadow-md);
}

/* Typography */
h1, h2, h3, h4, h5, h6 {
    color: var(--text-primary);
    font-weight: 700;
    line-height: 1.3;
    margin-top: 2rem;
    margin-bottom: 1rem;
}

h1 {
    font-size: 2.5rem;
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    padding-bottom: 0.75rem;
    border-bottom: 3px solid var(--primary-color);
    margin-top: 0;
}

h2 {
    font-size: 1.875rem;
    color: var(--primary-dark);
    border-bottom: 2px solid var(--border-color);
    padding-bottom: 0.5rem;
}

h3 {
    font-size: 1.5rem;
    color: var(--text-primary);
}

h4 {
    font-size: 1.25rem;
    color: var(--text-secondary);
}

h5 {
    font-size: 1.125rem;
}

h6 {
    font-size: 1rem;
    color: var(--text-muted);
}

p {
    margin-bottom: 1rem;
    color: var(--text-primary);
}

/* Links */
a {
    color: var(--primary-color);
    text-decoration: none;
    transition: color 0.2s ease;
}

a:hover {
    color: var(--primary-dark);
    text-decoration: underline;
}

/* Lists */
ul, ol {
    margin-bottom: 1rem;
    padding-left: 1.5rem;
}

li {
    margin-bottom: 0.5rem;
}

li > ul, li > ol {
    margin-top: 0.5rem;
    margin-bottom: 0;
}

/* Code Blocks */
pre {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 1.25rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.5rem 0;
    font-size: 0.875rem;
    line-height: 1.6;
    box-shadow: var(--shadow-md);
}

code {
    font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 0.875em;
}

:not(pre) > code {
    background: var(--bg-tertiary);
    color: var(--primary-dark);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.875em;
}

/* Tables */
table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.9rem;
    box-shadow: var(--shadow-sm);
    border-radius: 0.5rem;
    overflow: hidden;
}

thead {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
    color: white;
}

th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
}

td {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

tr:nth-child(even) {
    background: var(--bg-secondary);
}

tr:hover {
    background: var(--bg-tertiary);
}

/* Blockquotes */
blockquote {
    border-left: 4px solid var(--primary-color);
    padding: 1rem 1.5rem;
    margin: 1.5rem 0;
    background: var(--bg-secondary);
    border-radius: 0 0.5rem 0.5rem 0;
    font-style: italic;
    color: var(--text-secondary);
}

blockquote p:last-child {
    margin-bottom: 0;
}

/* Mermaid Diagrams - Enhanced Styling */
.mermaid {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 2rem 0;
    padding: 1.5rem;
    background: linear-gradient(135deg, #fafbfc 0%, #f0f4f8 100%);
    border-radius: 0.75rem;
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-sm);
    overflow-x: auto;
    overflow-y: visible;
    min-height: 200px;
}

.mermaid svg {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 0 auto;
}

/* Ensure diagrams scale properly */
.mermaid[data-processed="true"] {
    min-height: auto;
}

/* Diagram container for better control */
.diagram-container {
    width: 100%;
    overflow-x: auto;
    padding: 1rem 0;
}

/* HR Styling */
hr {
    border: none;
    border-top: 2px solid var(--border-color);
    margin: 2.5rem 0;
}

/* Table of Contents */
.toc {
    background: var(--bg-secondary);
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
    border: 1px solid var(--border-color);
}

.toc-title {
    font-weight: 700;
    color: var(--primary-color);
    margin-bottom: 1rem;
    font-size: 1.125rem;
}

.toc ul {
    list-style: none;
    padding-left: 0;
}

.toc li {
    margin-bottom: 0.5rem;
}

.toc a {
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.toc a:hover {
    color: var(--primary-color);
}

/* Document Info Box */
.doc-info {
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    font-size: 0.875rem;
}

.doc-info strong {
    color: var(--primary-color);
}

/* Footer */
.footer {
    text-align: center;
    padding: 2rem;
    background: var(--bg-tertiary);
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-top: 2rem;
}

/* Scrollbar Styling */
::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
}

::-webkit-scrollbar-thumb {
    background: var(--text-muted);
    border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}

/* Print Styles */
@media print {
    .main-header, .documentation-nav, .footer {
        display: none !important;
    }

    .main-content {
        max-width: none;
        margin: 0;
        padding: 20px;
        box-shadow: none;
        border-radius: 0;
    }

    body {
        background: white;
        font-size: 11pt;
    }

    h1 {
        font-size: 24pt;
        -webkit-text-fill-color: var(--primary-dark);
        page-break-after: avoid;
    }

    h2, h3, h4 {
        page-break-after: avoid;
    }

    pre {
        background: #f5f5f5 !important;
        color: #333 !important;
        border: 1px solid #ddd;
        page-break-inside: avoid;
        font-size: 9pt;
    }

    table {
        page-break-inside: avoid;
    }

    .mermaid {
        page-break-inside: avoid;
        background: white !important;
        border: 1px solid #ddd;
        max-width: 100% !important;
    }

    .mermaid svg {
        max-width: 100% !important;
        max-height: 700px !important;
    }

    a {
        color: var(--primary-dark) !important;
        text-decoration: none !important;
    }
}

/* Responsive Design */
@media (max-width: 768px) {
    .main-content {
        margin: 1rem;
        padding: 1.5rem;
        border-radius: 0.5rem;
    }

    h1 {
        font-size: 1.75rem;
    }

    h2 {
        font-size: 1.5rem;
    }

    .nav-links {
        gap: 0.75rem;
    }

    .nav-links a {
        font-size: 0.75rem;
        padding: 0.375rem 0.5rem;
    }

    pre {
        font-size: 0.8rem;
        padding: 1rem;
    }

    table {
        font-size: 0.8rem;
    }

    th, td {
        padding: 0.5rem;
    }
}

/* Animation for smooth transitions */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.main-content {
    animation: fadeIn 0.3s ease-out;
}

/* Index-specific styles */
.hero {
    text-align: center;
    padding: 3rem 0;
    background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
    border-radius: 1rem;
    margin-bottom: 3rem;
}

.hero h1 {
    font-size: 3rem;
    margin-bottom: 1rem;
    border: none;
    padding: 0;
}

.hero p {
    font-size: 1.25rem;
    color: var(--text-secondary);
    max-width: 600px;
    margin: 0 auto;
}

.doc-sections {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 2rem;
}

.doc-card {
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 0.75rem;
    padding: 1.5rem;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
}

.doc-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-light);
}

.doc-card h3 {
    color: var(--primary-color);
    font-size: 1.25rem;
    margin-top: 0;
    margin-bottom: 0.75rem;
}

.doc-card p {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-bottom: 1rem;
}

.doc-card .links {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.doc-card .links a {
    font-size: 0.875rem;
    padding: 0.5rem 1rem;
    background: var(--bg-secondary);
    border-radius: 0.375rem;
    transition: all 0.2s ease;
}

.doc-card .links a:hover {
    background: var(--primary-color);
    color: white;
    text-decoration: none;
}

.section-title {
    font-size: 1.75rem;
    color: var(--primary-dark);
    margin-top: 3rem;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--border-color);
}

    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-content">
            <div class="header-logo">Securaa<span>Docs</span></div>
            <div class="header-meta">
                <span>Generated: December 18, 2025</span>
            </div>
        </div>
    </header>

    <nav class="documentation-nav">
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="securaa-platform-high-level-design.html">Platform</a>
            <a href="securaa-playbook-high-level-design.html">Playbook</a>
            <a href="securaa-siem-high-level-design.html">SIEM</a>
            <a href="securaa-user-high-level-design.html">User Service</a>
            <a href="securaa-custom-services-high-level-design.html">Custom Services</a>
            <a href="sia-service-high-level-design.html">SIA Service</a>
            <a href="securaa-ris-high-level-design.html">RIS</a>
        </div>
    </nav>

    <main class="main-content">
        <h1 id="securaa-playbook-service-low-level-design-document">Securaa Playbook Service - Low Level Design Document</h1>
<h2 id="document-information">Document Information</h2>
<ul>
<li><strong>Service Name</strong>: Securaa Playbook Service</li>
<li><strong>Version</strong>: 1.0</li>
<li><strong>Date</strong>: September 11, 2025</li>
<li><strong>Author</strong>: Development Team</li>
<li><strong>Related Documents</strong>: <a href="./HIGH_LEVEL_DESIGN.md">High Level Design</a></li>
</ul>
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#overview">Overview</a></li>
<li><a href="#detailed-component-design">Detailed Component Design</a></li>
<li><a href="#class-diagrams">Class Diagrams</a></li>
<li><a href="#sequence-diagrams">Sequence Diagrams</a></li>
<li><a href="#database-schema">Database Schema</a></li>
<li><a href="#api-specifications">API Specifications</a></li>
<li><a href="#algorithm-specifications">Algorithm Specifications</a></li>
<li><a href="#configuration-management">Configuration Management</a></li>
<li><a href="#error-handling-implementation">Error Handling Implementation</a></li>
<li><a href="#concurrency--thread-safety">Concurrency &amp; Thread Safety</a></li>
<li><a href="#performance-optimizations">Performance Optimizations</a></li>
<li><a href="#testing-strategy">Testing Strategy</a></li>
</ol>
<hr />
<h2 id="1-overview">1. Overview</h2>
<p>The Low Level Design document provides detailed implementation specifications for the Securaa Playbook Service, including class structures, method signatures, algorithm implementations, and detailed interaction patterns.</p>
<h3 id="11-scope">1.1 Scope</h3>
<p>This document covers:
- Detailed class and method specifications
- Database schema with indexes and constraints
- Complete API specifications with validation rules
- Concurrency patterns and thread safety mechanisms
- Performance optimization techniques
- Error handling and recovery strategies</p>
<hr />
<h2 id="2-detailed-component-design">2. Detailed Component Design</h2>
<h3 id="21-core-package-structure">2.1 Core Package Structure</h3>
<div class="highlight"><pre><span></span><code><span class="n">securaa_services</span><span class="o">/</span><span class="n">securaa_playbook</span><span class="o">/</span>
<span class="err">├──</span><span class="w"> </span><span class="n">main</span><span class="o">.</span><span class="n">go</span><span class="w">                     </span><span class="o">//</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">point</span>
<span class="err">├──</span><span class="w"> </span><span class="n">app</span><span class="o">.</span><span class="n">go</span><span class="w">                      </span><span class="o">//</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="n">initialization</span>
<span class="err">├──</span><span class="w"> </span><span class="n">controllers</span><span class="o">/</span><span class="w">                </span><span class="o">//</span><span class="w"> </span><span class="n">HTTP</span><span class="w"> </span><span class="n">request</span><span class="w"> </span><span class="n">handlers</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">playbookcontroller</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">listController</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">caseController</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">supportcontroller</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">processController</span><span class="o">.</span><span class="n">go</span>
<span class="err">├──</span><span class="w"> </span><span class="n">executionControllers</span><span class="o">/</span><span class="w">       </span><span class="o">//</span><span class="w"> </span><span class="n">Execution</span><span class="w"> </span><span class="n">orchestration</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">playbookExecutionController</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">runTaskController</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">conditionController</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">subPlaybookController</span><span class="o">.</span><span class="n">go</span>
<span class="err">├──</span><span class="w"> </span><span class="n">models</span><span class="o">/</span><span class="w">                     </span><span class="o">//</span><span class="w"> </span><span class="n">Data</span><span class="w"> </span><span class="n">models</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">playbook</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">case</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">task</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">Response</span><span class="o">.</span><span class="n">go</span>
<span class="err">├──</span><span class="w"> </span><span class="n">executionModels</span><span class="o">/</span><span class="w">           </span><span class="o">//</span><span class="w"> </span><span class="n">Execution</span><span class="o">-</span><span class="n">specific</span><span class="w"> </span><span class="n">models</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">playbook</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">Tasks</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">incidents</span><span class="o">.</span><span class="n">go</span>
<span class="err">├──</span><span class="w"> </span><span class="n">services</span><span class="o">/</span><span class="w">                  </span><span class="o">//</span><span class="w"> </span><span class="n">Business</span><span class="w"> </span><span class="n">logic</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">genericTaskService</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">processService</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">filterNTransformService</span><span class="o">.</span><span class="n">go</span>
<span class="err">├──</span><span class="w"> </span><span class="n">utils</span><span class="o">/</span><span class="w">                     </span><span class="o">//</span><span class="w"> </span><span class="n">Utility</span><span class="w"> </span><span class="n">functions</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">filterConditionUtils</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">matchConditionUtils</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">executionUtils</span><span class="o">.</span><span class="n">go</span>
<span class="err">├──</span><span class="w"> </span><span class="n">handlers</span><span class="o">/</span><span class="w">                  </span><span class="o">//</span><span class="w"> </span><span class="n">Error</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="n">handlers</span>
<span class="err">│</span><span class="w">   </span><span class="err">├──</span><span class="w"> </span><span class="n">errorHandler</span><span class="o">.</span><span class="n">go</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">taskResponse</span><span class="o">.</span><span class="n">go</span>
<span class="err">├──</span><span class="w"> </span><span class="n">constants</span><span class="o">/</span><span class="w">                 </span><span class="o">//</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="n">constants</span>
<span class="err">│</span><span class="w">   </span><span class="err">└──</span><span class="w"> </span><span class="n">constants</span><span class="o">.</span><span class="n">go</span>
<span class="err">└──</span><span class="w"> </span><span class="n">cacheControllers</span><span class="o">/</span><span class="w">         </span><span class="o">//</span><span class="w"> </span><span class="n">Cache</span><span class="w"> </span><span class="n">management</span>
<span class="w">    </span><span class="err">└──</span><span class="w"> </span><span class="n">cacheController</span><span class="o">.</span><span class="n">go</span>
</code></pre></div>

<h3 id="22-main-application-structure">2.2 Main Application Structure</h3>
<h4 id="221-app-structure">2.2.1 App Structure</h4>
<div class="highlight"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">App</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Router</span><span class="w">             </span><span class="o">*</span><span class="nx">mux</span><span class="p">.</span><span class="nx">Router</span><span class="w">                    </span><span class="c1">// HTTP router</span>
<span class="w">    </span><span class="nx">AccessTokenHashMap</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int64</span><span class="w">               </span><span class="c1">// Session management</span>
<span class="w">    </span><span class="nx">DBSession</span><span class="w">          </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">common</span><span class="p">.</span><span class="nx">SessionStruct</span><span class="w"> </span><span class="c1">// Database sessions</span>
<span class="w">    </span><span class="nx">ConfigObject</span><span class="w">       </span><span class="nx">config</span><span class="p">.</span><span class="nx">ConfigStruct</span><span class="w">            </span><span class="c1">// Configuration</span>
<span class="w">    </span><span class="nx">BuildType</span><span class="w">          </span><span class="kt">string</span><span class="w">                         </span><span class="c1">// Enterprise/MSSP</span>
<span class="w">    </span><span class="nx">LicenseType</span><span class="w">        </span><span class="kt">string</span><span class="w">                         </span><span class="c1">// License information</span>
<span class="w">    </span><span class="nx">RequestResponseLog</span><span class="w"> </span><span class="kt">bool</span><span class="w">                           </span><span class="c1">// Logging flag</span>
<span class="w">    </span><span class="nx">DockerNodeID</span><span class="w">       </span><span class="kt">string</span><span class="w">                         </span><span class="c1">// Docker node identifier</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="222-initialization-flow">2.2.2 Initialization Flow</h4>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">a</span><span class="w"> </span><span class="o">*</span><span class="nx">App</span><span class="p">)</span><span class="w"> </span><span class="nx">Initialize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. Load configuration</span>
<span class="w">    </span><span class="nx">a</span><span class="p">.</span><span class="nx">ConfigObject</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">utils</span><span class="p">.</span><span class="nx">InitConfig</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 2. Initialize database sessions</span>
<span class="w">    </span><span class="nx">a</span><span class="p">.</span><span class="nx">InitMongoSession</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">ConfigObject</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 3. Initialize access token map</span>
<span class="w">    </span><span class="nx">a</span><span class="p">.</span><span class="nx">AccessTokenHashMap</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">int64</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 4. Setup HTTP router</span>
<span class="w">    </span><span class="nx">a</span><span class="p">.</span><span class="nx">Router</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">mux</span><span class="p">.</span><span class="nx">NewRouter</span><span class="p">()</span>
<span class="w">    </span><span class="nx">a</span><span class="p">.</span><span class="nx">initializeRoutes</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 5. Initialize Docker client</span>
<span class="w">    </span><span class="nx">cli</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">NewEnvClient</span><span class="p">()</span>
<span class="w">    </span><span class="nx">a</span><span class="p">.</span><span class="nx">DockerNodeID</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">docker</span><span class="p">.</span><span class="nx">GetNodeID</span><span class="p">(</span><span class="nx">cli</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 6. Start background services</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">CacheHealthCheck</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="nx">counter</span><span class="p">.</span><span class="nx">SetMaxActiveTasksUtilsCount</span><span class="p">(</span><span class="nx">cli</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="p">.</span><span class="nx">ConfigObject</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 7. Update playbook status on startup</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">controllers</span><span class="p">.</span><span class="nx">UpdatePlaybookStatus</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">ConfigObject</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="3-class-diagrams">3. Class Diagrams</h2>
<h3 id="31-playbook-execution-model">3.1 Playbook Execution Model</h3>
<div class="mermaid">
classDiagram
    class PlaybookExecutionController {
        +PlayBookTasksMap map[int]PlayBookTask
        +MapMutex sync.RWMutex
        +TenantCode string
        +CaseID string
        +PlaybookExecutionID string
        +UserID int
        +UserName string
        +AccessToken string
        +JwtToken string
        +IndicatorValue string
        +Completed bool
        +Stopped bool
        +RunSelectedPlaybook() error
        +ReadAndRunPlayBook() error
        +ProcessAndExecuteTask() error
        +WriteTaskMap(int, PlayBookTask)
        +ReadTaskMap(int) PlayBookTask
        +GetCompletionStatus() bool
        +SetCompletionStatus(bool)
        +GetStopStatus() bool
        +SetStopStatus(bool)
    }
    class PlayBookTask {
        +TaskID int
        +TaskSeq int
        +Type string
        +TaskName string
        +TaskTag string
        +InputFields []Inputfields
        +NextTask Object
        +PrevTask Object
        +Conditions []PlayBookCondition
        +ConditionOperator string
        +NextTaskOnTrue Object
        +NextTaskOnFalse Object
        +PEID string
        +TenantCode string
        +PlayBookName string
        +IsFirstTask bool
        +Status string
        +HasFlowControl bool
        +ConditionResult bool
        +GetTaskData() error
        +UpdatePlayBookErrorStatus() error
        +UpdatePlayBookExecutionStatus() error
        +CreateFailedTaskEntry() error
    }
    class PlaybookObject {
        +ID int
        +Name string
        +Description string
        +Definition string
        +ChartDefinition string
        +TenantCode string
        +CategoryID int
        +Status string
        +IsParallelPlaybook bool
        +TotalTasksCount int
        +GetPlaybookData() error
        +ImportPlaybook2() error
        +CreateImportedPlaybook() error
    }
    PlaybookExecutionController --> PlayBookTask : manages
    PlayBookTask --> PlaybookObject : executes
</div>

<h3 id="32-task-execution-model">3.2 Task Execution Model</h3>
<div class="mermaid">
classDiagram
    class TaskRequest {
        +TaskObjectID primitive.ObjectID
        +TaskRequestID string
        +TaskID int
        +UserID int
        +PEID string
        +TaskSeq int
        +Input string
        +Response string
        +Processed string
        +CreatedDate int64
        +UpdatedDate int64
        +TasksTag string
        +TenantCode string
        +AlertID int
        +Status string
        +ExecutionStatus string
        +CreateTaskRequest() error
    }
    class TaskResponse {
        +TaskResponseID int
        +TaskRequestID string
        +Response string
        +TenantCode string
        +CreatedDate int64
        +ApprovalStatus string
        +PlaybookName string
    }
    class ActiveInstanceObject {
        +InstanceID int
        +IntegrationID int64
        +TenantCode string
        +Title string
        +Status string
        +Fields Object
        +FieldsMap map[string]Object
        +CredentialsID int
        +BaseURL string
        +IsCustomApp bool
    }
    TaskRequest --> TaskResponse : generates
    TaskRequest --> ActiveInstanceObject : uses
</div>

<h3 id="33-filter-transform-model">3.3 Filter &amp; Transform Model</h3>
<div class="mermaid">
classDiagram
    class Inputfields {
        +Name string
        +Label string
        +Type string
        +ID string
        +Required bool
        +MaxLength int
        +Value Object
        +Host string
        +Filters []Filter
        +Transformers []Transformer
        +Item string
    }
    class Filter {
        +Field string
        +ConditionTag string
        +Value Object
    }
    class Transformer {
        +Name string
        +Data Object
        +Filter Object
    }
    class FilterTransformService {
        +TransformValues() Object
        +VerifyFilterCondition() bool
        +GetFieldValue() Object
        +MatchCondition() bool
    }
    Inputfields --> Filter : contains
    Inputfields --> Transformer : contains
    FilterTransformService --> Inputfields : processes
</div>

<hr />
<h2 id="4-sequence-diagrams">4. Sequence Diagrams</h2>
<h3 id="41-playbook-execution-flow">4.1 Playbook Execution Flow</h3>
<div class="mermaid">
sequenceDiagram
    participant Client
    participant Router
    participant Controller
    participant ExecutionController
    participant TaskExecutor
    participant Database
    participant ExternalSystem
    Client->>Router: POST /runplaybook/
    Router->>Controller: Route request
    Controller->>ExecutionController: RunSelectedPlaybook()
    ExecutionController->>Database: Get playbook definition
    Database-->>ExecutionController: Playbook data
    ExecutionController->>ExecutionController: ReadAndRunPlayBook()
    ExecutionController->>Database: Create execution entry
    loop For each task
        ExecutionController->>TaskExecutor: ProcessAndExecuteTask()
        TaskExecutor->>Database: Get task configuration
        TaskExecutor->>ExternalSystem: Execute task
        ExternalSystem-->>TaskExecutor: Task response
        TaskExecutor->>Database: Save task response
        TaskExecutor-->>ExecutionController: Task completed
    end
    ExecutionController->>Database: Update execution status
    ExecutionController-->>Controller: Execution complete
    Controller-->>Router: Response
    Router-->>Client: Final response
</div>

<h3 id="42-task-execution-with-conditions">4.2 Task Execution with Conditions</h3>
<div class="mermaid">
sequenceDiagram
    participant ExecutionController
    participant ConditionProcessor
    participant TaskExecutor
    participant FilterEngine
    participant Database

    ExecutionController->>ConditionProcessor: ProcessConditionTask()
    ConditionProcessor->>FilterEngine: EvaluateConditions()

    loop For each condition
        FilterEngine->>Database: Get case data
        Database-->>FilterEngine: Field values
        FilterEngine->>FilterEngine: MatchCondition()
    end
    FilterEngine-->>ConditionProcessor: Condition result

    alt Condition true
        ConditionProcessor->>TaskExecutor: Execute NextTaskOnTrue
    else Condition false
        ConditionProcessor->>TaskExecutor: Execute NextTaskOnFalse
    end
    TaskExecutor-->>ExecutionController: Continue execution
</div>

<h3 id="43-error-handling-flow">4.3 Error Handling Flow</h3>
<div class="mermaid">
sequenceDiagram
    participant TaskExecutor
    participant ErrorHandler
    participant Database
    participant NotificationService
    TaskExecutor->>TaskExecutor: Execute task

    alt Task fails
        TaskExecutor->>ErrorHandler: HandleTaskError()
        ErrorHandler->>Database: Log error details
        ErrorHandler->>Database: Update execution status
        ErrorHandler->>NotificationService: Send failure notification
        alt Recoverable error
            ErrorHandler->>TaskExecutor: Retry with backoff
        else Non-recoverable error
            ErrorHandler->>Database: Mark execution as failed
        end
    end
</div>

<hr />
<h2 id="5-database-schema">5. Database Schema</h2>
<h3 id="51-mongodb-collections-schema">5.1 MongoDB Collections Schema</h3>
<h4 id="511-playbook-collection">5.1.1 Playbook Collection</h4>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1001</span><span class="p">,</span><span class="w">                           </span><span class="c1">// Auto-increment ID</span>
<span class="w">  </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Malware Response Playbook&quot;</span><span class="p">,</span><span class="w">   </span><span class="c1">// Unique per tenant</span>
<span class="w">  </span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Automated malware response workflow&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1.0.0&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;definition&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span><span class="w">                   </span><span class="c1">// JSON string of task definitions</span>
<span class="w">  </span><span class="s2">&quot;chart_definition&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span><span class="w">             </span><span class="c1">// Visual representation</span>
<span class="w">  </span><span class="s2">&quot;tenant_code&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;category_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;active&quot;</span><span class="p">,</span><span class="w">                    </span><span class="c1">// active, draft, archived</span>
<span class="w">  </span><span class="s2">&quot;created_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1694443200000</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;updated_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1694443200000</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;user_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1001</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;group_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;case&quot;</span><span class="p">,</span><span class="w">                        </span><span class="c1">// case, indicator</span>
<span class="w">  </span><span class="s2">&quot;filename&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1001_tenant123.json&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;commit_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;abc123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;list_names&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;suspicious_ips&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;malware_domains&quot;</span><span class="p">],</span>
<span class="w">  </span><span class="s2">&quot;all_nodes_connected&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;yes&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;custom_utils_added&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;custom_utils_names&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">  </span><span class="s2">&quot;vertical_pb&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;is_parallel_playbook&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;total_tasks_count&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">15</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;total_utils_count&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;shard_bucket&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w">                      </span><span class="c1">// For sharding</span>
<span class="p">}</span>
<span class="c1">// Indexes</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">playbook_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;tenant_code&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="nx">unique</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">playbook_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;tenant_code&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">playbook_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;category_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">playbook_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;shard_bucket&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">})</span>
</code></pre></div>

<h4 id="512-playbook-execution-collection">5.1.2 Playbook Execution Collection</h4>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pb_exec_123456&quot;</span><span class="p">,</span><span class="w">                </span><span class="c1">// Execution ID</span>
<span class="w">  </span><span class="s2">&quot;parent_playbook_execution_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pb_exec_123455&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;pid&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1001</span><span class="p">,</span><span class="w">                           </span><span class="c1">// Playbook ID</span>
<span class="w">  </span><span class="s2">&quot;uid&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2001</span><span class="p">,</span><span class="w">                           </span><span class="c1">// User ID</span>
<span class="w">  </span><span class="s2">&quot;request_data&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span><span class="w">                 </span><span class="c1">// Original request</span>
<span class="w">  </span><span class="s2">&quot;tenant_code&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;alert_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">50001</span><span class="p">,</span><span class="w">                     </span><span class="c1">// Case/Incident ID</span>
<span class="w">  </span><span class="s2">&quot;is_evidence&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;n&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;created_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1694443200000</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;active&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;execution_status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;inprogress&quot;</span><span class="p">,</span><span class="w">      </span><span class="c1">// inprogress, completed, failed, stopped</span>
<span class="w">  </span><span class="s2">&quot;execution_completion_time&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1694443500000</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;execution_error_msg&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;execution_error_path&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;username&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;security_analyst&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;indicator&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;playbook_stopped_manually&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;stop_playbook_data&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;sub_playbook_execution_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pb_exec_sub_001&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s2">&quot;last_executed_task_seq&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;total_tasks_count&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">15</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;total_utils_count&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;playbook_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Malware Response&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;playbook_runtime&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">45000</span><span class="p">,</span><span class="w">             </span><span class="c1">// milliseconds</span>
<span class="w">  </span><span class="s2">&quot;source&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;ui&quot;</span><span class="p">,</span><span class="w">                        </span><span class="c1">// ui, api, scheduled</span>
<span class="w">  </span><span class="s2">&quot;node_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;docker_node_1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;shard_bucket&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="p">}</span>
<span class="c1">// Indexes</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">playbook_execution_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;tenant_code&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;alert_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">playbook_execution_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;execution_status&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;created_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">playbook_execution_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;uid&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;created_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="o">-</span><span class="mf">1</span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">playbook_execution_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;shard_bucket&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">})</span>
</code></pre></div>

<h4 id="513-task-execution-collection">5.1.3 Task Execution Collection</h4>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;task_request_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;task_req_789012&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;description&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Block malicious IP&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;logo_path&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;lib/logo/firewall.png&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;tenant_code&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;tenant123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Block IP Address&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;app_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Palo Alto Firewall&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;task_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">301</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;user_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">2001</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;username&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;security_analyst&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span><span class="w">                        </span><span class="c1">// Serialized input data</span>
<span class="w">  </span><span class="s2">&quot;processed&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;y&quot;</span><span class="p">,</span><span class="w">                      </span><span class="c1">// y, n</span>
<span class="w">  </span><span class="s2">&quot;created_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1694443200000</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;updated_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1694443300000</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;tasks_tag&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;palo_alto_block_ip&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;rest_url&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;https://firewall.api/block&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;method&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;alert_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">50001</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;integration_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">15</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;instance_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">150</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;task_handler&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;palo_alto&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;response&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span><span class="w">                     </span><span class="c1">// Serialized response</span>
<span class="w">  </span><span class="s2">&quot;is_demo&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;peid&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pb_exec_123456&quot;</span><span class="p">,</span><span class="w">              </span><span class="c1">// Playbook execution ID</span>
<span class="w">  </span><span class="s2">&quot;task_peid&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="w">                       </span><span class="c1">// Sub-playbook execution ID</span>
<span class="w">  </span><span class="s2">&quot;task_seq&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;is_condition&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;n&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;task_condition&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;condition_operator&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;is_evidence&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;n&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;completed&quot;</span><span class="p">,</span><span class="w">                 </span><span class="c1">// not_started, inprogress, completed, failed</span>
<span class="w">  </span><span class="s2">&quot;playbook_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1001&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;instance_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Production Firewall&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;indicator_type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;ip&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;task_response_time_stamp&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1694443300000</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;reputation&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;malicious&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;category&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;network_security&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;function_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;block_ip_address&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;filename&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;palo_alto_tasks.py&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;credentials_required&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;task_operator_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;op_001&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;indicator&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;case_description&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Malware infection detected&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;integration&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;command&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;generic&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;headers&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;Content-Type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="s2">&quot;Authorization&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Bearer token123&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s2">&quot;content_type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;request_body&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;request_type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;task_type&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;blocking&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;custom_task_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;playbook_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Malware Response&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;node_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;docker_node_1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;iterate_task&quot;</span><span class="o">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;iteration_config&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;execution_status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;completed&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;shard_bucket&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span>
<span class="p">}</span>
<span class="c1">// Indexes</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">task_execution_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;peid&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;task_seq&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">task_execution_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;tenant_code&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;alert_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">task_execution_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;processed&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;created_date&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">task_execution_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;shard_bucket&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">})</span>
</code></pre></div>

<h4 id="514-stopped-tasks-collection">5.1.4 Stopped Tasks Collection</h4>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="s2">&quot;_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="nx">ObjectId</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;case_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;50001&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;peid&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;pb_exec_123456&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;task_seq&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;routine&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;MAIN&quot;</span><span class="p">,</span><span class="w">                     </span><span class="c1">// MAIN, SUB</span>
<span class="w">  </span><span class="s2">&quot;task_name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Block IP Address&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;stopped&quot;</span><span class="w">                    </span><span class="c1">// stopped, resumed</span>
<span class="p">}</span>
<span class="c1">// Indexes</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">stopped_tasks_collection</span><span class="p">.</span><span class="nx">createIndex</span><span class="p">({</span><span class="s2">&quot;peid&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;case_id&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;status&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">})</span>
</code></pre></div>

<h3 id="52-data-relationships">5.2 Data Relationships</h3>
<div class="mermaid">
erDiagram
    PLAYBOOK_COLLECTION ||--o{ PLAYBOOK_EXECUTION_COLLECTION : executes
    PLAYBOOK_EXECUTION_COLLECTION ||--o{ TASK_EXECUTION_COLLECTION : contains
    PLAYBOOK_EXECUTION_COLLECTION ||--o{ STOPPED_TASKS_COLLECTION : may_have
    INCIDENTS_COLLECTION ||--o{ PLAYBOOK_EXECUTION_COLLECTION : triggers
    TASK_COLLECTION ||--o{ TASK_EXECUTION_COLLECTION : defines
    INTEGRATION_COLLECTION ||--o{ TASK_EXECUTION_COLLECTION : provides
    INSTANCE_COLLECTION ||--o{ TASK_EXECUTION_COLLECTION : executes_on
</div>

<hr />
<h2 id="6-api-specifications">6. API Specifications</h2>
<h3 id="61-playbook-management-apis">6.1 Playbook Management APIs</h3>
<h4 id="611-create-playbook">6.1.1 Create Playbook</h4>
<div class="highlight"><pre><span></span><code><span class="err">POST /createplaybook/</span>
<span class="err">Content-Type: application/json</span>
<span class="err">Authorization: Bearer {jwt_token}</span>

<span class="err">Request Body:</span>
<span class="err">{</span>
<span class="err">  &quot;name&quot;: &quot;Malware Response Playbook&quot;,</span>
<span class="err">  &quot;description&quot;: &quot;Automated response to malware incidents&quot;,</span>
<span class="err">  &quot;definition&quot;: &quot;...&quot;,                    // JSON string</span>
<span class="err">  &quot;chart_definition&quot;: &quot;...&quot;,              // Visual representation</span>
<span class="err">  &quot;category_id&quot;: 5,</span>
<span class="err">  &quot;type&quot;: &quot;case&quot;,</span>
<span class="err">  &quot;tenant_code&quot;: &quot;tenant123&quot;,</span>
<span class="err">  &quot;user_id&quot;: 1001,</span>
<span class="err">  &quot;version&quot;: &quot;1.0.0&quot;,</span>
<span class="err">  &quot;is_parallel_playbook&quot;: true,</span>
<span class="err">  &quot;total_tasks_count&quot;: 15,</span>
<span class="err">  &quot;total_utils_count&quot;: 3</span>
<span class="err">}</span>

<span class="err">Response:</span>
<span class="err">{</span>
<span class="err">  &quot;success&quot;: true,</span>
<span class="err">  &quot;data&quot;: {</span>
<span class="err">    &quot;playbook_id&quot;: 1001,</span>
<span class="err">    &quot;filename&quot;: &quot;1001_tenant123.json&quot;,</span>
<span class="err">    &quot;commit_id&quot;: &quot;abc123&quot;</span>
<span class="err">  },</span>
<span class="err">  &quot;error&quot;: &quot;&quot;,</span>
<span class="err">  &quot;displayMessage&quot;: &quot;Playbook created successfully&quot;,</span>
<span class="err">  &quot;time&quot;: 1694443200000</span>
<span class="err">}</span>
<span class="err">Validation Rules:</span>
<span class="err">- name: Required, max 255 chars, unique per tenant</span>
<span class="err">- description: Optional, max 1000 chars</span>
<span class="err">- definition: Required, valid JSON</span>
<span class="err">- category_id: Required, must exist</span>
<span class="err">- type: Required, enum [case, indicator]</span>
<span class="err">- tenant_code: Required, valid tenant</span>
<span class="err">- user_id: Required, valid user</span>
</code></pre></div>

<h4 id="612-run-playbook">6.1.2 Run Playbook</h4>
<div class="highlight"><pre><span></span><code><span class="err">POST /runplaybook/</span>
<span class="err">Content-Type: application/json</span>
<span class="err">Authorization: Bearer {jwt_token}</span>

<span class="err">Request Body:</span>
<span class="err">{</span>
<span class="err">  &quot;tenantcode&quot;: &quot;tenant123&quot;,</span>
<span class="err">  &quot;playbook_name&quot;: &quot;Malware Response Playbook&quot;,</span>
<span class="err">  &quot;case_id&quot;: &quot;50001&quot;,</span>
<span class="err">  &quot;is_bot&quot;: &quot;false&quot;,</span>
<span class="err">  &quot;uid&quot;: &quot;1001&quot;,</span>
<span class="err">  &quot;username&quot;: &quot;security_analyst&quot;,</span>
<span class="err">  &quot;type&quot;: &quot;case&quot;,</span>
<span class="err">  &quot;indicator&quot;: &quot;192.168.1.100&quot;,</span>
<span class="err">  &quot;playbook_execution_id&quot;: &quot;&quot;,           // For resume</span>
<span class="err">  &quot;resume_playbook&quot;: &quot;false&quot;</span>
<span class="err">}</span>
<span class="err">Response:</span>
<span class="err">{</span>
<span class="err">  &quot;success&quot;: true,</span>
<span class="err">  &quot;data&quot;: {</span>
<span class="err">    &quot;playbook_execution_id&quot;: &quot;pb_exec_123456&quot;,</span>
<span class="err">    &quot;status&quot;: &quot;inprogress&quot;,</span>
<span class="err">    &quot;total_tasks&quot;: 15,</span>
<span class="err">    &quot;estimated_duration&quot;: 300000         // milliseconds</span>
<span class="err">  },</span>
<span class="err">  &quot;error&quot;: &quot;&quot;,</span>
<span class="err">  &quot;displayMessage&quot;: &quot;Playbook execution started&quot;,</span>
<span class="err">  &quot;time&quot;: 1694443200000</span>
<span class="err">}</span>

<span class="err">Validation Rules:</span>
<span class="err">- tenantcode: Required, valid tenant</span>
<span class="err">- playbook_name: Required, must exist and be active</span>
<span class="err">- case_id: Required for type=case</span>
<span class="err">- uid: Required, valid user</span>
<span class="err">- type: Required, enum [case, indicator]</span>
<span class="err">- indicator: Required for type=indicator</span>
</code></pre></div>

<h3 id="62-task-management-apis">6.2 Task Management APIs</h3>
<h4 id="621-run-single-task">6.2.1 Run Single Task</h4>
<div class="highlight"><pre><span></span><code><span class="err">POST /runtask/</span>
<span class="err">Content-Type: application/json</span>
<span class="err">Authorization: Bearer {jwt_token}</span>

<span class="err">Request Body:</span>
<span class="err">{</span>
<span class="err">  &quot;task_id&quot;: 301,</span>
<span class="err">  &quot;tenant_code&quot;: &quot;tenant123&quot;,</span>
<span class="err">  &quot;case_id&quot;: 50001,</span>
<span class="err">  &quot;user_id&quot;: 1001,</span>
<span class="err">  &quot;input_fields&quot;: [</span>
<span class="err">    {</span>
<span class="err">      &quot;name&quot;: &quot;ip_address&quot;,</span>
<span class="err">      &quot;value&quot;: &quot;192.168.1.100&quot;,</span>
<span class="err">      &quot;type&quot;: &quot;string&quot;</span>
<span class="err">    }</span>
<span class="err">  ],</span>
<span class="err">  &quot;instance_id&quot;: 150,</span>
<span class="err">  &quot;is_demo&quot;: false</span>
<span class="err">}</span>
<span class="err">Response:</span>
<span class="err">{</span>
<span class="err">  &quot;success&quot;: true,</span>
<span class="err">  &quot;data&quot;: {</span>
<span class="err">    &quot;task_request_id&quot;: &quot;task_req_789012&quot;,</span>
<span class="err">    &quot;status&quot;: &quot;inprogress&quot;</span>
<span class="err">  },</span>
<span class="err">  &quot;error&quot;: &quot;&quot;,</span>
<span class="err">  &quot;displayMessage&quot;: &quot;Task execution started&quot;,</span>
<span class="err">  &quot;time&quot;: 1694443200000</span>
<span class="err">}</span>
</code></pre></div>

<h3 id="63-error-response-format">6.3 Error Response Format</h3>
<div class="highlight"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;success&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Invalid playbook configuration&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;displayMessage&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;The playbook contains invalid task definitions&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;errorPath&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;ExecutionController.ProcessAndExecuteTask&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;failed&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1694443200000</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="7-algorithm-specifications">7. Algorithm Specifications</h2>
<h3 id="71-parallel-task-execution-algorithm">7.1 Parallel Task Execution Algorithm</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">executionController</span><span class="w"> </span><span class="o">*</span><span class="nx">PlaybookExecutionController</span><span class="p">)</span><span class="w"> </span><span class="nx">executeParallelTasks</span><span class="p">(</span>
<span class="w">    </span><span class="nx">tasks</span><span class="w"> </span><span class="p">[]</span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span><span class="p">,</span>
<span class="w">    </span><span class="nx">dockerNodeID</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">mongodbSession</span><span class="w"> </span><span class="nx">mongo_driver</span><span class="p">.</span><span class="nx">MongoClientWrapper</span><span class="p">,</span>
<span class="w">    </span><span class="nx">coreMongodbSession</span><span class="w"> </span><span class="nx">mongo_driver</span><span class="p">.</span><span class="nx">MongoClientWrapper</span><span class="p">,</span>
<span class="w">    </span><span class="nx">configObject</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">ConfigStruct</span><span class="p">,</span>
<span class="w">    </span><span class="nx">dbSession</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">common</span><span class="p">.</span><span class="nx">SessionStruct</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">wg</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">mutex</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="w">    </span><span class="nx">errorChan</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">tasks</span><span class="p">))</span>
<span class="w">    </span><span class="nx">panicChan</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">tasks</span><span class="p">))</span>
<span class="w">    </span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Create stop lookup channel</span>
<span class="w">    </span><span class="nx">stopLookup</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">lookupWg</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="w">    </span><span class="nx">lookupWg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Start stop lookup goroutine</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="nx">lookupWg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
<span class="w">        </span><span class="nx">ticker</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">NewTicker</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="nx">ticker</span><span class="p">.</span><span class="nx">Stop</span><span class="p">()</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">stopLookup</span><span class="p">:</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
<span class="w">                </span><span class="c1">// Check if playbook should be stopped</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">executionController</span><span class="p">.</span><span class="nx">checkStopCondition</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">cancel</span><span class="p">()</span>
<span class="w">                    </span><span class="k">return</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}()</span>

<span class="w">    </span><span class="c1">// Execute tasks in parallel</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">tasks</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">taskIndex</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">defer</span><span class="w"> </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>
<span class="w">            </span><span class="k">defer</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">recover</span><span class="p">();</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">panicChan</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">r</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}()</span>

<span class="w">            </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">                </span><span class="c1">// Context cancelled, stop execution</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="k">default</span><span class="p">:</span>
<span class="w">                </span><span class="c1">// Execute task</span>
<span class="w">                </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">executionController</span><span class="p">.</span><span class="nx">ProcessAndExecuteTask</span><span class="p">(</span>
<span class="w">                    </span><span class="nx">t</span><span class="p">.</span><span class="nx">TaskSeq</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">dockerNodeID</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">mongodbSession</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">coreMongodbSession</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">configObject</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">dbSession</span><span class="p">,</span>
<span class="w">                    </span><span class="o">&amp;</span><span class="nx">wg</span><span class="p">,</span>
<span class="w">                    </span><span class="s">&quot;PARALLEL&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">ctx</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">panicChan</span><span class="p">,</span>
<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">mutex</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">                    </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">case</span><span class="w"> </span><span class="nx">errorChan</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">err</span><span class="p">:</span>
<span class="w">                    </span><span class="k">default</span><span class="p">:</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                    </span><span class="nx">mutex</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nx">t</span><span class="p">.</span><span class="nx">StopOnError</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nx">cancel</span><span class="p">()</span><span class="w"> </span><span class="c1">// Stop all parallel tasks</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}(</span><span class="nx">i</span><span class="p">,</span><span class="w"> </span><span class="nx">task</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Wait for all tasks to complete</span>
<span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Stop the lookup goroutine</span>
<span class="w">    </span><span class="nb">close</span><span class="p">(</span><span class="nx">stopLookup</span><span class="p">)</span>
<span class="w">    </span><span class="nx">lookupWg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Check for errors</span>
<span class="w">    </span><span class="nb">close</span><span class="p">(</span><span class="nx">errorChan</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">errorChan</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Check for panics</span>
<span class="w">    </span><span class="nb">close</span><span class="p">(</span><span class="nx">panicChan</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">panic</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">panicChan</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">panic</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;panic in task execution: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">panic</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="72-condition-evaluation-algorithm">7.2 Condition Evaluation Algorithm</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">cc</span><span class="w"> </span><span class="o">*</span><span class="nx">ConditionController</span><span class="p">)</span><span class="w"> </span><span class="nx">evaluateConditions</span><span class="p">(</span>
<span class="w">    </span><span class="nx">conditions</span><span class="w"> </span><span class="p">[]</span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookCondition</span><span class="p">,</span>
<span class="w">    </span><span class="nx">conditionOperator</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alertData</span><span class="w"> </span><span class="nx">models</span><span class="p">.</span><span class="nx">RunPlayBookRequest2</span><span class="p">,</span>
<span class="w">    </span><span class="nx">executedConditions</span><span class="w"> </span><span class="p">[]</span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">ExecutedConditionStatus</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">conditions</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="p">[]</span><span class="kt">bool</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">condition</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">conditions</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cc</span><span class="p">.</span><span class="nx">evaluateSingleCondition</span><span class="p">(</span>
<span class="w">            </span><span class="nx">condition</span><span class="p">,</span>
<span class="w">            </span><span class="nx">alertData</span><span class="p">,</span>
<span class="w">            </span><span class="nx">executedConditions</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">results</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Apply logical operator</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">ToLower</span><span class="p">(</span><span class="nx">conditionOperator</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;and&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">cc</span><span class="p">.</span><span class="nx">applyAndOperator</span><span class="p">(</span><span class="nx">results</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;or&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">cc</span><span class="p">.</span><span class="nx">applyOrOperator</span><span class="p">(</span><span class="nx">results</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="k">default</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;unsupported condition operator: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">conditionOperator</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">cc</span><span class="w"> </span><span class="o">*</span><span class="nx">ConditionController</span><span class="p">)</span><span class="w"> </span><span class="nx">evaluateSingleCondition</span><span class="p">(</span>
<span class="w">    </span><span class="nx">condition</span><span class="w"> </span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookCondition</span><span class="p">,</span>
<span class="w">    </span><span class="nx">alertData</span><span class="w"> </span><span class="nx">models</span><span class="p">.</span><span class="nx">RunPlayBookRequest2</span><span class="p">,</span>
<span class="w">    </span><span class="nx">executedConditions</span><span class="w"> </span><span class="p">[]</span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">ExecutedConditionStatus</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get field value from case data or previous task response</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">fieldValue</span><span class="w"> </span><span class="kd">interface</span><span class="p">{}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">condition</span><span class="p">.</span><span class="nx">ConditionKeyValue</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Static value condition</span>
<span class="w">        </span><span class="nx">fieldValue</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">condition</span><span class="p">.</span><span class="nx">ConditionKeyValue</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">condition</span><span class="p">.</span><span class="nx">TaskName</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Previous task response condition</span>
<span class="w">        </span><span class="nx">fieldValue</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">cc</span><span class="p">.</span><span class="nx">getPreviousTaskResponse</span><span class="p">(</span>
<span class="w">            </span><span class="nx">condition</span><span class="p">.</span><span class="nx">TaskName</span><span class="p">,</span>
<span class="w">            </span><span class="nx">condition</span><span class="p">.</span><span class="nx">ConditionKey</span><span class="p">,</span>
<span class="w">            </span><span class="nx">executedConditions</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Case field condition</span>
<span class="w">        </span><span class="nx">fieldValue</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">utils</span><span class="p">.</span><span class="nx">GetFieldValue</span><span class="p">(</span><span class="nx">alertData</span><span class="p">,</span><span class="w"> </span><span class="nx">condition</span><span class="p">.</span><span class="nx">ConditionKey</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Evaluate condition</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">utils</span><span class="p">.</span><span class="nx">MatchCondition</span><span class="p">(</span>
<span class="w">        </span><span class="nx">fieldValue</span><span class="p">,</span>
<span class="w">        </span><span class="nx">condition</span><span class="p">.</span><span class="nx">ConditionType</span><span class="p">,</span>
<span class="w">        </span><span class="nx">condition</span><span class="p">.</span><span class="nx">ConditionValue</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">cc</span><span class="w"> </span><span class="o">*</span><span class="nx">ConditionController</span><span class="p">)</span><span class="w"> </span><span class="nx">applyAndOperator</span><span class="p">(</span><span class="nx">results</span><span class="w"> </span><span class="p">[]</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">result</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">cc</span><span class="w"> </span><span class="o">*</span><span class="nx">ConditionController</span><span class="p">)</span><span class="w"> </span><span class="nx">applyOrOperator</span><span class="p">(</span><span class="nx">results</span><span class="w"> </span><span class="p">[]</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="73-cache-management-algorithm">7.3 Cache Management Algorithm</h3>
<div class="highlight"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">CacheManager</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">redisClient</span><span class="w">   </span><span class="o">*</span><span class="nx">redis</span><span class="p">.</span><span class="nx">Client</span>
<span class="w">    </span><span class="nx">localCache</span><span class="w">    </span><span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span>
<span class="w">    </span><span class="nx">ttlMap</span><span class="w">        </span><span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span>
<span class="w">    </span><span class="nx">mutex</span><span class="w">         </span><span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
<span class="w">    </span><span class="nx">cleanupTicker</span><span class="w"> </span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Ticker</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">cm</span><span class="w"> </span><span class="o">*</span><span class="nx">CacheManager</span><span class="p">)</span><span class="w"> </span><span class="nx">Get</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// Check local cache first</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">localCache</span><span class="p">.</span><span class="nx">Load</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Check TTL</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ttl</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">ttlMap</span><span class="p">.</span><span class="nx">Load</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">()</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">ttl</span><span class="p">.(</span><span class="kt">int64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">cm</span><span class="p">.</span><span class="nx">localCache</span><span class="p">.</span><span class="nx">Delete</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="w">                </span><span class="nx">cm</span><span class="p">.</span><span class="nx">ttlMap</span><span class="p">.</span><span class="nx">Delete</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Fall back to Redis</span>
<span class="w">    </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">redisClient</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">Result</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Parse and cache locally</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="kd">interface</span><span class="p">{}</span>
<span class="w">    </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">result</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">value</span><span class="p">)</span>
<span class="w">    </span><span class="nx">cm</span><span class="p">.</span><span class="nx">localCache</span><span class="p">.</span><span class="nx">Store</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">cm</span><span class="w"> </span><span class="o">*</span><span class="nx">CacheManager</span><span class="p">)</span><span class="w"> </span><span class="nx">Set</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="nx">ttl</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// Store in local cache</span>
<span class="w">    </span><span class="nx">cm</span><span class="p">.</span><span class="nx">localCache</span><span class="p">.</span><span class="nx">Store</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ttl</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">expiryTime</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="nx">ttl</span><span class="p">).</span><span class="nx">Unix</span><span class="p">()</span>
<span class="w">        </span><span class="nx">cm</span><span class="p">.</span><span class="nx">ttlMap</span><span class="p">.</span><span class="nx">Store</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">expiryTime</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Store in Redis</span>
<span class="w">    </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">redisClient</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">ttl</span><span class="p">).</span><span class="nx">Err</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">cm</span><span class="w"> </span><span class="o">*</span><span class="nx">CacheManager</span><span class="p">)</span><span class="w"> </span><span class="nx">startCleanupRoutine</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cm</span><span class="p">.</span><span class="nx">cleanupTicker</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">NewTicker</span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">)</span>

<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">cleanupTicker</span><span class="p">.</span><span class="nx">C</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">now</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">()</span>
<span class="w">            </span><span class="nx">cm</span><span class="p">.</span><span class="nx">ttlMap</span><span class="p">.</span><span class="nx">Range</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">now</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">value</span><span class="p">.(</span><span class="kt">int64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">cm</span><span class="p">.</span><span class="nx">localCache</span><span class="p">.</span><span class="nx">Delete</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="w">                    </span><span class="nx">cm</span><span class="p">.</span><span class="nx">ttlMap</span><span class="p">.</span><span class="nx">Delete</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}()</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="8-configuration-management">8. Configuration Management</h2>
<h3 id="81-configuration-structure">8.1 Configuration Structure</h3>
<div class="highlight"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">ConfigStruct</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">DatabaseConfig</span><span class="w">    </span><span class="nx">DatabaseConfig</span><span class="w">    </span><span class="s">`json:&quot;database&quot;`</span>
<span class="w">    </span><span class="nx">RedisConfig</span><span class="w">       </span><span class="nx">RedisConfig</span><span class="w">       </span><span class="s">`json:&quot;redis&quot;`</span>
<span class="w">    </span><span class="nx">DockerConfig</span><span class="w">      </span><span class="nx">DockerConfig</span><span class="w">      </span><span class="s">`json:&quot;docker&quot;`</span>
<span class="w">    </span><span class="nx">SecurityConfig</span><span class="w">    </span><span class="nx">SecurityConfig</span><span class="w">    </span><span class="s">`json:&quot;security&quot;`</span>
<span class="w">    </span><span class="nx">LoggingConfig</span><span class="w">     </span><span class="nx">LoggingConfig</span><span class="w">     </span><span class="s">`json:&quot;logging&quot;`</span>
<span class="w">    </span><span class="nx">IntegrationConfig</span><span class="w"> </span><span class="nx">IntegrationConfig</span><span class="w"> </span><span class="s">`json:&quot;integration&quot;`</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">DatabaseConfig</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">MongoURI</span><span class="w">        </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;mongo_uri&quot;`</span>
<span class="w">    </span><span class="nx">DatabaseName</span><span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;database_name&quot;`</span>
<span class="w">    </span><span class="nx">MaxPoolSize</span><span class="w">     </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;max_pool_size&quot;`</span>
<span class="w">    </span><span class="nx">MinPoolSize</span><span class="w">     </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;min_pool_size&quot;`</span>
<span class="w">    </span><span class="nx">MaxIdleTime</span><span class="w">     </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;max_idle_time&quot;`</span>
<span class="w">    </span><span class="nx">ConnectTimeout</span><span class="w">  </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;connect_timeout&quot;`</span>
<span class="w">    </span><span class="nx">ShardBucketCount</span><span class="w"> </span><span class="kt">int</span><span class="w">   </span><span class="s">`json:&quot;shard_bucket_count&quot;`</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">RedisConfig</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Host</span><span class="w">            </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;host&quot;`</span>
<span class="w">    </span><span class="nx">Port</span><span class="w">            </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;port&quot;`</span>
<span class="w">    </span><span class="nx">Password</span><span class="w">        </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;password&quot;`</span>
<span class="w">    </span><span class="nx">Database</span><span class="w">        </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;database&quot;`</span>
<span class="w">    </span><span class="nx">MaxRetries</span><span class="w">      </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;max_retries&quot;`</span>
<span class="w">    </span><span class="nx">PoolSize</span><span class="w">        </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;pool_size&quot;`</span>
<span class="w">    </span><span class="nx">IdleTimeout</span><span class="w">     </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;idle_timeout&quot;`</span>
<span class="p">}</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">SecurityConfig</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">JWTSecret</span><span class="w">           </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;jwt_secret&quot;`</span>
<span class="w">    </span><span class="nx">SessionTimeout</span><span class="w">      </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;session_timeout&quot;`</span>
<span class="w">    </span><span class="nx">MaxLoginAttempts</span><span class="w">    </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;max_login_attempts&quot;`</span>
<span class="w">    </span><span class="nx">PasswordComplexity</span><span class="w">  </span><span class="kt">bool</span><span class="w">   </span><span class="s">`json:&quot;password_complexity&quot;`</span>
<span class="w">    </span><span class="nx">EncryptionKey</span><span class="w">       </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;encryption_key&quot;`</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="82-environment-based-configuration">8.2 Environment-Based Configuration</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">LoadConfiguration</span><span class="p">()</span><span class="w"> </span><span class="nx">ConfigStruct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="nx">ConfigStruct</span>

<span class="w">    </span><span class="c1">// Load from environment variables</span>
<span class="w">    </span><span class="nx">config</span><span class="p">.</span><span class="nx">DatabaseConfig</span><span class="p">.</span><span class="nx">MongoURI</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">getEnvOrDefault</span><span class="p">(</span><span class="s">&quot;MONGO_URI&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mongodb://localhost:27017&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">config</span><span class="p">.</span><span class="nx">DatabaseConfig</span><span class="p">.</span><span class="nx">DatabaseName</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">getEnvOrDefault</span><span class="p">(</span><span class="s">&quot;DB_NAME&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;securaa_playbook&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">config</span><span class="p">.</span><span class="nx">DatabaseConfig</span><span class="p">.</span><span class="nx">MaxPoolSize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">getEnvIntOrDefault</span><span class="p">(</span><span class="s">&quot;DB_MAX_POOL_SIZE&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span>

<span class="w">    </span><span class="nx">config</span><span class="p">.</span><span class="nx">RedisConfig</span><span class="p">.</span><span class="nx">Host</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">getEnvOrDefault</span><span class="p">(</span><span class="s">&quot;REDIS_HOST&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;localhost&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">config</span><span class="p">.</span><span class="nx">RedisConfig</span><span class="p">.</span><span class="nx">Port</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">getEnvIntOrDefault</span><span class="p">(</span><span class="s">&quot;REDIS_PORT&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">6379</span><span class="p">)</span>
<span class="w">    </span><span class="nx">config</span><span class="p">.</span><span class="nx">RedisConfig</span><span class="p">.</span><span class="nx">Password</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">getEnvOrDefault</span><span class="p">(</span><span class="s">&quot;REDIS_PASSWORD&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="nx">config</span><span class="p">.</span><span class="nx">SecurityConfig</span><span class="p">.</span><span class="nx">JWTSecret</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">getEnvOrDefault</span><span class="p">(</span><span class="s">&quot;JWT_SECRET&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">config</span><span class="p">.</span><span class="nx">SecurityConfig</span><span class="p">.</span><span class="nx">SessionTimeout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">getEnvIntOrDefault</span><span class="p">(</span><span class="s">&quot;SESSION_TIMEOUT&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">3600</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Load from config file if exists</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">configFile</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Getenv</span><span class="p">(</span><span class="s">&quot;CONFIG_FILE&quot;</span><span class="p">);</span><span class="w"> </span><span class="nx">configFile</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">loadFromFile</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">config</span><span class="p">,</span><span class="w"> </span><span class="nx">configFile</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Validate configuration</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">validateConfig</span><span class="p">(</span><span class="nx">config</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;Invalid configuration:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">config</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">validateConfig</span><span class="p">(</span><span class="nx">config</span><span class="w"> </span><span class="nx">ConfigStruct</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">DatabaseConfig</span><span class="p">.</span><span class="nx">MongoURI</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;mongo_uri is required&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">SecurityConfig</span><span class="p">.</span><span class="nx">JWTSecret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;jwt_secret is required&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">DatabaseConfig</span><span class="p">.</span><span class="nx">MaxPoolSize</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;max_pool_size must be positive&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="9-error-handling-implementation">9. Error Handling Implementation</h2>
<h3 id="91-error-types-and-hierarchy">9.1 Error Types and Hierarchy</h3>
<div class="highlight"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">ErrorType</span><span class="w"> </span><span class="kt">string</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">ValidationError</span><span class="w">    </span><span class="nx">ErrorType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;VALIDATION_ERROR&quot;</span>
<span class="w">    </span><span class="nx">DatabaseError</span><span class="w">      </span><span class="nx">ErrorType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;DATABASE_ERROR&quot;</span>
<span class="w">    </span><span class="nx">IntegrationError</span><span class="w">   </span><span class="nx">ErrorType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;INTEGRATION_ERROR&quot;</span>
<span class="w">    </span><span class="nx">AuthenticationError</span><span class="w"> </span><span class="nx">ErrorType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;AUTHENTICATION_ERROR&quot;</span>
<span class="w">    </span><span class="nx">AuthorizationError</span><span class="w"> </span><span class="nx">ErrorType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;AUTHORIZATION_ERROR&quot;</span>
<span class="w">    </span><span class="nx">BusinessLogicError</span><span class="w"> </span><span class="nx">ErrorType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;BUSINESS_LOGIC_ERROR&quot;</span>
<span class="w">    </span><span class="nx">SystemError</span><span class="w">        </span><span class="nx">ErrorType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;SYSTEM_ERROR&quot;</span>
<span class="w">    </span><span class="nx">NetworkError</span><span class="w">       </span><span class="nx">ErrorType</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;NETWORK_ERROR&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">ServiceError</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Type</span><span class="w">        </span><span class="nx">ErrorType</span><span class="w"> </span><span class="s">`json:&quot;type&quot;`</span>
<span class="w">    </span><span class="nx">Code</span><span class="w">        </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;code&quot;`</span>
<span class="w">    </span><span class="nx">Message</span><span class="w">     </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;message&quot;`</span>
<span class="w">    </span><span class="nx">Details</span><span class="w">     </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;details&quot;`</span>
<span class="w">    </span><span class="nx">Timestamp</span><span class="w">   </span><span class="kt">int64</span><span class="w">     </span><span class="s">`json:&quot;timestamp&quot;`</span>
<span class="w">    </span><span class="nx">RequestID</span><span class="w">   </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;request_id&quot;`</span>
<span class="w">    </span><span class="nx">UserID</span><span class="w">      </span><span class="kt">int</span><span class="w">       </span><span class="s">`json:&quot;user_id&quot;`</span>
<span class="w">    </span><span class="nx">TenantCode</span><span class="w">  </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;tenant_code&quot;`</span>
<span class="w">    </span><span class="nx">StackTrace</span><span class="w">  </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;stack_trace,omitempty&quot;`</span>
<span class="w">    </span><span class="nx">Cause</span><span class="w">       </span><span class="kt">error</span><span class="w">     </span><span class="s">`json:&quot;-&quot;`</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="w"> </span><span class="o">*</span><span class="nx">ServiceError</span><span class="p">)</span><span class="w"> </span><span class="nx">Error</span><span class="p">()</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;[%s] %s: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Code</span><span class="p">,</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewServiceError</span><span class="p">(</span><span class="nx">errorType</span><span class="w"> </span><span class="nx">ErrorType</span><span class="p">,</span><span class="w"> </span><span class="nx">code</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">ServiceError</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">ServiceError</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Type</span><span class="p">:</span><span class="w">      </span><span class="nx">errorType</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Code</span><span class="p">:</span><span class="w">      </span><span class="nx">code</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Message</span><span class="p">:</span><span class="w">   </span><span class="nx">message</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Timestamp</span><span class="p">:</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixMilli</span><span class="p">(),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="92-error-handler-implementation">9.2 Error Handler Implementation</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">HandleError</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="nx">models</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="nx">models</span><span class="p">.</span><span class="nx">Response</span>
<span class="w">    </span><span class="nx">response</span><span class="p">.</span><span class="nx">Success</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="nx">response</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixMilli</span><span class="p">()</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">serviceErr</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">err</span><span class="p">.(</span><span class="o">*</span><span class="nx">ServiceError</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">response</span><span class="p">.</span><span class="nx">Error</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">serviceErr</span><span class="p">.</span><span class="nx">Message</span>
<span class="w">        </span><span class="nx">response</span><span class="p">.</span><span class="nx">ErrorPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span>
<span class="w">        </span><span class="nx">response</span><span class="p">.</span><span class="nx">Status</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">serviceErr</span><span class="p">.</span><span class="nx">Type</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// Log structured error</span>
<span class="w">        </span><span class="nx">logger</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;Service Error&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="s">&quot;type&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceErr</span><span class="p">.</span><span class="nx">Type</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;code&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceErr</span><span class="p">.</span><span class="nx">Code</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;message&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceErr</span><span class="p">.</span><span class="nx">Message</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;context&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;timestamp&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">serviceErr</span><span class="p">.</span><span class="nx">Timestamp</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span>

<span class="w">        </span><span class="c1">// Determine appropriate HTTP status</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="nx">serviceErr</span><span class="p">.</span><span class="nx">Type</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">ValidationError</span><span class="p">:</span>
<span class="w">            </span><span class="nx">response</span><span class="p">.</span><span class="nx">DisplayMessage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Invalid input provided&quot;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">AuthenticationError</span><span class="p">:</span>
<span class="w">            </span><span class="nx">response</span><span class="p">.</span><span class="nx">DisplayMessage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Authentication required&quot;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">AuthorizationError</span><span class="p">:</span>
<span class="w">            </span><span class="nx">response</span><span class="p">.</span><span class="nx">DisplayMessage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Access denied&quot;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">DatabaseError</span><span class="p">:</span>
<span class="w">            </span><span class="nx">response</span><span class="p">.</span><span class="nx">DisplayMessage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Data operation failed&quot;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">IntegrationError</span><span class="p">:</span>
<span class="w">            </span><span class="nx">response</span><span class="p">.</span><span class="nx">DisplayMessage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;External service unavailable&quot;</span>
<span class="w">        </span><span class="k">default</span><span class="p">:</span>
<span class="w">            </span><span class="nx">response</span><span class="p">.</span><span class="nx">DisplayMessage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;An unexpected error occurred&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Handle generic errors</span>
<span class="w">        </span><span class="nx">response</span><span class="p">.</span><span class="nx">Error</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">()</span>
<span class="w">        </span><span class="nx">response</span><span class="p">.</span><span class="nx">ErrorPath</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span>
<span class="w">        </span><span class="nx">response</span><span class="p">.</span><span class="nx">Status</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;error&quot;</span>
<span class="w">        </span><span class="nx">response</span><span class="p">.</span><span class="nx">DisplayMessage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;An unexpected error occurred&quot;</span>

<span class="w">        </span><span class="nx">logger</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;Unhandled Error&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="s">&quot;error&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">(),</span>
<span class="w">            </span><span class="s">&quot;context&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">,</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">response</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="93-retry-mechanism">9.3 Retry Mechanism</h3>
<div class="highlight"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">RetryConfig</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">MaxAttempts</span><span class="w">   </span><span class="kt">int</span><span class="w">           </span><span class="s">`json:&quot;max_attempts&quot;`</span>
<span class="w">    </span><span class="nx">InitialDelay</span><span class="w">  </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="w"> </span><span class="s">`json:&quot;initial_delay&quot;`</span>
<span class="w">    </span><span class="nx">MaxDelay</span><span class="w">      </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="w"> </span><span class="s">`json:&quot;max_delay&quot;`</span>
<span class="w">    </span><span class="nx">BackoffFactor</span><span class="w"> </span><span class="kt">float64</span><span class="w">       </span><span class="s">`json:&quot;backoff_factor&quot;`</span>
<span class="w">    </span><span class="nx">RetryableErrors</span><span class="w"> </span><span class="p">[]</span><span class="nx">ErrorType</span><span class="w"> </span><span class="s">`json:&quot;retryable_errors&quot;`</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">RetryWithBackoff</span><span class="p">(</span>
<span class="w">    </span><span class="nx">operation</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span>
<span class="w">    </span><span class="nx">config</span><span class="w"> </span><span class="nx">RetryConfig</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">lastErr</span><span class="w"> </span><span class="kt">error</span>
<span class="w">    </span><span class="nx">delay</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">InitialDelay</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">attempt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="nx">attempt</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">MaxAttempts</span><span class="p">;</span><span class="w"> </span><span class="nx">attempt</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">operation</span><span class="p">()</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">lastErr</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">err</span>

<span class="w">        </span><span class="c1">// Check if error is retryable</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">serviceErr</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">err</span><span class="p">.(</span><span class="o">*</span><span class="nx">ServiceError</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">retryable</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kc">false</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">retryableType</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">RetryableErrors</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">serviceErr</span><span class="p">.</span><span class="nx">Type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">retryableType</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">retryable</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">                    </span><span class="k">break</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">retryable</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">attempt</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">MaxAttempts</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">logger</span><span class="p">.</span><span class="nx">Warn</span><span class="p">(</span><span class="s">&quot;Operation failed, retrying&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;attempt&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">attempt</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;max_attempts&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">MaxAttempts</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;delay&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">delay</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;error&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">(),</span>
<span class="w">            </span><span class="p">)</span>

<span class="w">            </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span>

<span class="w">            </span><span class="c1">// Calculate next delay with exponential backoff</span>
<span class="w">            </span><span class="nx">delay</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="nb">float64</span><span class="p">(</span><span class="nx">delay</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">BackoffFactor</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">delay</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">MaxDelay</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">delay</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">MaxDelay</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;operation failed after %d attempts: %w&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nx">config</span><span class="p">.</span><span class="nx">MaxAttempts</span><span class="p">,</span><span class="w"> </span><span class="nx">lastErr</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="10-concurrency-thread-safety">10. Concurrency &amp; Thread Safety</h2>
<h3 id="101-task-map-thread-safety">10.1 Task Map Thread Safety</h3>
<div class="highlight"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">ThreadSafeTaskMap</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">tasks</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span>
<span class="w">    </span><span class="nx">mutex</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewThreadSafeTaskMap</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="nx">ThreadSafeTaskMap</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">ThreadSafeTaskMap</span><span class="p">{</span>
<span class="w">        </span><span class="nx">tasks</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span><span class="p">),</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">tsm</span><span class="w"> </span><span class="o">*</span><span class="nx">ThreadSafeTaskMap</span><span class="p">)</span><span class="w"> </span><span class="nx">Set</span><span class="p">(</span><span class="nx">taskSeq</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">tsm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">tsm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">tsm</span><span class="p">.</span><span class="nx">tasks</span><span class="p">[</span><span class="nx">taskSeq</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">task</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">tsm</span><span class="w"> </span><span class="o">*</span><span class="nx">ThreadSafeTaskMap</span><span class="p">)</span><span class="w"> </span><span class="nx">Get</span><span class="p">(</span><span class="nx">taskSeq</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">tsm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">tsm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">task</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tsm</span><span class="p">.</span><span class="nx">tasks</span><span class="p">[</span><span class="nx">taskSeq</span><span class="p">]</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">task</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">tsm</span><span class="w"> </span><span class="o">*</span><span class="nx">ThreadSafeTaskMap</span><span class="p">)</span><span class="w"> </span><span class="nx">GetAll</span><span class="p">()</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">tsm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">tsm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Create a copy to avoid external modifications</span>
<span class="w">    </span><span class="nx">copy</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">k</span><span class="p">,</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">tsm</span><span class="p">.</span><span class="nx">tasks</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">copy</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">copy</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">tsm</span><span class="w"> </span><span class="o">*</span><span class="nx">ThreadSafeTaskMap</span><span class="p">)</span><span class="w"> </span><span class="nx">Delete</span><span class="p">(</span><span class="nx">taskSeq</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">tsm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">tsm</span><span class="p">.</span><span class="nx">mutex</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="nb">delete</span><span class="p">(</span><span class="nx">tsm</span><span class="p">.</span><span class="nx">tasks</span><span class="p">,</span><span class="w"> </span><span class="nx">taskSeq</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="102-channel-based-communication">10.2 Channel-Based Communication</h3>
<div class="highlight"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">TaskChannel</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">taskQueue</span><span class="w">    </span><span class="kd">chan</span><span class="w"> </span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span>
<span class="w">    </span><span class="nx">resultQueue</span><span class="w">  </span><span class="kd">chan</span><span class="w"> </span><span class="nx">TaskResult</span>
<span class="w">    </span><span class="nx">errorQueue</span><span class="w">   </span><span class="kd">chan</span><span class="w"> </span><span class="kt">error</span>
<span class="w">    </span><span class="nx">stopSignal</span><span class="w">   </span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}</span>
<span class="w">    </span><span class="nx">workerCount</span><span class="w">  </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">wg</span><span class="w">           </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">TaskResult</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">TaskSeq</span><span class="w">  </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">Success</span><span class="w">  </span><span class="kt">bool</span>
<span class="w">    </span><span class="nx">Response</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="nx">Error</span><span class="w">    </span><span class="kt">error</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewTaskChannel</span><span class="p">(</span><span class="nx">bufferSize</span><span class="p">,</span><span class="w"> </span><span class="nx">workerCount</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">TaskChannel</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">TaskChannel</span><span class="p">{</span>
<span class="w">        </span><span class="nx">taskQueue</span><span class="p">:</span><span class="w">   </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span><span class="p">,</span><span class="w"> </span><span class="nx">bufferSize</span><span class="p">),</span>
<span class="w">        </span><span class="nx">resultQueue</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="nx">TaskResult</span><span class="p">,</span><span class="w"> </span><span class="nx">bufferSize</span><span class="p">),</span>
<span class="w">        </span><span class="nx">errorQueue</span><span class="p">:</span><span class="w">  </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span><span class="w"> </span><span class="nx">bufferSize</span><span class="p">),</span>
<span class="w">        </span><span class="nx">stopSignal</span><span class="p">:</span><span class="w">  </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}),</span>
<span class="w">        </span><span class="nx">workerCount</span><span class="p">:</span><span class="w"> </span><span class="nx">workerCount</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">tc</span><span class="w"> </span><span class="o">*</span><span class="nx">TaskChannel</span><span class="p">)</span><span class="w"> </span><span class="nx">Start</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">tc</span><span class="p">.</span><span class="nx">workerCount</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">tc</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="nx">tc</span><span class="p">.</span><span class="nx">worker</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">tc</span><span class="w"> </span><span class="o">*</span><span class="nx">TaskChannel</span><span class="p">)</span><span class="w"> </span><span class="nx">worker</span><span class="p">(</span><span class="nx">workerID</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">tc</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nx">task</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">tc</span><span class="p">.</span><span class="nx">taskQueue</span><span class="p">:</span>
<span class="w">            </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tc</span><span class="p">.</span><span class="nx">executeTask</span><span class="p">(</span><span class="nx">task</span><span class="p">)</span>
<span class="w">            </span><span class="nx">tc</span><span class="p">.</span><span class="nx">resultQueue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">result</span>

<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">tc</span><span class="p">.</span><span class="nx">stopSignal</span><span class="p">:</span>
<span class="w">            </span><span class="nx">logger</span><span class="p">.</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;Worker stopping&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;worker_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">workerID</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">tc</span><span class="w"> </span><span class="o">*</span><span class="nx">TaskChannel</span><span class="p">)</span><span class="w"> </span><span class="nx">SubmitTask</span><span class="p">(</span><span class="nx">task</span><span class="w"> </span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">tc</span><span class="p">.</span><span class="nx">taskQueue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">task</span><span class="p">:</span>
<span class="w">        </span><span class="c1">// Task submitted successfully</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nx">After</span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">):</span>
<span class="w">        </span><span class="nx">logger</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="s">&quot;Task submission timeout&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;task_seq&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">task</span><span class="p">.</span><span class="nx">TaskSeq</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">tc</span><span class="w"> </span><span class="o">*</span><span class="nx">TaskChannel</span><span class="p">)</span><span class="w"> </span><span class="nx">Stop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">close</span><span class="p">(</span><span class="nx">tc</span><span class="p">.</span><span class="nx">stopSignal</span><span class="p">)</span>
<span class="w">    </span><span class="nx">tc</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="w">    </span><span class="nb">close</span><span class="p">(</span><span class="nx">tc</span><span class="p">.</span><span class="nx">taskQueue</span><span class="p">)</span>
<span class="w">    </span><span class="nb">close</span><span class="p">(</span><span class="nx">tc</span><span class="p">.</span><span class="nx">resultQueue</span><span class="p">)</span>
<span class="w">    </span><span class="nb">close</span><span class="p">(</span><span class="nx">tc</span><span class="p">.</span><span class="nx">errorQueue</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="103-context-based-cancellation">10.3 Context-Based Cancellation</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">executionController</span><span class="w"> </span><span class="o">*</span><span class="nx">PlaybookExecutionController</span><span class="p">)</span><span class="w"> </span><span class="nx">ProcessWithContext</span><span class="p">(</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span>
<span class="w">    </span><span class="nx">task</span><span class="w"> </span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// Create a derived context with timeout</span>
<span class="w">    </span><span class="nx">taskCtx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">)</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// Create result channel</span>
<span class="w">    </span><span class="nx">resultChan</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Execute task in goroutine</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">recover</span><span class="p">();</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">resultChan</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;task panicked: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}()</span>

<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">executionController</span><span class="p">.</span><span class="nx">executeTaskInternal</span><span class="p">(</span><span class="nx">taskCtx</span><span class="p">,</span><span class="w"> </span><span class="nx">task</span><span class="p">)</span>
<span class="w">        </span><span class="nx">resultChan</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}()</span>

<span class="w">    </span><span class="c1">// Wait for completion or cancellation</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">resultChan</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">taskCtx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">taskCtx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">DeadlineExceeded</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">NewServiceError</span><span class="p">(</span><span class="nx">SystemError</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TASK_TIMEOUT&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Task %d timed out&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">task</span><span class="p">.</span><span class="nx">TaskSeq</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">NewServiceError</span><span class="p">(</span><span class="nx">SystemError</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;TASK_CANCELLED&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Task %d was cancelled&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">task</span><span class="p">.</span><span class="nx">TaskSeq</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="11-performance-optimizations">11. Performance Optimizations</h2>
<h3 id="111-connection-pool-management">11.1 Connection Pool Management</h3>
<div class="highlight"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">ConnectionPoolManager</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mongoPool</span><span class="w">   </span><span class="o">*</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Client</span>
<span class="w">    </span><span class="nx">redisPool</span><span class="w">   </span><span class="o">*</span><span class="nx">redis</span><span class="p">.</span><span class="nx">Client</span>
<span class="w">    </span><span class="nx">httpPool</span><span class="w">    </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span>
<span class="w">    </span><span class="nx">config</span><span class="w">      </span><span class="nx">PoolConfig</span>
<span class="p">}</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">PoolConfig</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">MongoMaxPoolSize</span><span class="w">    </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">MongoMinPoolSize</span><span class="w">    </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">MongoMaxIdleTime</span><span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
<span class="w">    </span><span class="nx">RedisPoolSize</span><span class="w">       </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">RedisIdleTimeout</span><span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
<span class="w">    </span><span class="nx">HTTPMaxIdleConns</span><span class="w">    </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">HTTPIdleConnTimeout</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewConnectionPoolManager</span><span class="p">(</span><span class="nx">config</span><span class="w"> </span><span class="nx">PoolConfig</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">ConnectionPoolManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Configure MongoDB connection pool</span>
<span class="w">    </span><span class="nx">mongoOpts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">Client</span><span class="p">().</span>
<span class="w">        </span><span class="nx">SetMaxPoolSize</span><span class="p">(</span><span class="nb">uint64</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">MongoMaxPoolSize</span><span class="p">)).</span>
<span class="w">        </span><span class="nx">SetMinPoolSize</span><span class="p">(</span><span class="nb">uint64</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">MongoMinPoolSize</span><span class="p">)).</span>
<span class="w">        </span><span class="nx">SetMaxConnIdleTime</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">MongoMaxIdleTime</span><span class="p">)</span>

<span class="w">    </span><span class="nx">mongoClient</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mongo</span><span class="p">.</span><span class="nx">Connect</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">mongoOpts</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Configure Redis connection pool</span>
<span class="w">    </span><span class="nx">redisClient</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">redis</span><span class="p">.</span><span class="nx">NewClient</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">redis</span><span class="p">.</span><span class="nx">Options</span><span class="p">{</span>
<span class="w">        </span><span class="nx">PoolSize</span><span class="p">:</span><span class="w">    </span><span class="nx">config</span><span class="p">.</span><span class="nx">RedisPoolSize</span><span class="p">,</span>
<span class="w">        </span><span class="nx">IdleTimeout</span><span class="p">:</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">RedisIdleTimeout</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="c1">// Configure HTTP client pool</span>
<span class="w">    </span><span class="nx">httpClient</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Client</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Transport</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Transport</span><span class="p">{</span>
<span class="w">            </span><span class="nx">MaxIdleConns</span><span class="p">:</span><span class="w">        </span><span class="nx">config</span><span class="p">.</span><span class="nx">HTTPMaxIdleConns</span><span class="p">,</span>
<span class="w">            </span><span class="nx">IdleConnTimeout</span><span class="p">:</span><span class="w">     </span><span class="nx">config</span><span class="p">.</span><span class="nx">HTTPIdleConnTimeout</span><span class="p">,</span>
<span class="w">            </span><span class="nx">TLSHandshakeTimeout</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nx">Timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">ConnectionPoolManager</span><span class="p">{</span>
<span class="w">        </span><span class="nx">mongoPool</span><span class="p">:</span><span class="w"> </span><span class="nx">mongoClient</span><span class="p">,</span>
<span class="w">        </span><span class="nx">redisPool</span><span class="p">:</span><span class="w"> </span><span class="nx">redisClient</span><span class="p">,</span>
<span class="w">        </span><span class="nx">httpPool</span><span class="p">:</span><span class="w">  </span><span class="nx">httpClient</span><span class="p">,</span>
<span class="w">        </span><span class="nx">config</span><span class="p">:</span><span class="w">    </span><span class="nx">config</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="112-batch-operations">11.2 Batch Operations</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">service</span><span class="w"> </span><span class="o">*</span><span class="nx">TaskService</span><span class="p">)</span><span class="w"> </span><span class="nx">BatchUpdateTaskStatus</span><span class="p">(</span>
<span class="w">    </span><span class="nx">updates</span><span class="w"> </span><span class="p">[]</span><span class="nx">TaskStatusUpdate</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">batchSize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1000</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">updates</span><span class="p">);</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">batchSize</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">end</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">batchSize</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">end</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">updates</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">end</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">updates</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">batch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">updates</span><span class="p">[</span><span class="nx">i</span><span class="p">:</span><span class="nx">end</span><span class="p">]</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">service</span><span class="p">.</span><span class="nx">processBatch</span><span class="p">(</span><span class="nx">batch</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">service</span><span class="w"> </span><span class="o">*</span><span class="nx">TaskService</span><span class="p">)</span><span class="w"> </span><span class="nx">processBatch</span><span class="p">(</span><span class="nx">batch</span><span class="w"> </span><span class="p">[]</span><span class="nx">TaskStatusUpdate</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Build bulk write operations</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">operations</span><span class="w"> </span><span class="p">[]</span><span class="nx">mongo</span><span class="p">.</span><span class="nx">WriteModel</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">update</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">batch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">filter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span><span class="s">&quot;task_request_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">update</span><span class="p">.</span><span class="nx">TaskRequestID</span><span class="p">}</span>
<span class="w">        </span><span class="nx">updateDoc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;$set&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">bson</span><span class="p">.</span><span class="nx">M</span><span class="p">{</span>
<span class="w">                </span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w">         </span><span class="nx">update</span><span class="p">.</span><span class="nx">Status</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;response&quot;</span><span class="p">:</span><span class="w">       </span><span class="nx">update</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;updated_date&quot;</span><span class="p">:</span><span class="w">   </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixMilli</span><span class="p">(),</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">operation</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mongo</span><span class="p">.</span><span class="nx">NewUpdateOneModel</span><span class="p">().</span>
<span class="w">            </span><span class="nx">SetFilter</span><span class="p">(</span><span class="nx">filter</span><span class="p">).</span>
<span class="w">            </span><span class="nx">SetUpdate</span><span class="p">(</span><span class="nx">updateDoc</span><span class="p">)</span>

<span class="w">        </span><span class="nx">operations</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">operations</span><span class="p">,</span><span class="w"> </span><span class="nx">operation</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Execute bulk write</span>
<span class="w">    </span><span class="nx">opts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">options</span><span class="p">.</span><span class="nx">BulkWrite</span><span class="p">().</span><span class="nx">SetOrdered</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">service</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">BulkWrite</span><span class="p">(</span>
<span class="w">        </span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">operations</span><span class="p">,</span>
<span class="w">        </span><span class="nx">opts</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="113-memory-management">11.3 Memory Management</h3>
<div class="highlight"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">ObjectPool</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">pool</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Pool</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">NewObjectPool</span><span class="p">(</span><span class="nx">factory</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="o">*</span><span class="nx">ObjectPool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">ObjectPool</span><span class="p">{</span>
<span class="w">        </span><span class="nx">pool</span><span class="p">:</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Pool</span><span class="p">{</span>
<span class="w">            </span><span class="nx">New</span><span class="p">:</span><span class="w"> </span><span class="nx">factory</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">op</span><span class="w"> </span><span class="o">*</span><span class="nx">ObjectPool</span><span class="p">)</span><span class="w"> </span><span class="nx">Get</span><span class="p">()</span><span class="w"> </span><span class="kd">interface</span><span class="p">{}</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">op</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nx">Get</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">op</span><span class="w"> </span><span class="o">*</span><span class="nx">ObjectPool</span><span class="p">)</span><span class="w"> </span><span class="nx">Put</span><span class="p">(</span><span class="nx">obj</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">op</span><span class="p">.</span><span class="nx">pool</span><span class="p">.</span><span class="nx">Put</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Example usage for task requests</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">taskRequestPool</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">NewObjectPool</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kd">interface</span><span class="p">{}</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">models</span><span class="p">.</span><span class="nx">TaskRequest</span><span class="p">{}</span>
<span class="p">})</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">ProcessTaskRequest</span><span class="p">(</span><span class="nx">data</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Get object from pool</span>
<span class="w">    </span><span class="nx">req</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">taskRequestPool</span><span class="p">.</span><span class="nx">Get</span><span class="p">().(</span><span class="o">*</span><span class="nx">models</span><span class="p">.</span><span class="nx">TaskRequest</span><span class="p">)</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">taskRequestPool</span><span class="p">.</span><span class="nx">Put</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Reset object state</span>
<span class="w">    </span><span class="o">*</span><span class="nx">req</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">models</span><span class="p">.</span><span class="nx">TaskRequest</span><span class="p">{}</span>

<span class="w">    </span><span class="c1">// Process request</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ... process request</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="12-testing-strategy">12. Testing Strategy</h2>
<h3 id="121-unit-testing-structure">12.1 Unit Testing Structure</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Test file: controllers/playbookcontroller_test.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">controllers</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;testing&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/stretchr/testify/assert&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/stretchr/testify/mock&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">MockMongoSession</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mock</span><span class="p">.</span><span class="nx">Mock</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="o">*</span><span class="nx">MockMongoSession</span><span class="p">)</span><span class="w"> </span><span class="nx">FindSingleDocument</span><span class="p">(</span><span class="nx">filter</span><span class="p">,</span><span class="w"> </span><span class="nx">opts</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">args</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Called</span><span class="p">(</span><span class="nx">filter</span><span class="p">,</span><span class="w"> </span><span class="nx">opts</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">args</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestPlaybookController_RunSelectedPlaybook</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Arrange</span>
<span class="w">    </span><span class="nx">mockSession</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">new</span><span class="p">(</span><span class="nx">MockMongoSession</span><span class="p">)</span>
<span class="w">    </span><span class="nx">controller</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">NewPlaybookController</span><span class="p">()</span>

<span class="w">    </span><span class="nx">expectedPlaybook</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">models</span><span class="p">.</span><span class="nx">PlaybookObject</span><span class="p">{</span>
<span class="w">        </span><span class="nx">ID</span><span class="p">:</span><span class="w">   </span><span class="mi">1001</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Test Playbook&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Definition</span><span class="p">:</span><span class="w"> </span><span class="s">`[{&quot;task_seq&quot;: 1, &quot;type&quot;: &quot;start&quot;}]`</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">mockSession</span><span class="p">.</span><span class="nx">On</span><span class="p">(</span><span class="s">&quot;FindSingleDocument&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nx">mock</span><span class="p">.</span><span class="nx">Anything</span><span class="p">,</span><span class="w"> </span><span class="nx">mock</span><span class="p">.</span><span class="nx">Anything</span><span class="p">,</span><span class="w"> </span><span class="nx">mock</span><span class="p">.</span><span class="nx">Anything</span><span class="p">).</span>
<span class="w">        </span><span class="nx">Return</span><span class="p">(</span><span class="kc">nil</span><span class="p">).</span>
<span class="w">        </span><span class="nx">Run</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">args</span><span class="w"> </span><span class="nx">mock</span><span class="p">.</span><span class="nx">Arguments</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">args</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="mi">2</span><span class="p">).(</span><span class="o">*</span><span class="nx">models</span><span class="p">.</span><span class="nx">PlaybookObject</span><span class="p">)</span>
<span class="w">            </span><span class="o">*</span><span class="nx">result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">expectedPlaybook</span>
<span class="w">        </span><span class="p">})</span>

<span class="w">    </span><span class="c1">// Act</span>
<span class="w">    </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">controller</span><span class="p">.</span><span class="nx">RunSelectedPlaybook</span><span class="p">(</span>
<span class="w">        </span><span class="s">&quot;test_tenant&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;Test Playbook&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;12345&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">mockSession</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Assert</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">NotEmpty</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">PlaybookExecutionID</span><span class="p">)</span>
<span class="w">    </span><span class="nx">mockSession</span><span class="p">.</span><span class="nx">AssertExpectations</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestPlaybookExecutionController_ParallelExecution</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Test parallel task execution</span>
<span class="w">    </span><span class="nx">controller</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">PlaybookExecutionController</span><span class="p">{</span>
<span class="w">        </span><span class="nx">PlayBookTasksMap</span><span class="p">:</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span><span class="p">),</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Create test tasks</span>
<span class="w">    </span><span class="nx">tasks</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">executionModels</span><span class="p">.</span><span class="nx">PlayBookTask</span><span class="p">{</span>
<span class="w">        </span><span class="p">{</span><span class="nx">TaskSeq</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">TaskName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Task 1&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">Type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;integration&quot;</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nx">TaskSeq</span><span class="p">:</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="nx">TaskName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Task 2&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">Type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;integration&quot;</span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="nx">TaskSeq</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nx">TaskName</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Task 3&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">Type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;integration&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Execute parallel tasks</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">controller</span><span class="p">.</span><span class="nx">executeParallelTasks</span><span class="p">(</span><span class="nx">tasks</span><span class="p">,</span><span class="w"> </span><span class="nx">mockSession</span><span class="p">)</span>

<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">Equal</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">PlayBookTasksMap</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="122-integration-testing">12.2 Integration Testing</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Test file: integration/playbook_execution_test.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">integration</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;testing&quot;</span>
<span class="w">    </span><span class="s">&quot;context&quot;</span>
<span class="w">    </span><span class="s">&quot;time&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestPlaybookExecutionEndToEnd</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Setup test environment</span>
<span class="w">    </span><span class="nx">testDB</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">setupTestDatabase</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">cleanupTestDatabase</span><span class="p">(</span><span class="nx">testDB</span><span class="p">)</span>

<span class="w">    </span><span class="nx">testRedis</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">setupTestRedis</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">cleanupTestRedis</span><span class="p">(</span><span class="nx">testRedis</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Create test playbook</span>
<span class="w">    </span><span class="nx">playbook</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">createTestPlaybook</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">testDB</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Create test case</span>
<span class="w">    </span><span class="nx">testCase</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">createTestCase</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">testDB</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Execute playbook</span>
<span class="w">    </span><span class="nx">executionID</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">executePlaybook</span><span class="p">(</span>
<span class="w">        </span><span class="nx">playbook</span><span class="p">.</span><span class="nx">Name</span><span class="p">,</span>
<span class="w">        </span><span class="nx">testCase</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
<span class="w">        </span><span class="nx">testDB</span><span class="p">,</span>
<span class="w">        </span><span class="nx">testRedis</span><span class="p">,</span>
<span class="w">    </span><span class="p">)</span>

<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="nx">assert</span><span class="p">.</span><span class="nx">NotEmpty</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span><span class="w"> </span><span class="nx">executionID</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Wait for completion</span>
<span class="w">    </span><span class="nx">timeout</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">After</span><span class="p">(</span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ticker</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Tick</span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">timeout</span><span class="p">:</span>
<span class="w">            </span><span class="nx">t</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;Playbook execution timeout&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ticker</span><span class="p">:</span>
<span class="w">            </span><span class="nx">status</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getExecutionStatus</span><span class="p">(</span><span class="nx">executionID</span><span class="p">,</span><span class="w"> </span><span class="nx">testDB</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;completed&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;failed&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">t</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;Playbook execution failed&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="123-performance-testing">12.3 Performance Testing</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// Test file: performance/load_test.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">performance</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;testing&quot;</span>
<span class="w">    </span><span class="s">&quot;sync&quot;</span>
<span class="w">    </span><span class="s">&quot;time&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">BenchmarkParallelPlaybookExecution</span><span class="p">(</span><span class="nx">b</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">B</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">controller</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">setupPlaybookController</span><span class="p">()</span>

<span class="w">    </span><span class="nx">b</span><span class="p">.</span><span class="nx">ResetTimer</span><span class="p">()</span>
<span class="w">    </span><span class="nx">b</span><span class="p">.</span><span class="nx">RunParallel</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">pb</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">PB</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">pb</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">controller</span><span class="p">.</span><span class="nx">RunSelectedPlaybook</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;test_tenant&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;Load Test Playbook&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nx">generateRandomCaseID</span><span class="p">(),</span>
<span class="w">                </span><span class="nx">mockSession</span><span class="p">,</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">b</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">TestConcurrentPlaybookExecution</span><span class="p">(</span><span class="nx">t</span><span class="w"> </span><span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">numGoroutines</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">100</span>
<span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">numExecutions</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">10</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">wg</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>
<span class="w">    </span><span class="nx">controller</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">setupPlaybookController</span><span class="p">()</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">numGoroutines</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Add</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">routineID</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">defer</span><span class="w"> </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Done</span><span class="p">()</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">numExecutions</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">controller</span><span class="p">.</span><span class="nx">RunSelectedPlaybook</span><span class="p">(</span>
<span class="w">                    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;tenant_%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">routineID</span><span class="p">),</span>
<span class="w">                    </span><span class="s">&quot;Concurrent Test Playbook&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;case_%d_%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">routineID</span><span class="p">,</span><span class="w"> </span><span class="nx">j</span><span class="p">),</span>
<span class="w">                    </span><span class="nx">mockSession</span><span class="p">,</span>
<span class="w">                </span><span class="p">)</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">t</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Execution failed: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="conclusion">Conclusion</h2>
<p>This Low Level Design document provides comprehensive implementation details for the Securaa Playbook Service, including:</p>
<ul>
<li><strong>Detailed component specifications</strong> with class diagrams and method signatures</li>
<li><strong>Complete database schema</strong> with indexing strategies</li>
<li><strong>API specifications</strong> with validation rules and error handling</li>
<li><strong>Algorithm implementations</strong> for critical operations</li>
<li><strong>Concurrency patterns</strong> and thread safety mechanisms</li>
<li><strong>Performance optimizations</strong> and resource management</li>
<li><strong>Testing strategies</strong> for quality assurance</li>
</ul>
<p>This document serves as the technical blueprint for implementing, maintaining, and extending the Securaa Playbook Service at the code level.</p>
    </main>

    <footer class="footer">
        <p>&copy; 2025 Securaa Security Platform. All rights reserved.</p>
        <p>Documentation generated on December 18, 2025</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#4f46e5',
                primaryTextColor: '#1f2937',
                primaryBorderColor: '#818cf8',
                lineColor: '#6b7280',
                secondaryColor: '#f3f4f6',
                tertiaryColor: '#e5e7eb',
                background: '#ffffff',
                mainBkg: '#f9fafb',
                secondBkg: '#f3f4f6',
                border1: '#e5e7eb',
                border2: '#d1d5db',
                fontFamily: 'Inter, sans-serif',
                fontSize: '14px',
                nodeBorder: '#4f46e5',
                clusterBkg: '#f0f4f8',
                clusterBorder: '#818cf8',
                edgeLabelBackground: '#ffffff'
            },
            flowchart: {
                htmlLabels: true,
                useMaxWidth: true,
                curve: 'basis',
                padding: 15,
                nodeSpacing: 50,
                rankSpacing: 50
            },
            sequence: {
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: true,
                useMaxWidth: true
            },
            er: {
                useMaxWidth: true,
                entityPadding: 15,
                fontSize: 12
            },
            class: {
                useMaxWidth: true,
                padding: 10
            },
            gantt: {
                useMaxWidth: true,
                barHeight: 20,
                barGap: 4,
                topPadding: 50,
                leftPadding: 75
            },
            pie: {
                useMaxWidth: true,
                textPosition: 0.5
            },
            mindmap: {
                useMaxWidth: true,
                padding: 10
            },
            securityLevel: 'loose',
            logLevel: 'error'
        });

        // Re-render mermaid diagrams after page load for better sizing
        window.addEventListener('load', function() {
            setTimeout(function() {
                document.querySelectorAll('.mermaid').forEach(function(el) {
                    if (el.getAttribute('data-processed') !== 'true') {
                        mermaid.init(undefined, el);
                    }
                });
            }, 100);
        });
    </script>
</body>
</html>
