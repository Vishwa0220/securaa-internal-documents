<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIA Service - Low Level Design - Securaa Platform Documentation</title>
    <link rel="stylesheet" href="assets/css/documentation.css">
    <script type="module">
      import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10.9.4/dist/mermaid.esm.min.mjs';
      mermaid.initialize({ startOnLoad: true });
    </script>
</head>
<body>
    <header class="main-header">
        <h1>Securaa Platform Documentation</h1>
        <p>Comprehensive documentation for Securaa security platform services</p>
    </header>
    
    <nav class="documentation-nav">
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="securaa-ris-high-level-design.html">RIS High Level Design</a></li>
            <li><a href="securaa-ris-low-level-design.html">RIS Low Level Design</a></li>
            <li><a href="securaa-ris-client-documentation.html">RIS Client Documentation</a></li>
            <li><a href="securaa-ris-server-documentation.html">RIS Server Documentation</a></li>
            <li><a href="securaa-playbook-high-level-design.html">Securaa Playbook High Level Design</a></li>
            <li><a href="securaa-playbook-low-level-design.html">Securaa Playbook Low Level Design</a></li>
            <li><a href="optimization-guide.html">Optimization Guide</a></li>
            <li><a href="securaa-siem-high-level-design.html">Securaa SIEM High Level Design</a></li>
            <li><a href="securaa-siem-low-level-design.html">Securaa SIEM Low Level Design</a></li>
            <li><a href="securaa-platform-high-level-design.html">Securaa Platform</a></li>
            <li><a href="process-manager-high-level-design.html">Process Manager High Level Design</a></li>
            <li><a href="process-manager-low-level-design.html">Process Manager Low Level Design</a></li>
            <li><a href="securaa-user-high-level-design.html">Securaa User High Level Design</a></li>
            <li><a href="securaa-user-low-level-design.html">Securaa User Low Level Design</a></li>
            <li><a href="securaa-custom-services-high-level-design.html">Securaa Custom Services High Level Design</a></li>
            <li><a href="securaa-custom-services-low-level-design.html">Securaa Custom Services Low Level Design</a></li>
            <li><a href="securaa-custom-utils-high-level-design.html">Securaa Custom Utils High Level Design</a></li>
            <li><a href="securaa-custom-utils-low-level-design.html">Securaa Custom Utils Low Level Design</a></li>
            <li><a href="securaa-make-system-high-level-design.html">Securaa Make System High Level Design</a></li>
            <li><a href="securaa-make-system-low-level-design.html">Securaa Make System Low Level Design</a></li>
            <li><a href="sia-service-high-level-design.html">SIA Service High Level Design</a></li>
            <li><a href="sia-service-low-level-design.html">SIA Service Low Level Design</a></li>
            <li><a href="secura-customer-security-documentation.html">Customer Security Documentation</a></li>
            <li><a href="securaa-information-security-risk-assesment-process.html">Information Security Risk Assessment</a></li>
        </ul>
    </nav>
    
    <main class="main-content">
<h1 id="low-level-design-lld-sia-service">Low-Level Design (LLD) - SIA Service</h1>
<h2 id="comprehensive-implementation-specification">Comprehensive Implementation Specification</h2>
<p><strong>Document Version</strong>: 1.0<br />
<strong>Last Updated</strong>: November 11, 2025<br />
<strong>Status</strong>: Active Development</p>
<hr />
<h2 id="table-of-contents">Table of Contents</h2>
<ol>
<li><a href="#1-component-architecture">Component Architecture</a></li>
<li><a href="#2-domain-models">Domain Models</a></li>
<li><a href="#3-database-schema">Database Schema</a></li>
<li><a href="#4-api-design">API Design</a></li>
<li><a href="#5-service-layer-implementation">Service Layer Implementation</a></li>
<li><a href="#6-repository-pattern">Repository Pattern</a></li>
<li><a href="#7-llm-integration">LLM Integration</a></li>
<li><a href="#8-message-processing">Message Processing</a></li>
<li><a href="#9-analysis-pipeline">Analysis Pipeline</a></li>
<li><a href="#10-false-positive-reduction">False Positive Reduction</a></li>
<li><a href="#11-implementation-diagrams">Implementation Diagrams</a></li>
<li><a href="#12-design-patterns">Design Patterns</a></li>
<li><a href="#13-error-handling">Error Handling</a></li>
<li><a href="#14-performance-optimizations">Performance Optimizations</a></li>
<li><a href="#15-testing-strategy">Testing Strategy</a></li>
<li><a href="#16-code-examples">Code Examples</a></li>
</ol>
<hr />
<h2 id="1-component-architecture">1. Component Architecture</h2>
<h3 id="11-fastapi-application-structure">1.1 FastAPI Application Structure</h3>
<div class="codehilite"><pre><span></span><code><span class="n">main</span><span class="o">.</span><span class="n">py</span>
<span class="err">├──</span> <span class="n">Lifespan</span> <span class="n">Management</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">init_tenant_sessions</span><span class="p">()</span>
<span class="err">├──</span> <span class="n">Router</span> <span class="n">Registration</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">users</span><span class="o">.</span><span class="n">router</span>       <span class="p">(</span><span class="o">/</span><span class="n">user</span><span class="p">)</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">chat</span><span class="o">.</span><span class="n">router</span>        <span class="p">(</span><span class="o">/</span><span class="n">chat</span><span class="p">)</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">case</span><span class="o">.</span><span class="n">router</span>        <span class="p">(</span><span class="o">/</span><span class="n">case</span><span class="p">)</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">index</span><span class="o">.</span><span class="n">router</span>       <span class="p">(</span><span class="o">/</span><span class="n">indexing</span><span class="p">)</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">tenant</span><span class="o">.</span><span class="n">router</span>      <span class="p">(</span><span class="o">/</span><span class="n">tenant</span><span class="p">)</span>
<span class="err">│</span>   <span class="err">├──</span> <span class="n">application</span><span class="o">.</span><span class="n">router</span> <span class="p">(</span><span class="o">/</span><span class="n">application</span><span class="p">)</span>
<span class="err">│</span>   <span class="err">└──</span> <span class="n">code</span><span class="o">.</span><span class="n">router</span>        <span class="p">(</span><span class="o">/</span><span class="n">code</span><span class="p">)</span>
<span class="err">└──</span> <span class="n">Middleware</span>
    <span class="err">└──</span> <span class="n">Traceloop</span> <span class="p">(</span><span class="n">OpenTelemetry</span><span class="p">)</span>
</code></pre></div>

<h3 id="12-module-organization">1.2 Module Organization</h3>
<div class="codehilite"><pre><span></span><code>siaservice/
├── routers/              # API route handlers
├── apis/services/        # Business logic services
├── domain/soar/          # Domain models (Case, PlaybookTask, etc.)
├── repositories/         # Data access layer
├── db/
│   ├── pgv/             # PostgreSQL with pgvector
│   ├── embed/           # Embedding generation
│   └── vectordb/        # Vector database operations
├── llm/                 # LLM integration layer
├── analysis/            # Analysis engines and agents
├── parsers/             # Output parsers
├── noise_reduction/     # FPR pipeline
└── common.py            # Shared utilities
</code></pre></div>

<hr />
<h2 id="2-domain-models">2. Domain Models</h2>
<h3 id="21-case-model">2.1 Case Model</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Case</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a security incident/case</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deployment_id</span><span class="p">:</span> <span class="nb">str</span>      <span class="c1"># Deployment identifier</span>
    <span class="n">tenant_id</span><span class="p">:</span> <span class="nb">str</span>          <span class="c1"># Tenant identifier</span>
    <span class="n">case_id</span><span class="p">:</span> <span class="nb">str</span>           <span class="c1"># Unique case identifier</span>
    <span class="n">case_detail</span><span class="p">:</span> <span class="nb">str</span>       <span class="c1"># Detailed case description</span>
    <span class="n">iocs</span><span class="p">:</span> <span class="nb">str</span>              <span class="c1"># Indicators of Compromise</span>
    <span class="n">findings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Finding</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;before&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_non_empty_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</code></pre></div>

<p><strong>Validation Rules</strong>:
- All fields except <code>findings</code> are required
- No empty strings allowed for required fields
- Automatic validation via Pydantic</p>
<h3 id="22-playbooktask-model">2.2 PlaybookTask Model</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PlaybookTask</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents an executed task within a playbook</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">deployment_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">tenant_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">case_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">playbook_run_id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">task_details</span><span class="p">:</span> <span class="nb">dict</span>      <span class="c1"># Full task execution details</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span>
    <span class="nd">@model_validator</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;before&#39;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_non_empty_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</code></pre></div>

<p><strong>Usage</strong>:
- Captures historical task executions
- Used for similarity search and context retrieval
- Indexed in vector database</p>
<h3 id="23-finding-model">2.3 Finding Model</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Finding</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Individual finding from case analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span>        <span class="c1"># Source system or tool</span>
    <span class="n">finding</span><span class="p">:</span> <span class="nb">str</span>       <span class="c1"># Description of the finding</span>
</code></pre></div>

<hr />
<h2 id="3-database-schema">3. Database Schema</h2>
<h3 id="31-core-tables">3.1 Core Tables</h3>
<h4 id="cases">cases</h4>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">cases</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">uuid_generate_v4</span><span class="p">(),</span>
<span class="w">    </span><span class="n">case_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">deployment_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">iocs</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
<span class="w">    </span><span class="n">analyst_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="nb">text</span><span class="w"> </span><span class="n">JSON</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">timeline_analysis</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="n">playbook_recommendation</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="n">analyst_recommendation</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="n">investigation_report</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_cases_case_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cases</span><span class="p">(</span><span class="n">case_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_cases_deployment_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cases</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_cases_tenant_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cases</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_cases_iocs</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cases</span><span class="p">(</span><span class="n">iocs</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_cases_status</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">cases</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
</code></pre></div>

<h4 id="case_summary">case_summary</h4>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">case_summary</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">case_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">cases</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="n">JSON</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">version</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">conclusion</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">risk_score</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">embedding</span><span class="w"> </span><span class="n">VECTOR</span><span class="p">(</span><span class="mi">1536</span><span class="p">),</span><span class="w">  </span><span class="c1">-- pgvector type</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_case_summary_conclusion</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">case_summary</span><span class="p">(</span><span class="n">conclusion</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_case_summary_risk_score</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">case_summary</span><span class="p">(</span><span class="n">risk_score</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">embedding_case_summary_idx</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">case_summary</span><span class="w"> </span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="n">hnsw</span><span class="w"> </span><span class="p">(</span><span class="n">embedding</span><span class="w"> </span><span class="n">vector_l2_ops</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">ef_construction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">);</span>
</code></pre></div>

<h4 id="playbook_tasks">playbook_tasks</h4>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">playbook_tasks</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">uuid_generate_v4</span><span class="p">(),</span>
<span class="w">    </span><span class="n">case_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">deployment_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="nb">text</span><span class="w"> </span><span class="n">JSON</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">embedding</span><span class="w"> </span><span class="n">VECTOR</span><span class="p">(</span><span class="mi">1536</span><span class="p">),</span>
<span class="w">    </span><span class="n">text_summary</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">risk_score</span><span class="w"> </span><span class="nb">FLOAT</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_playbook_tasks_case_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">playbook_tasks</span><span class="p">(</span><span class="n">case_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_playbook_tasks_risk_score</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">playbook_tasks</span><span class="p">(</span><span class="n">risk_score</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">embedding_hnsw_index</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">playbook_tasks</span><span class="w"> </span>
<span class="w">    </span><span class="k">USING</span><span class="w"> </span><span class="n">hnsw</span><span class="w"> </span><span class="p">(</span><span class="n">embedding</span><span class="w"> </span><span class="n">vector_l2_ops</span><span class="p">)</span><span class="w"> </span>
<span class="w">    </span><span class="k">WITH</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">ef_construction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">64</span><span class="p">);</span>
</code></pre></div>

<h4 id="task_classification">task_classification</h4>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">task_classification</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">playbook_task_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">playbook_tasks</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="k">version</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="n">lookup</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">action</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">playbook_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">task_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">case_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">task_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">playbook_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<span class="w">    </span><span class="n">target</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="k">source</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="n">iocs</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="k">result</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<span class="w">    </span><span class="n">malicious</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="p">,</span>
<span class="w">    </span><span class="n">malicious_reason</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<span class="w">    </span><span class="k">timestamp</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">embedding</span><span class="w"> </span><span class="n">VECTOR</span><span class="p">(</span><span class="mi">1536</span><span class="p">),</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="32-chat-thread-tables">3.2 Chat &amp; Thread Tables</h3>
<h4 id="chathistory">chathistory</h4>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">chathistory</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">uuid_generate_v4</span><span class="p">(),</span>
<span class="w">    </span><span class="k">user</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_ts</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_ts</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">message</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">deployment_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">thread_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">threads</span><span class="p">(</span><span class="n">thread_id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="p">,</span>
<span class="w">    </span><span class="n">topic</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">,</span>
<span class="w">    </span><span class="n">entity</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">message_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_chathistory_deployment_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">chathistory</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_chathistory_tenant_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">chathistory</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">);</span>
</code></pre></div>

<h4 id="threads">threads</h4>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">thread_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">uuid_generate_v4</span><span class="p">(),</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span>
<span class="w">    </span><span class="n">deployment_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">case_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
<span class="w">    </span><span class="n">user_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">entity</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
<span class="w">    </span><span class="n">created_ts</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_ts</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>

<h3 id="33-definition-tables">3.3 Definition Tables</h3>
<h4 id="playbook_definitions">playbook_definitions</h4>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">playbook_definitions</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">deployment_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">playbook_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">description</span><span class="w"> </span><span class="nb">TEXT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">categoryname</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="n">JSON</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">embedding</span><span class="w"> </span><span class="n">VECTOR</span><span class="p">(</span><span class="mi">1536</span><span class="p">),</span>
<span class="w">    </span><span class="n">eliminate_threat</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;No&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">restore_systems</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;No&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">enhance_measures</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="s1">&#39;No&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_playbook_deployment_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">playbook_definitions</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_playbook_eliminate_threat</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">playbook_definitions</span><span class="p">(</span><span class="n">eliminate_threat</span><span class="p">);</span>
</code></pre></div>

<h4 id="task_definitions">task_definitions</h4>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">task_definitions</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">deployment_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">task_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">task_type</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">integration_id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">summary</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="k">role</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
<span class="w">    </span><span class="n">embedding</span><span class="w"> </span><span class="n">VECTOR</span><span class="p">(</span><span class="mi">1536</span><span class="p">),</span>
<span class="w">    </span><span class="n">task_tag</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_ts</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_ts</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_task_definitions_task_type</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">task_definitions</span><span class="p">(</span><span class="n">task_type</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_task_definitions_task_tag</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">task_definitions</span><span class="p">(</span><span class="n">task_tag</span><span class="p">);</span>
</code></pre></div>

<h3 id="34-noise-reduction-tables">3.4 Noise Reduction Tables</h3>
<h4 id="case_suspicious_analysis">case_suspicious_analysis</h4>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">case_suspicious_analysis</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="p">,</span>
<span class="w">    </span><span class="n">case_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">cases</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">DELETE</span><span class="w"> </span><span class="k">CASCADE</span><span class="w"> </span><span class="k">UNIQUE</span><span class="p">,</span>
<span class="w">    </span><span class="n">deployment_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">tenant_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">is_novel</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">cluster_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">suspicious_score</span><span class="w"> </span><span class="nb">FLOAT</span><span class="p">,</span>
<span class="w">    </span><span class="n">suspicious_reason</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
<span class="w">    </span><span class="n">enriched_case</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="n">is_fp</span><span class="w"> </span><span class="nb">BOOLEAN</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">(),</span>
<span class="w">    </span><span class="n">updated_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">ix_case_suspicious_analysis_deployment_tenant_case</span><span class="w"> </span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">case_suspicious_analysis</span><span class="p">(</span><span class="n">deployment_id</span><span class="p">,</span><span class="w"> </span><span class="n">tenant_id</span><span class="p">,</span><span class="w"> </span><span class="n">case_id</span><span class="p">);</span>
</code></pre></div>

<h4 id="event_streams-events">event_streams &amp; events</h4>
<div class="codehilite"><pre><span></span><code><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">event_streams</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">stream_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">uuid_generate_v4</span><span class="p">(),</span>
<span class="w">    </span><span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">,</span>
<span class="w">    </span><span class="n">window_length</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">events</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">uuid_generate_v4</span><span class="p">(),</span>
<span class="w">    </span><span class="n">stream_id</span><span class="w"> </span><span class="n">UUID</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">event_streams</span><span class="p">(</span><span class="n">stream_id</span><span class="p">),</span>
<span class="w">    </span><span class="n">event_id</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">content</span><span class="w"> </span><span class="n">JSON</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">tags</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="n">embedding</span><span class="w"> </span><span class="n">VECTOR</span><span class="p">(</span><span class="mi">384</span><span class="p">),</span><span class="w">  </span><span class="c1">-- MiniLM-L6-v2</span>
<span class="w">    </span><span class="n">created_at</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span>
<span class="p">);</span>
</code></pre></div>

<hr />
<h2 id="4-api-design">4. API Design</h2>
<h3 id="41-case-analysis-endpoints">4.1 Case Analysis Endpoints</h3>
<h4 id="post-caseanalysis">POST /case/analysis</h4>
<p><strong>Request</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;case&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;deployment_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prod-001&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;tenant_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;customer-123&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;case_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CASE-2024-001&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;case_detail&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Suspicious IP 211.226.165.33 detected...&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;iocs&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;211.226.165.33, malicious-domain.com&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;findings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;source&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;VirusTotal&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;finding&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;High community score of 96/100&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Response</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;task_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;e09f6929-f562-4428-a155-0f3ccf74a1b1&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="get-caseanalysistask_id">GET /case/analysis/{task_id}</h4>
<p><strong>Response</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;task_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;e09f6929-f562-4428-a155-0f3ccf74a1b1&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;task_status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SUCCESS&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;task_result&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;result&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;executive_summary&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;conclusion&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;malicious&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;reason&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;...&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;score&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;findings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">...</span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;recommendations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="err">...</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="42-chat-endpoints">4.2 Chat Endpoints</h3>
<h4 id="post-chatcompletions">POST /chat/completions</h4>
<p><strong>Request</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;model&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;gpt-4&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;system&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;You are a security analyst assistant&quot;</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nt">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Analyze this case...&quot;</span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;stream&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>Response</strong> (Streaming):</p>
<div class="codehilite"><pre><span></span><code><span class="nx">data</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;chunk&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Based on the analysis...&quot;</span><span class="p">}</span>
<span class="nx">data</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;chunk&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot; the IP address...&quot;</span><span class="p">}</span>
<span class="nx">data</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;chunk&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot; is malicious.&quot;</span><span class="p">}</span>
</code></pre></div>

<h4 id="post-chatthread">POST /chat/thread</h4>
<p><strong>Request</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;deployment_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prod-001&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;tenant_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;customer-123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;case_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CASE-2024-001&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;entity&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;case&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Investigation Thread&quot;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="43-indexing-endpoints">4.3 Indexing Endpoints</h3>
<h4 id="post-indexingcaseplaybooktask">POST /indexing/case/playbook/task</h4>
<p><strong>Request</strong>:</p>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;tasks&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;deployment_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;prod-001&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;tenant_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;customer-123&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;case_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;CASE-2024-001&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;playbook_run_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;playbook-run-123&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;task_details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;task_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;task-456&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Check IP Reputation&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;result&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Malicious&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="err">...</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="5-service-layer">5. Service Layer</h2>
<h3 id="51-caseanalysisservice">5.1 CaseAnalysisService</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OpenAICaseAnalysisService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main service for case analysis using LLM</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">playbook_task_repo</span><span class="p">:</span> <span class="n">PlaybookTaskRepo</span><span class="p">,</span> 
                 <span class="n">model_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;llama3.1:8b&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">LLMWrapper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span> <span class="o">=</span> <span class="n">SelfRepairJsonOutputParser</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">templates_factory</span> <span class="o">=</span> <span class="n">AnalysisTemplatesFactory</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">case2template</span> <span class="o">=</span> <span class="n">Case2UserTemplateConverter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_case_analysis</span> <span class="o">=</span> <span class="n">CaseAnalysis</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

    <span class="nd">@retry</span><span class="p">((</span><span class="n">NoneResultException</span><span class="p">),</span> <span class="n">tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">backoff</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="n">Case</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Execute case analysis with retry logic</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple[dict, bool]: (result, is_cached)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">existing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_case_analysis</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">NoneResultException</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">existing</span>
</code></pre></div>

<h3 id="52-caseanalysis-engine">5.2 CaseAnalysis Engine</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CaseAnalysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Core analysis logic with RAG (Retrieval-Augmented Generation)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="n">Case</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="c1"># 1. Check cache (Redis)</span>
        <span class="n">hash_value</span> <span class="o">=</span> <span class="n">generate_hash_value</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
        <span class="n">cached_result</span> <span class="o">=</span> <span class="n">get_redis_value</span><span class="p">(</span><span class="n">hash_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cached_result</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cached_result</span><span class="p">,</span> <span class="kc">True</span>

        <span class="c1"># 2. Retrieve relevant context (Vector search)</span>
        <span class="n">question</span> <span class="o">=</span> <span class="s2">&quot;Find all threat intel lookup tasks...&quot;</span>
        <span class="n">playbook_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">playbook_task_repo</span><span class="o">.</span><span class="n">search_by_case</span><span class="p">(</span>
            <span class="n">question</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">deployment_id</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span> 
            <span class="k">case</span><span class="o">.</span><span class="n">case_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">50</span>
        <span class="p">)</span>

        <span class="c1"># 3. Build prompt</span>
        <span class="n">contexts</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">text_summary</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">playbook_tasks</span><span class="p">]</span>
        <span class="n">system_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">templates_factory</span><span class="o">.</span><span class="n">get_by_case</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
        <span class="n">user_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">case2template</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="n">contexts</span><span class="p">)</span>

        <span class="c1"># 4. Generate with LLM</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">ChatPromptTemplate</span><span class="o">.</span><span class="n">from_messages</span><span class="p">([</span>
            <span class="p">(</span><span class="s2">&quot;system&quot;</span><span class="p">,</span> <span class="n">system_template</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">user_template</span><span class="p">)</span>
        <span class="p">])</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">prompt</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">invoke</span><span class="p">({})</span>

        <span class="c1"># 5. Store in cache</span>
        <span class="n">store_redis_value</span><span class="p">(</span><span class="n">hash_value</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="kc">False</span>
</code></pre></div>

<h3 id="53-chatbotagent">5.3 ChatBotAgent</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ChatBotAgent</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles interactive chat with RAG context</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                    <span class="n">tenant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">case_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                    <span class="n">user_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                    <span class="n">prompt</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stream LLM response with context retrieval</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. Retrieve chat history</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">ChatHistory</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="n">history</span><span class="o">.</span><span class="n">get_latest_chat_history</span><span class="p">(</span><span class="n">thread_id</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>

        <span class="c1"># 2. Search relevant context</span>
        <span class="n">playbook_repo</span> <span class="o">=</span> <span class="n">PlaybookTaskRepo</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">embedding_client</span><span class="p">)</span>
        <span class="n">contexts</span> <span class="o">=</span> <span class="n">playbook_repo</span><span class="o">.</span><span class="n">search_by_case</span><span class="p">(</span>
            <span class="n">prompt</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">,</span> <span class="n">tenant_id</span><span class="p">,</span> <span class="n">case_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span>
        <span class="p">)</span>

        <span class="c1"># 3. Build RAG prompt</span>
        <span class="n">context_str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">text_summary</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">contexts</span><span class="p">])</span>
        <span class="n">full_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Context: </span><span class="si">{</span><span class="n">context_str</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">User: </span><span class="si">{</span><span class="n">prompt</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># 4. Stream response</span>
        <span class="n">llm</span> <span class="o">=</span> <span class="n">LLMWrapper</span><span class="p">(</span><span class="n">streaming</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">llm</span><span class="o">.</span><span class="n">astream</span><span class="p">(</span><span class="n">full_prompt</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">chunk</span><span class="o">.</span><span class="n">content</span>

        <span class="c1"># 5. Store in history</span>
        <span class="n">history</span><span class="o">.</span><span class="n">store_chat_history</span><span class="p">({</span>
            <span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="n">thread_id</span><span class="p">,</span>
            <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="n">user_name</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">,</span>
            <span class="s2">&quot;response&quot;</span><span class="p">:</span> <span class="n">accumulated_response</span>
        <span class="p">})</span>
</code></pre></div>

<hr />
<h2 id="6-repository-pattern">6. Repository Pattern</h2>
<h3 id="61-playbooktaskrepo">6.1 PlaybookTaskRepo</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PlaybookTaskRepo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Repository for playbook task CRUD and vector search</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">embedding</span><span class="p">:</span> <span class="n">AIEmbedding</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">PlaybookTask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PlaybookTaskModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new task with embedding&quot;&quot;&quot;</span>
        <span class="n">text_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_summary</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">task_details</span><span class="p">)</span>
        <span class="n">embedding_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">embed_text</span><span class="p">(</span><span class="n">text_summary</span><span class="p">)</span>

        <span class="n">db_task</span> <span class="o">=</span> <span class="n">PlaybookTaskModel</span><span class="p">(</span>
            <span class="n">case_id</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">case_id</span><span class="p">,</span>
            <span class="n">deployment_id</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">deployment_id</span><span class="p">,</span>
            <span class="n">tenant_id</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">task_details</span><span class="p">,</span>
            <span class="n">text_summary</span><span class="o">=</span><span class="n">text_summary</span><span class="p">,</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding_vector</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">db_task</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">db_task</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">search_by_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">tenant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">case_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                      <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">PlaybookTaskModel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Vector similarity search&quot;&quot;&quot;</span>
        <span class="n">query_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">embed_text</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">PlaybookTaskModel</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">PlaybookTaskModel</span><span class="o">.</span><span class="n">deployment_id</span> <span class="o">==</span> <span class="n">deployment_id</span><span class="p">,</span>
            <span class="n">PlaybookTaskModel</span><span class="o">.</span><span class="n">tenant_id</span> <span class="o">==</span> <span class="n">tenant_id</span><span class="p">,</span>
            <span class="n">PlaybookTaskModel</span><span class="o">.</span><span class="n">case_id</span> <span class="o">==</span> <span class="n">case_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">PlaybookTaskModel</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">l2_distance</span><span class="p">(</span><span class="n">query_embedding</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h3 id="62-caserepo">6.2 CaseRepo</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CaseRepo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Repository for case management</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="n">Case</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CaseModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new case record&quot;&quot;&quot;</span>
        <span class="n">db_case</span> <span class="o">=</span> <span class="n">CaseModel</span><span class="p">(</span>
            <span class="n">case_id</span><span class="o">=</span><span class="n">case</span><span class="o">.</span><span class="n">case_id</span><span class="p">,</span>
            <span class="n">deployment_id</span><span class="o">=</span><span class="n">case</span><span class="o">.</span><span class="n">deployment_id</span><span class="p">,</span>
            <span class="n">tenant_id</span><span class="o">=</span><span class="n">case</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span>
            <span class="n">iocs</span><span class="o">=</span><span class="n">case</span><span class="o">.</span><span class="n">iocs</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;case_detail&quot;</span><span class="p">:</span> <span class="n">case</span><span class="o">.</span><span class="n">case_detail</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">db_case</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">db_case</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case_uuid</span><span class="p">:</span> <span class="n">UUID</span><span class="p">,</span> <span class="n">summary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                   <span class="n">conclusion</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">risk_score</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CaseSummary</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add AI-generated summary&quot;&quot;&quot;</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">embed_text</span><span class="p">(</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">db_summary</span> <span class="o">=</span> <span class="n">CaseSummary</span><span class="p">(</span>
            <span class="n">case_id</span><span class="o">=</span><span class="n">case_uuid</span><span class="p">,</span>
            <span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span>
            <span class="n">conclusion</span><span class="o">=</span><span class="n">conclusion</span><span class="p">,</span>
            <span class="n">risk_score</span><span class="o">=</span><span class="n">risk_score</span><span class="p">,</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">db_summary</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">db_summary</span>
</code></pre></div>

<h3 id="63-chathistory-repo">6.3 ChatHistory Repo</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ChatHistory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Repository for chat thread and message management</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new chat thread&quot;&quot;&quot;</span>
        <span class="n">thread</span> <span class="o">=</span> <span class="n">Threads</span><span class="p">(</span>
            <span class="n">deployment_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;deployment_id&quot;</span><span class="p">],</span>
            <span class="n">tenant_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tenant_id&quot;</span><span class="p">],</span>
            <span class="n">case_id</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;case_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">],</span>
            <span class="n">entity</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="s2">&quot;case&quot;</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Thread </span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">thread</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;thread_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">thread</span><span class="o">.</span><span class="n">thread_id</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">store_chat_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Store chat message&quot;&quot;&quot;</span>
        <span class="n">chat</span> <span class="o">=</span> <span class="n">ChatHistoryModel</span><span class="p">(</span>
            <span class="n">thread_id</span><span class="o">=</span><span class="n">UUID</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;thread_id&quot;</span><span class="p">]),</span>
            <span class="n">user</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">],</span>
            <span class="n">user_id</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">),</span>
            <span class="n">message</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">],</span>
            <span class="n">deployment_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;deployment_id&quot;</span><span class="p">],</span>
            <span class="n">tenant_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;tenant_id&quot;</span><span class="p">],</span>
            <span class="n">entity</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;entity&quot;</span><span class="p">,</span> <span class="s2">&quot;case&quot;</span><span class="p">),</span>
            <span class="n">message_type</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;message_type&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">chat</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">chat</span><span class="o">.</span><span class="n">id</span><span class="p">)}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_chat_history</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thread_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">skip</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> 
                        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Retrieve paginated chat history&quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ChatHistoryModel</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">ChatHistoryModel</span><span class="o">.</span><span class="n">thread_id</span> <span class="o">==</span> <span class="n">UUID</span><span class="p">(</span><span class="n">thread_id</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">ChatHistoryModel</span><span class="o">.</span><span class="n">created_ts</span><span class="o">.</span><span class="n">desc</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">skip</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_dict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">]</span>
</code></pre></div>

<hr />
<h2 id="7-llm-integration">7. LLM Integration</h2>
<h3 id="71-llmwrapper">7.1 LLMWrapper</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LLMWrapper</span><span class="p">(</span><span class="n">Runnable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Unified LLM interface supporting multiple backends</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;MODEL_NAME&#39;</span><span class="p">),</span>
                 <span class="n">backend</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;LLM_BACKEND&#39;</span><span class="p">),</span>
                 <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">streaming</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">streaming</span>

        <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;OPENAI&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOpenAI</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                <span class="n">streaming</span><span class="o">=</span><span class="n">streaming</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># On-premise (Ollama)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">ChatOllama</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">base_url</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ONPREM_MODEL_BASE_URL&quot;</span><span class="p">),</span>
                <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
                <span class="n">streaming</span><span class="o">=</span><span class="n">streaming</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">invoke</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">]],</span> 
              <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronous invocation&quot;&quot;&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_messages</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_parser</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">astream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">BaseMessage</span><span class="p">]],</span> 
                     <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncGenerator</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Asynchronous streaming&quot;&quot;&quot;</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_messages</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">astream</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_parser</span><span class="p">:</span>
                <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">chunk</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">with_structured_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable structured output parsing&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structured_parser</span> <span class="o">=</span> <span class="n">PydanticOutputParser</span><span class="p">(</span>
            <span class="n">pydantic_object</span><span class="o">=</span><span class="n">output_class</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
</code></pre></div>

<h3 id="72-aiembedding">7.2 AIEmbedding</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AIEmbedding</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Embedding generation with multiple backends</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EMBEDDING_BACKEND&quot;</span><span class="p">,</span> <span class="s2">&quot;OPENAI&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EMBEDDING_MODEL_NAME&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;OPENAI&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;ONPREM_EMBEDDING_URL&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">embed_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate embedding vector&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;OPENAI&quot;</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">text</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">embedding</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># On-premise embedding</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/embed&quot;</span><span class="p">,</span>
                <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="n">text</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;embedding&quot;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">embed_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">texts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Batch embedding generation&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">embed_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">texts</span><span class="p">]</span>
</code></pre></div>

<hr />
<h2 id="8-message-processing">8. Message Processing</h2>
<h3 id="81-kafka-consumer-indexer">8.1 Kafka Consumer (Indexer)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">KafkaConsumer_PgvIndexer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Consumes indexing messages and stores in PostgreSQL</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">embedding</span><span class="p">:</span> <span class="n">AIEmbedding</span><span class="p">,</span>
                 <span class="n">upstream_kafka_producer</span><span class="p">:</span> <span class="n">FpProcessingProducer</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upstream_producer</span> <span class="o">=</span> <span class="n">upstream_kafka_producer</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">subscribe_and_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Main processing loop&quot;&quot;&quot;</span>
        <span class="n">consumer</span> <span class="o">=</span> <span class="n">KafkaConsumer</span><span class="p">(</span>
            <span class="n">topic</span><span class="p">,</span>
            <span class="n">bootstrap_servers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">],</span>
            <span class="n">value_deserializer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span>
            <span class="n">auto_offset_reset</span><span class="o">=</span><span class="s1">&#39;earliest&#39;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">consumer</span><span class="p">:</span>
            <span class="n">tasks</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">value</span>
            <span class="k">for</span> <span class="n">task_dict</span> <span class="ow">in</span> <span class="n">tasks</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_task</span><span class="p">(</span><span class="n">task_dict</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process individual task&quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">PlaybookTask</span><span class="p">(</span><span class="o">**</span><span class="n">task_dict</span><span class="p">)</span>

        <span class="c1"># Generate embedding</span>
        <span class="n">text_summary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_summarize_task</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">task_details</span><span class="p">)</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">embed_text</span><span class="p">(</span><span class="n">text_summary</span><span class="p">)</span>

        <span class="c1"># Store in database</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">get_session_for_tenant</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">PlaybookTaskRepo</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="p">)</span>
            <span class="n">db_task</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

            <span class="c1"># Forward to FPR processing</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upstream_producer</span><span class="o">.</span><span class="n">publish</span><span class="p">({</span>
                <span class="s2">&quot;task_id&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">db_task</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
                <span class="s2">&quot;case_id&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">case_id</span><span class="p">,</span>
                <span class="s2">&quot;tenant_id&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span>
                <span class="s2">&quot;deployment_id&quot;</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">deployment_id</span>
            <span class="p">})</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<h3 id="82-celery-worker">8.2 Celery Worker</h3>
<div class="codehilite"><pre><span></span><code><span class="nd">@celery</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;create_case_analysis_task&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_case_analysis_task</span><span class="p">(</span><span class="n">case_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Background task for case analysis</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">case</span> <span class="o">=</span> <span class="n">Case</span><span class="p">(</span><span class="o">**</span><span class="n">case_dict</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing case </span><span class="si">{</span><span class="n">case</span><span class="o">.</span><span class="n">case_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Get database session for tenant</span>
    <span class="k">with</span> <span class="n">db_session</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="c1"># Initialize services</span>
        <span class="n">playbook_task_repo</span> <span class="o">=</span> <span class="n">PlaybookTaskRepo</span><span class="p">(</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding_client</span>
        <span class="p">)</span>
        <span class="n">case_service</span> <span class="o">=</span> <span class="n">OpenAICaseAnalysisService</span><span class="p">(</span>
            <span class="n">playbook_task_repo</span><span class="o">=</span><span class="n">playbook_task_repo</span>
        <span class="p">)</span>

        <span class="c1"># Run analysis</span>
        <span class="n">result</span><span class="p">,</span> <span class="n">existing</span> <span class="o">=</span> <span class="n">case_service</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>

        <span class="c1"># Store result</span>
        <span class="n">case_repo</span> <span class="o">=</span> <span class="n">CaseRepo</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
        <span class="n">case_repo</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span>
            <span class="k">case</span><span class="o">.</span><span class="n">case_id</span><span class="p">,</span>
            <span class="n">result</span><span class="p">,</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;conclusion&quot;</span><span class="p">][</span><span class="s2">&quot;status&quot;</span><span class="p">],</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;conclusion&quot;</span><span class="p">][</span><span class="s2">&quot;score&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Trigger risk scoring (async)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">existing</span><span class="p">:</span>
            <span class="n">set_risk</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span>
                <span class="k">case</span><span class="o">.</span><span class="n">deployment_id</span><span class="p">,</span>
                <span class="k">case</span><span class="o">.</span><span class="n">tenant_id</span><span class="p">,</span>
                <span class="k">case</span><span class="o">.</span><span class="n">case_id</span><span class="p">,</span>
                <span class="k">case</span><span class="o">.</span><span class="n">case_detail</span><span class="p">,</span>
                <span class="k">case</span><span class="o">.</span><span class="n">iocs</span><span class="p">,</span>
                <span class="n">result</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="9-analysis-pipeline">9. Analysis Pipeline</h2>
<h3 id="91-template-factory">9.1 Template Factory</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AnalysisTemplatesFactory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Provides analysis prompt templates</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_by_case</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="p">:</span> <span class="n">Case</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns system prompt based on case type</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">You are an expert security analyst. Your task is to analyze </span>
<span class="s2">security cases and provide:</span>

<span class="s2">1. Executive Summary: Brief overview of the incident</span>
<span class="s2">2. Findings: Detailed findings from each source</span>
<span class="s2">3. Conclusion: Assessment (malicious/benign/suspicious) with score</span>
<span class="s2">4. Recommendations: Actionable remediation steps</span>

<span class="s2">Use the provided context from historical tasks to inform your analysis.</span>
<span class="s2">Output must be valid JSON following this structure:</span>
<span class="s2">{</span>
<span class="s2">  &quot;executive_summary&quot;: &quot;...&quot;,</span>
<span class="s2">  &quot;findings&quot;: [...],</span>
<span class="s2">  &quot;conclusion&quot;: {&quot;status&quot;: &quot;...&quot;, &quot;reason&quot;: &quot;...&quot;, &quot;score&quot;: 0-10},</span>
<span class="s2">  &quot;recommendations&quot;: [...]</span>
<span class="s2">}</span>
<span class="s2">&quot;&quot;&quot;</span>
</code></pre></div>

<h3 id="92-output-parser">9.2 Output Parser</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SelfRepairJsonOutputParser</span><span class="p">(</span><span class="n">JsonOutputParser</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    JSON parser with self-repair capability</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse LLM output with error recovery</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Try standard JSON parsing</span>
            <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON parse error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Try to repair JSON</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">json_repair</span><span class="w"> </span><span class="kn">import</span> <span class="n">repair_json</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">repaired</span> <span class="o">=</span> <span class="n">repair_json</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">repaired</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e2</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;JSON repair failed: </span><span class="si">{</span><span class="n">e2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="c1"># Last resort: extract JSON from markdown</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
                <span class="n">json_match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s1">&#39;```json\s*(\{.*?\})\s*```&#39;</span><span class="p">,</span>
                    <span class="n">text</span><span class="p">,</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">DOTALL</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">json_match</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Unable to parse JSON response&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="93-risk-scoring">9.3 Risk Scoring</h3>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_risk_and_recommendation</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span>
                                   <span class="n">deployment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="n">tenant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="n">case_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="n">case_detail</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="n">iocs</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="n">summary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
                                   <span class="n">is_novel</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                                   <span class="n">cluster_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="n">case_uuid</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate risk score and generate recommendations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># 1. Extract features</span>
    <span class="n">conclusion</span> <span class="o">=</span> <span class="n">summary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;conclusion&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">base_score</span> <span class="o">=</span> <span class="n">conclusion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">conclusion</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>

    <span class="c1"># 2. Adjust score based on factors</span>
    <span class="n">risk_score</span> <span class="o">=</span> <span class="n">base_score</span>

    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;malicious&quot;</span><span class="p">:</span>
        <span class="n">risk_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">risk_score</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;suspicious&quot;</span><span class="p">:</span>
        <span class="n">risk_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">risk_score</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">is_novel</span><span class="p">:</span>
        <span class="n">risk_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">risk_score</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">iocs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>  <span class="c1"># Multiple IOCs</span>
        <span class="n">risk_score</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">risk_score</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="c1"># 3. Generate recommendations</span>
    <span class="n">recommendations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">risk_score</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="s2">&quot;critical&quot;</span><span class="p">,</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;Immediate investigation required&quot;</span>
        <span class="p">})</span>
    <span class="k">elif</span> <span class="n">risk_score</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">recommendations</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;priority&quot;</span><span class="p">:</span> <span class="s2">&quot;high&quot;</span><span class="p">,</span>
            <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="s2">&quot;Review within 4 hours&quot;</span>
        <span class="p">})</span>

    <span class="c1"># 4. Store in database</span>
    <span class="n">case_repo</span> <span class="o">=</span> <span class="n">CaseRepo</span><span class="p">(</span><span class="n">session</span><span class="p">)</span>
    <span class="n">case_repo</span><span class="o">.</span><span class="n">update_risk_score</span><span class="p">(</span><span class="n">case_uuid</span><span class="p">,</span> <span class="n">risk_score</span><span class="p">)</span>
    <span class="n">case_repo</span><span class="o">.</span><span class="n">add_recommendations</span><span class="p">(</span><span class="n">case_uuid</span><span class="p">,</span> <span class="n">recommendations</span><span class="p">)</span>
</code></pre></div>

<hr />
<h2 id="10-false-positive-reduction">10. False Positive Reduction</h2>
<h3 id="101-fpr-worker">10.1 FPR Worker</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CaseFPReductionWorker</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main worker for false positive reduction</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">FPReductionConfig</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nds_client</span> <span class="o">=</span> <span class="n">NDSClient</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding_client</span> <span class="o">=</span> <span class="n">AIEmbedding</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_buffer</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">start_fpr_case_processor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process enriched cases&quot;&quot;&quot;</span>
        <span class="n">consumer</span> <span class="o">=</span> <span class="n">KafkaConsumer</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processing_topic</span><span class="p">,</span>
            <span class="n">bootstrap_servers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">kafka_broker</span><span class="p">],</span>
            <span class="n">value_deserializer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)),</span>
            <span class="n">group_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">processing_group_id</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">consumer</span><span class="p">:</span>
            <span class="n">case</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">value</span>
            <span class="n">tenant_id</span> <span class="o">=</span> <span class="n">case</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tenant_id&quot;</span><span class="p">)</span>

            <span class="c1"># Buffer cases by tenant</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_buffer</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>

            <span class="c1"># Process when batch is full</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_buffer</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_tenant_batch</span><span class="p">(</span>
                    <span class="k">case</span><span class="p">[</span><span class="s2">&quot;deployment_id&quot;</span><span class="p">],</span>
                    <span class="n">tenant_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_buffer</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">batch_buffer</span><span class="p">[</span><span class="n">tenant_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_tenant_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">tenant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">cases</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">dict</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process batch of cases&quot;&quot;&quot;</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">get_session_for_tenant</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">case</span> <span class="ow">in</span> <span class="n">cases</span><span class="p">:</span>
                <span class="c1"># 1. Build features</span>
                <span class="n">features</span> <span class="o">=</span> <span class="n">FeatureBuilderModuleV2</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>

                <span class="c1"># 2. Check novelty</span>
                <span class="n">novelty_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nds_client</span><span class="o">.</span><span class="n">check_novelty</span><span class="p">(</span>
                    <span class="n">deployment_id</span><span class="p">,</span>
                    <span class="n">tenant_id</span><span class="p">,</span>
                    <span class="n">case</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nds_window_length</span>
                <span class="p">)</span>

                <span class="c1"># 3. Score suspiciousness</span>
                <span class="n">score</span><span class="p">,</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">SuspiciousScoringModule</span><span class="o">.</span><span class="n">score</span><span class="p">(</span>
                    <span class="n">case</span><span class="p">,</span>
                    <span class="n">features</span><span class="p">,</span>
                    <span class="n">novelty_result</span>
                <span class="p">)</span>

                <span class="c1"># 4. Classify as FP or legit</span>
                <span class="n">is_fp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_classify_fp</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">novelty_result</span><span class="p">)</span>

                <span class="c1"># 5. Store results</span>
                <span class="n">upsert_case_suspicious_analysis</span><span class="p">(</span>
                    <span class="n">db</span><span class="p">,</span>
                    <span class="k">case</span><span class="p">[</span><span class="s2">&quot;case_id&quot;</span><span class="p">],</span>
                    <span class="n">deployment_id</span><span class="p">,</span>
                    <span class="n">tenant_id</span><span class="p">,</span>
                    <span class="n">novelty_result</span><span class="p">[</span><span class="s2">&quot;is_novel&quot;</span><span class="p">],</span>
                    <span class="n">novelty_result</span><span class="p">[</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">],</span>
                    <span class="n">score</span><span class="p">,</span>
                    <span class="n">reason</span><span class="p">,</span>
                    <span class="n">is_fp</span>
                <span class="p">)</span>

                <span class="c1"># 6. Update case status</span>
                <span class="k">if</span> <span class="n">is_fp</span><span class="p">:</span>
                    <span class="n">set_case_as_noise</span><span class="p">(</span>
                        <span class="n">db</span><span class="p">,</span>
                        <span class="n">deployment_id</span><span class="p">,</span>
                        <span class="n">tenant_id</span><span class="p">,</span>
                        <span class="k">case</span><span class="p">[</span><span class="s2">&quot;case_id&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_classify_fp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">score</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">novelty</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if case is false positive&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">novelty</span><span class="p">[</span><span class="s2">&quot;is_novel&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mf">3.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">score</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>

<h3 id="102-feature-builder">10.2 Feature Builder</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FeatureBuilderModuleV2</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract ML features from case data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="n">case</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build feature vector</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># IOC features</span>
            <span class="s2">&quot;num_iocs&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iocs&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;has_ip&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\d+\.\d+\.\d+\.\d+&#39;</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iocs&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))),</span>
            <span class="s2">&quot;has_domain&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[a-z0-9-]+\.[a-z]{2,}&#39;</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iocs&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))),</span>
            <span class="s2">&quot;has_hash&quot;</span><span class="p">:</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;[a-f0-9]{32,64}&#39;</span><span class="p">,</span> <span class="n">case</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;iocs&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))),</span>

            <span class="c1"># Case features</span>
            <span class="s2">&quot;case_length&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;case_detail&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)),</span>
            <span class="s2">&quot;num_findings&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">case</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;findings&quot;</span><span class="p">,</span> <span class="p">[])),</span>

            <span class="c1"># Temporal features</span>
            <span class="s2">&quot;hour_of_day&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
            <span class="s2">&quot;day_of_week&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">weekday</span><span class="p">(),</span>

            <span class="c1"># Text features</span>
            <span class="s2">&quot;contains_malicious&quot;</span><span class="p">:</span> <span class="s2">&quot;malicious&quot;</span> <span class="ow">in</span> <span class="n">case</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;case_detail&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
            <span class="s2">&quot;contains_suspicious&quot;</span><span class="p">:</span> <span class="s2">&quot;suspicious&quot;</span> <span class="ow">in</span> <span class="n">case</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;case_detail&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">features</span>
</code></pre></div>

<h3 id="103-novelty-detection-client">10.3 Novelty Detection Client</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NDSClient</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Client for Novelty Detection Service</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;NDS_API_URL&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_novelty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deployment_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tenant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">case</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">window_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if case is novel</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Generate embedding for case</span>
        <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_embedding</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>

        <span class="c1"># Call NDS API</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/api/v1/novelty/check&quot;</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;stream_id&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">deployment_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">tenant_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s2">&quot;event_id&quot;</span><span class="p">:</span> <span class="n">case</span><span class="p">[</span><span class="s2">&quot;case_id&quot;</span><span class="p">],</span>
                <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="n">case</span><span class="p">,</span>
                <span class="s2">&quot;embedding&quot;</span><span class="p">:</span> <span class="n">embedding</span><span class="p">,</span>
                <span class="s2">&quot;window_length&quot;</span><span class="p">:</span> <span class="n">window_length</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;is_novel&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;is_novel&quot;</span><span class="p">],</span>
            <span class="s2">&quot;similarity_score&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;similarity_score&quot;</span><span class="p">],</span>
            <span class="s2">&quot;similar_cases&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;similar_event_ids&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s2">&quot;cluster_id&quot;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">}</span>
</code></pre></div>

<hr />
<h2 id="11-implementation-diagrams">11. Implementation Diagrams</h2>
<h3 id="111-component-interaction-diagram">11.1 Component Interaction Diagram</h3>
<div class="mermaid">
graph TB
    subgraph FastAPIApp["FastAPI Application"]
        MAIN[main.py<br/>Application Entry]

        subgraph Routers
            R1[case.router]
            R2[chat.router]
            R3[index.router]
            R4[user.router]
            R5[tenant.router]
            R6[application.router]
            R7[code.router]
        end

        subgraph Services
            S1[CaseAnalysisService]
            S2[ChatBotAgent]
            S3[IndexingService]
            S4[CaseInformation]
            S5[UserInfo]
            S6[TenantManager]
        end

        subgraph Repositories
            REP1[CaseRepo]
            REP2[PlaybookTaskRepo]
            REP3[ChatHistory]
            REP4[UserRepo]
            REP5[TenantRepo]
            REP6[ApplicationRepo]
        end

        MAIN --> R1
        MAIN --> R2
        MAIN --> R3
        MAIN --> R4
        MAIN --> R5
        MAIN --> R6
        MAIN --> R7

        R1 --> S1
        R2 --> S2
        R3 --> S3
        R1 --> S4
        R4 --> S5
        R5 --> S6

        S1 --> REP1
        S1 --> REP2
        S2 --> REP2
        S2 --> REP3
        S4 --> REP1
        S5 --> REP4
        S6 --> REP5
    end

    subgraph DatabaseLayer["Database Layer"]
        DB[(PostgreSQL)]
        CACHE[(Redis)]
    end

    REP1 --> DB
    REP2 --> DB
    REP3 --> DB
    REP4 --> DB
    REP5 --> DB
    REP6 --> DB

    S1 --> CACHE
    S2 --> CACHE

    classDef entry fill:#ffcc99,stroke:#333,stroke-width:2px
    classDef database fill:#99ff99,stroke:#333,stroke-width:2px
    classDef cache fill:#ff9999,stroke:#333,stroke-width:2px

    class MAIN entry
    class DB database
    class CACHE cache
</div>

<h3 id="112-llm-integration-architecture">11.2 LLM Integration Architecture</h3>
<div class="mermaid">
graph TB
    subgraph AppLayer["Application Layer"]
        SRVICE[Analysis Services]
        CHAT[Chat Services]
    end

    subgraph WrapperLayer["LLM Wrapper Layer"]
        WRAPPER[LLMWrapper<br/>Unified Interface]

        subgraph Configuration
            CONFIG{LLM_BACKEND}
        end

        subgraph Implementations
            OPENAI[ChatOpenAI]
            OLLAMA[ChatOllama]
        end
    end

    subgraph Features
        STREAM[Streaming Support]
        STRUCT[Structured Output]
        PARSE[Output Parsing]
        RETRY[Retry Logic]
    end

    subgraph LLMProviders["External LLM Providers"]
        GPT[OpenAI<br/>GPT-4/3.5]
        GROQ[Groq<br/>Llama3]
        GEMINI[Google<br/>Gemini]
        ONPREM[On-Premise<br/>Ollama]
    end

    subgraph Security
        DTX[DTX Prompt Guard<br/>Injection Prevention]
    end

    SRVICE --> WRAPPER
    CHAT --> WRAPPER

    WRAPPER --> CONFIG
    CONFIG -->|OPENAI| OPENAI
    CONFIG -->|ONPREM| OLLAMA

    WRAPPER --> STREAM
    WRAPPER --> STRUCT
    WRAPPER --> PARSE
    WRAPPER --> RETRY

    OPENAI --> GPT
    OPENAI --> GEMINI
    OPENAI --> GROQ
    OLLAMA --> ONPREM

    SRVICE --> DTX
    CHAT --> DTX

    classDef wrapper fill:#99ccff,stroke:#333,stroke-width:2px
    classDef config fill:#ffcc99,stroke:#333,stroke-width:2px
    classDef security fill:#ff9999,stroke:#333,stroke-width:2px

    class WRAPPER wrapper
    class CONFIG config
    class DTX security
</div>

<h3 id="113-vector-search-implementation">11.3 Vector Search Implementation</h3>
<div class="mermaid">
flowchart LR
    subgraph "Input"
        TEXT[Text Input<br/>Task/Case/Query]
    end

    subgraph "Embedding Generation"
        CHECK{Embedding<br/>Backend}
        OPENAI_EMBED[OpenAI<br/>text-embedding-ada-002]
        ONPREM_EMBED[On-Premise<br/>Embedding API]
    end

    subgraph "Vector Storage"
        PG[(PostgreSQL<br/>pgvector)]
        CHROMA[(ChromaDB<br/>Optional)]
    end

    subgraph "Vector Search"
        QUERY[Query Vector]
        SIMILARITY[Calculate Similarity<br/>L2 Distance]
        HNSW[HNSW Index<br/>Approximate NN]
        FILTER[Apply Filters<br/>tenant_id, case_id]
    end

    subgraph "Output"
        RESULTS[Top-K Results]
        RERANK[Optional Re-ranking]
        FINAL[Final Context]
    end

    TEXT --> CHECK
    CHECK -->|OPENAI| OPENAI_EMBED
    CHECK -->|ONPREM| ONPREM_EMBED

    OPENAI_EMBED --> VECTOR[Embedding Vector<br/>1536 dimensions]
    ONPREM_EMBED --> VECTOR

    VECTOR --> PG
    VECTOR -.-> CHROMA

    QUERY --> SIMILARITY
    SIMILARITY --> HNSW
    HNSW --> PG
    HNSW -.-> CHROMA

    PG --> FILTER
    CHROMA -.-> FILTER

    FILTER --> RESULTS
    RESULTS --> RERANK
    RERANK --> FINAL

    style TEXT fill:#99ff99
    style VECTOR fill:#ffcc99
    style PG fill:#99ccff
    style FINAL fill:#ff99ff
</div>

<h3 id="114-celery-task-state-machine">11.4 Celery Task State Machine</h3>
<div class="mermaid">
stateDiagram-v2
    [*] --> Pending: Task Queued

    Pending --> Running: Worker Picks Up

    Running --> CheckCache: Start Processing

    CheckCache --> CacheHit: Found in Redis
    CheckCache --> CacheMiss: Not Found

    CacheHit --> Success: Return Cached

    CacheMiss --> VectorSearch: Retrieve Context
    VectorSearch --> LLMGeneration: Build Prompt
    LLMGeneration --> Parsing: Parse Response

    Parsing --> ParseSuccess: Valid JSON
    Parsing --> ParseFailed: Invalid JSON

    ParseFailed --> Retry: Attempt Repair
    Retry --> Parsing: Re-parse
    Retry --> Failure: Max Retries

    ParseSuccess --> StoreDB: Save Results
    StoreDB --> StoreCache: Cache for Future
    StoreCache --> TriggerRisk: Background Task
    TriggerRisk --> Success: Complete

    Success --> [*]
    Failure --> [*]
</div>

<h3 id="115-kafka-topic-flow">11.5 Kafka Topic Flow</h3>
<div class="mermaid">
flowchart LR
    subgraph Producers
        CLI[CLI Indexer]
        API[API Service]
        INDEXER[Kafka Indexer]
        FPR[FPR Processor]
    end

    subgraph Topics
        T1[(indexing-topic)]
        T2[(fpr-processing)]
        T3[(fpr-results)]
    end

    subgraph Consumers
        C1[Kafka Indexer]
        C2[FPR Processor]
        C3[Results Consumer]
    end

    subgraph ConsumerGroups["Consumer Groups"]
        G1[indexing_group]
        G2[fp_reduction_group]
        G3[results_group]
    end

    CLI --> T1
    API --> T1

    T1 --> C1
    C1 -.-> G1

    INDEXER --> T2

    T2 --> C2
    C2 -.-> G2

    FPR --> T3

    T3 --> C3
    C3 -.-> G3

    classDef topic fill:#ffcc99,stroke:#333,stroke-width:2px
    classDef consumer fill:#99ccff,stroke:#333,stroke-width:2px

    class T1,T2,T3 topic
    class C1,C2,C3 consumer
</div>

<h3 id="116-sequence-diagram-case-analysis-flow">11.6 Sequence Diagram: Case Analysis Flow</h3>
<div class="mermaid">
sequenceDiagram
    participant Client
    participant TykGW as Tyk Gateway
    participant FastAPI
    participant Celery
    participant Worker
    participant DB as PostgreSQL
    participant LLM
    participant Redis

    Client->>TykGW: POST /case/analysis
    TykGW->>FastAPI: Authenticate & Forward
    FastAPI->>Celery: Queue Task
    Celery-->>FastAPI: task_id
    FastAPI-->>Client: {task_id}

    Worker->>Redis: Check Cache
    alt Cache Hit
        Redis-->>Worker: Cached Result
    else Cache Miss
        Worker->>DB: Search Similar Tasks
        DB-->>Worker: Context Tasks
        Worker->>LLM: Generate Analysis
        LLM-->>Worker: Analysis Result
        Worker->>Redis: Store Cache
    end

    Worker->>DB: Store Summary
    Worker->>Celery: Trigger Risk Scoring

    Client->>FastAPI: GET /case/analysis/{task_id}
    FastAPI->>Celery: Get Result
    Celery-->>FastAPI: Result
    FastAPI-->>Client: Analysis Result
</div>

<h3 id="112-task-indexing-flow">11.2 Task Indexing Flow</h3>
<div class="mermaid">
sequenceDiagram
    participant CLI
    participant Kafka
    participant Indexer
    participant Embed as Embedding Service
    participant DB as PostgreSQL
    participant FPR as FPR Processor

    CLI->>Kafka: Publish Tasks
    Kafka-->>Indexer: Consume Message

    loop For Each Task
        Indexer->>Indexer: Extract Text
        Indexer->>Embed: Generate Embedding
        Embed-->>Indexer: Vector
        Indexer->>DB: Store Task + Vector
        Indexer->>Kafka: Publish to FPR Topic
    end

    Kafka-->>FPR: Consume Enriched Case
    FPR->>FPR: Build Features
    FPR->>FPR: Check Novelty
    FPR->>FPR: Score Suspiciousness
    FPR->>DB: Update Analysis
</div>

<h3 id="113-chat-flow-with-rag">11.3 Chat Flow with RAG</h3>
<div class="mermaid">
sequenceDiagram
    participant Client
    participant FastAPI
    participant ChatAgent
    participant DB as PostgreSQL
    participant VectorDB
    participant LLM

    Client->>FastAPI: POST /chat/completions (stream=true)
    FastAPI->>ChatAgent: Process Request

    ChatAgent->>DB: Get Thread History
    DB-->>ChatAgent: Recent Messages

    ChatAgent->>VectorDB: Semantic Search
    VectorDB-->>ChatAgent: Relevant Context

    ChatAgent->>ChatAgent: Build RAG Prompt
    ChatAgent->>LLM: Stream Request

    loop Streaming
        LLM-->>ChatAgent: Chunk
        ChatAgent-->>FastAPI: Chunk
        FastAPI-->>Client: Stream Chunk
    end

    ChatAgent->>DB: Store Message
</div>

<h3 id="114-repository-pattern-class-diagram">11.4 Repository Pattern Class Diagram</h3>
<div class="mermaid">
classDiagram
    class BaseRepository~T~ {
        <<abstract>>
        #db: Session
        #tenant_id: str
        +create(entity: T) T
        +get(id: str) Optional~T~
        +update(entity: T) T
        +delete(id: str) bool
        +list(filters: dict) List~T~
    }

    class CaseRepository {
        +get_by_case_id(case_id: str) Case
        +get_by_status(status: str) List~Case~
        +update_summary(case_id: str, summary: str)
        +update_risk(case_id: str, risk: str)
        +set_as_noise(case_id: str)
    }

    class PlaybookTaskRepository {
        +search_by_case(query: str, case_id: str, limit: int) List~Task~
        +search_by_deployment(query: str, deployment_id: str) List~Task~
        +get_by_embedding(vector: List~float~) List~Task~
        +bulk_insert(tasks: List~Task~)
    }

    class ChatHistoryRepository {
        +create_thread(case_id: str, user_id: int) Thread
        +add_message(thread_id: str, role: str, content: str) Message
        +get_history(thread_id: str, limit: int) List~Message~
        +update_message(msg_id: str, content: str)
    }

    class TaskClassificationRepository {
        +classify_task(task_id: str, category: str)
        +get_classification(task_id: str) Classification
        +bulk_classify(classifications: List)
    }

    class CaseSummaryRepository {
        +store_summary(case_id: str, summary: dict)
        +get_summary(case_id: str) dict
        +update_analysis(case_id: str, analysis: dict)
    }

    BaseRepository <|-- CaseRepository
    BaseRepository <|-- PlaybookTaskRepository
    BaseRepository <|-- ChatHistoryRepository
    BaseRepository <|-- TaskClassificationRepository
    BaseRepository <|-- CaseSummaryRepository

    class EmbeddingClient {
        <<interface>>
        +create_embedding(text: str) List~float~
        +batch_create(texts: List~str~) List~List~float~~
    }

    class OpenAIEmbedding
    class OnPremiseEmbedding

    EmbeddingClient <|.. OpenAIEmbedding
    EmbeddingClient <|.. OnPremiseEmbedding

    PlaybookTaskRepository --> EmbeddingClient : uses
</div>

<h3 id="115-tenant-onboarding-workflow">11.5 Tenant Onboarding Workflow</h3>
<div class="mermaid">
sequenceDiagram
    participant Admin
    participant API as API Gateway
    participant TenantSvc as Tenant Service
    participant DB as PostgreSQL
    participant Kafka
    participant IndexSvc as Indexing Service

    Admin->>API: POST /tenants<br/>{name, config}
    API->>TenantSvc: create_tenant(tenant_info)

    TenantSvc->>DB: Create siadb_<tenant_id>
    DB-->>TenantSvc: Database created

    TenantSvc->>DB: Run Alembic migrations
    DB-->>TenantSvc: Schema initialized

    TenantSvc->>DB: INSERT INTO tenants
    DB-->>TenantSvc: Tenant record created

    TenantSvc->>Kafka: Publish tenant_created event

    TenantSvc-->>API: {tenant_id, status: "active"}
    API-->>Admin: Tenant created successfully

    Kafka->>IndexSvc: tenant_created event
    IndexSvc->>IndexSvc: Create embedding collections
    IndexSvc->>DB: Initialize vector indexes

    Note over IndexSvc: Background initialization<br/>completes asynchronously
</div>

<h3 id="116-error-handling-flow">11.6 Error Handling Flow</h3>
<div class="mermaid">
flowchart TD
    START[API Request] --> VALIDATE{Valid<br/>Request?}

    VALIDATE -->|No| ERROR_400[Return 400<br/>Bad Request]
    VALIDATE -->|Yes| AUTH{Authenticated?}

    AUTH -->|No| ERROR_401[Return 401<br/>Unauthorized]
    AUTH -->|Yes| AUTHZ{Authorized?}

    AUTHZ -->|No| ERROR_403[Return 403<br/>Forbidden]
    AUTHZ -->|Yes| PROCESS[Process Request]

    PROCESS --> TRY{Success?}

    TRY -->|DB Error| RETRY{Retryable?}
    TRY -->|LLM Error| LLM_RETRY{Retry Count?}
    TRY -->|External API Error| EXT_RETRY{Can Retry?}
    TRY -->|Success| SUCCESS[Return 200<br/>Success]

    RETRY -->|Yes| WAIT1[Exponential Backoff]
    RETRY -->|No| ERROR_500[Return 500<br/>Internal Error]

    LLM_RETRY -->|< Max| WAIT2[Backoff + Retry]
    LLM_RETRY -->|>= Max| ERROR_503[Return 503<br/>Service Unavailable]

    EXT_RETRY -->|Yes| WAIT3[Retry with Timeout]
    EXT_RETRY -->|No| ERROR_502[Return 502<br/>Bad Gateway]

    WAIT1 --> PROCESS
    WAIT2 --> PROCESS
    WAIT3 --> PROCESS

    ERROR_400 --> LOG[Log Error]
    ERROR_401 --> LOG
    ERROR_403 --> LOG
    ERROR_500 --> LOG
    ERROR_502 --> LOG
    ERROR_503 --> LOG

    LOG --> ALERT{Critical?}
    ALERT -->|Yes| NOTIFY[Send Alert]
    ALERT -->|No| METRIC[Update Metrics]

    NOTIFY --> METRIC
    METRIC --> END[End]
    SUCCESS --> END

    style SUCCESS fill:#99ff99
    style ERROR_400 fill:#ff9999
    style ERROR_401 fill:#ff9999
    style ERROR_403 fill:#ff9999
    style ERROR_500 fill:#ff9999
    style ERROR_502 fill:#ff9999
    style ERROR_503 fill:#ff9999
</div>

<hr />
<h2 id="12-class-diagrams">12. Class Diagrams</h2>
<h3 id="121-domain-model">12.1 Domain Model</h3>
<div class="mermaid">
classDiagram
    class Case {
        +str deployment_id
        +str tenant_id
        +str case_id
        +str case_detail
        +str iocs
        +List~Finding~ findings
        +to_dict() dict
        +check_non_empty_fields()
    }

    class Finding {
        +str source
        +str finding
    }

    class PlaybookTask {
        +str deployment_id
        +str tenant_id
        +str case_id
        +str playbook_run_id
        +dict task_details
        +to_dict() dict
    }

    Case "1" --> "*" Finding : contains
</div>

<h3 id="122-service-layer">12.2 Service Layer</h3>
<div class="mermaid">
classDiagram
    class OpenAICaseAnalysisService {
        -LLMWrapper model
        -SelfRepairJsonOutputParser parser
        -CaseAnalysis _case_analysis
        +run(case: Case) Tuple
    }

    class CaseAnalysis {
        -model
        -templates_factory
        -case2template
        -parser
        -playbook_task_repo
        +run(case: Case) Tuple
    }

    class ChatBotAgent {
        -Session session
        +stream() AsyncGenerator
        +extract_parameters() dict
    }

    OpenAICaseAnalysisService --> CaseAnalysis : uses
    CaseAnalysis --> PlaybookTaskRepo : queries
    ChatBotAgent --> PlaybookTaskRepo : queries
</div>

<h3 id="123-repository-layer">12.3 Repository Layer</h3>
<div class="mermaid">
classDiagram
    class PlaybookTaskRepo {
        -Session session
        -AIEmbedding embedding
        +add_task(task) PlaybookTaskModel
        +search_by_case() List
        +update_risk_score()
    }

    class CaseRepo {
        -Session session
        -AIEmbedding embedding
        +create_case() CaseModel
        +add_summary() CaseSummary
        +get_by_case_id() CaseModel
    }

    class ChatHistory {
        -Session session
        +add_thread() dict
        +store_chat_history() dict
        +get_chat_history() List
    }

    PlaybookTaskRepo --> PlaybookTaskModel : manages
    CaseRepo --> CaseModel : manages
    CaseRepo --> CaseSummary : manages
    ChatHistory --> Threads : manages
    ChatHistory --> ChatHistoryModel : manages
</div>

<h3 id="124-llm-integration">12.4 LLM Integration</h3>
<div class="mermaid">
classDiagram
    class LLMWrapper {
        -str backend
        -str model
        -float temperature
        -bool streaming
        -llm
        +invoke() Any
        +stream() Generator
        +astream() AsyncGenerator
        +with_structured_output()
    }

    class AIEmbedding {
        -str backend
        -str model
        +embed_text(text) List~float~
        +embed_batch(texts) List
    }

    class SelfRepairJsonOutputParser {
        +parse(text) dict
    }

    LLMWrapper --> ChatOpenAI : "backend=OPENAI"
    LLMWrapper --> ChatOllama : "backend=ONPREM"
    LLMWrapper --> SelfRepairJsonOutputParser : uses
</div>

<hr />
<h2 id="13-key-design-patterns">13. Key Design Patterns</h2>
<h3 id="131-repository-pattern">13.1 Repository Pattern</h3>
<ul>
<li><strong>Purpose</strong>: Abstract data access logic</li>
<li><strong>Implementation</strong>: Separate repository classes for each entity</li>
<li><strong>Benefits</strong>: Testability, decoupling, consistency</li>
</ul>
<h3 id="132-dependency-injection">13.2 Dependency Injection</h3>
<ul>
<li><strong>Purpose</strong>: Manage dependencies cleanly</li>
<li><strong>Implementation</strong>: FastAPI Depends(), constructor injection</li>
<li><strong>Benefits</strong>: Testability, flexibility, loose coupling</li>
</ul>
<h3 id="133-strategy-pattern">13.3 Strategy Pattern</h3>
<ul>
<li><strong>Purpose</strong>: Switch LLM backends dynamically</li>
<li><strong>Implementation</strong>: LLMWrapper with backend selection</li>
<li><strong>Benefits</strong>: Flexibility, extensibility</li>
</ul>
<h3 id="134-observer-pattern">13.4 Observer Pattern</h3>
<ul>
<li><strong>Purpose</strong>: Event-driven processing</li>
<li><strong>Implementation</strong>: Kafka pub/sub</li>
<li><strong>Benefits</strong>: Scalability, decoupling</li>
</ul>
<h3 id="135-factory-pattern">13.5 Factory Pattern</h3>
<ul>
<li><strong>Purpose</strong>: Create objects based on type</li>
<li><strong>Implementation</strong>: AnalysisTemplatesFactory</li>
<li><strong>Benefits</strong>: Centralized creation logic</li>
</ul>
<hr />
<h2 id="14-error-handling">14. Error Handling</h2>
<h3 id="141-exception-hierarchy">14.1 Exception Hierarchy</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SiaException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">InvalidInputException</span><span class="p">(</span><span class="n">SiaException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Invalid user input&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">NoneResultException</span><span class="p">(</span><span class="n">SiaException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;LLM returned None&quot;&quot;&quot;</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DatabaseException</span><span class="p">(</span><span class="n">SiaException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Database operation failed&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</code></pre></div>

<h3 id="142-retry-logic">14.2 Retry Logic</h3>
<div class="codehilite"><pre><span></span><code><span class="nd">@retry</span><span class="p">((</span><span class="n">NoneResultException</span><span class="p">),</span> <span class="n">tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">backoff</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_analysis</span><span class="p">(</span><span class="n">case</span><span class="p">:</span> <span class="n">Case</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retry on specific exceptions&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">analyze</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoneResultException</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<hr />
<h2 id="15-performance-optimizations">15. Performance Optimizations</h2>
<h3 id="151-caching-strategy">15.1 Caching Strategy</h3>
<ul>
<li><strong>Redis</strong>: LLM response caching</li>
<li><strong>Hash-based keys</strong>: Deterministic cache hits</li>
<li><strong>TTL</strong>: Configurable expiration</li>
</ul>
<h3 id="152-vector-search-optimization">15.2 Vector Search Optimization</h3>
<ul>
<li><strong>HNSW Index</strong>: Fast approximate nearest neighbor</li>
<li><strong>Batch Processing</strong>: Group operations</li>
<li><strong>Selective Filtering</strong>: Reduce search space</li>
</ul>
<h3 id="153-connection-pooling">15.3 Connection Pooling</h3>
<ul>
<li><strong>SQLAlchemy</strong>: Automatic connection pooling</li>
<li><strong>Redis</strong>: Connection pool configuration</li>
<li><strong>Kafka</strong>: Reusable consumers</li>
</ul>
<hr />
<h2 id="15-testing-strategy">15. Testing Strategy</h2>
<h3 id="151-unit-testing">15.1 Unit Testing</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/apis/test_case_service.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siaservice.apis.services.cases</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpenAICaseAnalysisService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siaservice.domain.soar.cases</span><span class="w"> </span><span class="kn">import</span> <span class="n">Case</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">mock_playbook_repo</span><span class="p">(</span><span class="n">mocker</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">mocker</span><span class="o">.</span><span class="n">Mock</span><span class="p">()</span>
    <span class="n">repo</span><span class="o">.</span><span class="n">search_by_case</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="n">repo</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">case_service</span><span class="p">(</span><span class="n">mock_playbook_repo</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">OpenAICaseAnalysisService</span><span class="p">(</span>
        <span class="n">playbook_task_repo</span><span class="o">=</span><span class="n">mock_playbook_repo</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_case_analysis_success</span><span class="p">(</span><span class="n">case_service</span><span class="p">):</span>
    <span class="n">case</span> <span class="o">=</span> <span class="n">Case</span><span class="p">(</span>
        <span class="n">deployment_id</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="n">tenant_id</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span>
        <span class="n">case_id</span><span class="o">=</span><span class="s2">&quot;CASE-001&quot;</span><span class="p">,</span>
        <span class="n">case_detail</span><span class="o">=</span><span class="s2">&quot;Test case&quot;</span><span class="p">,</span>
        <span class="n">iocs</span><span class="o">=</span><span class="s2">&quot;192.168.1.1&quot;</span>
    <span class="p">)</span>

    <span class="n">result</span><span class="p">,</span> <span class="n">is_cached</span> <span class="o">=</span> <span class="n">case_service</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">case</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
    <span class="k">assert</span> <span class="s2">&quot;executive_summary&quot;</span> <span class="ow">in</span> <span class="n">result</span>
    <span class="k">assert</span> <span class="s2">&quot;conclusion&quot;</span> <span class="ow">in</span> <span class="n">result</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">is_cached</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span>
</code></pre></div>

<h3 id="152-integration-testing">15.2 Integration Testing</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/integration/test_case_flow.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi.testclient</span><span class="w"> </span><span class="kn">import</span> <span class="n">TestClient</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">main</span><span class="w"> </span><span class="kn">import</span> <span class="n">app</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span>
<span class="k">def</span><span class="w"> </span><span class="nf">client</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">TestClient</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_case_analysis_flow</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="c1"># Submit case</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
        <span class="s2">&quot;/case/analysis&quot;</span><span class="p">,</span>
        <span class="n">json</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;deployment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tenant_id&quot;</span><span class="p">:</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span>
                <span class="s2">&quot;case_id&quot;</span><span class="p">:</span> <span class="s2">&quot;CASE-001&quot;</span><span class="p">,</span>
                <span class="s2">&quot;case_detail&quot;</span><span class="p">:</span> <span class="s2">&quot;Test&quot;</span><span class="p">,</span>
                <span class="s2">&quot;iocs&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.1.1&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">201</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;task_id&quot;</span><span class="p">]</span>

    <span class="c1"># Poll for result</span>
    <span class="n">result_response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;/case/analysis/</span><span class="si">{</span><span class="n">task_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</code></pre></div>

<h3 id="153-performance-testing">15.3 Performance Testing</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># tests/performance/test_vector_search.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pytest</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siaservice.repositories.playbook_tasks_repo</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlaybookTaskRepo</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_vector_search_performance</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">embedding_client</span><span class="p">):</span>
    <span class="n">repo</span> <span class="o">=</span> <span class="n">PlaybookTaskRepo</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">embedding_client</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">repo</span><span class="o">.</span><span class="n">search_by_case</span><span class="p">(</span>
        <span class="s2">&quot;malicious IP&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test-dep&quot;</span><span class="p">,</span>
        <span class="s2">&quot;test-tenant&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CASE-001&quot;</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="mi">100</span>
    <span class="p">)</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

    <span class="k">assert</span> <span class="n">duration</span> <span class="o">&lt;</span> <span class="mf">1.0</span>  <span class="c1"># Sub-second search</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
</code></pre></div>

<hr />
<h2 id="16-code-examples">16. Code Examples</h2>
<h3 id="161-adding-a-new-api-endpoint">16.1 Adding a New API Endpoint</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># siaservice/routers/example.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">fastapi</span><span class="w"> </span><span class="kn">import</span> <span class="n">APIRouter</span><span class="p">,</span> <span class="n">Depends</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siaservice.db.pgv.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_db_for_tenant</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siaservice.apis.services.base.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExamplePayload</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siaservice.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">router</span> <span class="o">=</span> <span class="n">APIRouter</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;/example&quot;</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Example&quot;</span><span class="p">])</span>

<span class="nd">@router</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/process&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">201</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_example</span><span class="p">(</span>
    <span class="n">payload</span><span class="p">:</span> <span class="n">ExamplePayload</span><span class="p">,</span>
    <span class="n">db</span><span class="p">:</span> <span class="n">Session</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">get_db_for_tenant</span><span class="p">)</span>
<span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing example: </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Business logic here</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;success&quot;</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<h3 id="162-creating-a-new-repository">16.2 Creating a New Repository</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># siaservice/repositories/example_repo.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siaservice.db.pgv.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExampleModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siaservice.db.embed.embedding</span><span class="w"> </span><span class="kn">import</span> <span class="n">AIEmbedding</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ExampleRepo</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="n">Session</span><span class="p">,</span> <span class="n">embedding</span><span class="p">:</span> <span class="n">AIEmbedding</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">session</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span> <span class="o">=</span> <span class="n">embedding</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ExampleModel</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create new record&quot;&quot;&quot;</span>
        <span class="c1"># Generate embedding if needed</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">embedding_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">embed_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">ExampleModel</span><span class="p">(</span>
            <span class="o">**</span><span class="n">data</span><span class="p">,</span>
            <span class="n">embedding</span><span class="o">=</span><span class="n">embedding_vector</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">search_similar</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">tenant_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">limit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">ExampleModel</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Vector similarity search&quot;&quot;&quot;</span>
        <span class="n">query_vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">embed_text</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ExampleModel</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">ExampleModel</span><span class="o">.</span><span class="n">tenant_id</span> <span class="o">==</span> <span class="n">tenant_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
            <span class="n">ExampleModel</span><span class="o">.</span><span class="n">embedding</span><span class="o">.</span><span class="n">l2_distance</span><span class="p">(</span><span class="n">query_vector</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h3 id="163-adding-a-new-celery-task">16.3 Adding a New Celery Task</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># worker.py - Add new task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">celery</span><span class="w"> </span><span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siaservice.db.pgv.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">db_session</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siaservice.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">celery</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@celery</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;process_example_task&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_example_task</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Background task for processing examples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tenant_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;tenant_id&quot;</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing example for tenant: </span><span class="si">{</span><span class="n">tenant_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">db_session</span><span class="p">(</span><span class="n">tenant_id</span><span class="p">)</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="c1"># Your logic here</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">perform_processing</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;result&quot;</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">perform_processing</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="c1"># Implementation</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;completed&quot;</span><span class="p">}</span>
</code></pre></div>

<h3 id="164-adding-a-new-llm-prompt-template">16.4 Adding a New LLM Prompt Template</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># siaservice/analysis/templates.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AnalysisTemplatesFactory</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_example_template</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns prompt template for example analysis</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">You are an expert security analyst. Analyze the following data:</span>

<span class="s2">Context:</span>
<span class="si">{context}</span>

<span class="s2">Data to analyze:</span>
<span class="si">{data}</span>

<span class="s2">Provide your analysis in JSON format:</span>
<span class="s2">{{</span>
<span class="s2">  &quot;summary&quot;: &quot;...&quot;,</span>
<span class="s2">  &quot;findings&quot;: [...],</span>
<span class="s2">  &quot;recommendations&quot;: [...]</span>
<span class="s2">}}</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_by_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">analysis_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get template by type&quot;&quot;&quot;</span>
        <span class="n">templates</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;case&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_by_case</span><span class="p">,</span>
            <span class="s2">&quot;example&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_example_template</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">templates</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">analysis_type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_default</span><span class="p">)()</span>
</code></pre></div>

<h3 id="165-database-migration-example">16.5 Database Migration Example</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># migrations/versions/xxxxx_add_example_table.py</span>
<span class="sd">&quot;&quot;&quot;Add example table</span>

<span class="sd">Revision ID: xxxxx</span>
<span class="sd">Revises: yyyyy</span>
<span class="sd">Create Date: 2025-11-11 16:00:00.000000</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">alembic</span><span class="w"> </span><span class="kn">import</span> <span class="n">op</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pgvector.sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Vector</span>

<span class="c1"># revision identifiers</span>
<span class="n">revision</span> <span class="o">=</span> <span class="s1">&#39;xxxxx&#39;</span>
<span class="n">down_revision</span> <span class="o">=</span> <span class="s1">&#39;yyyyy&#39;</span>
<span class="n">branch_labels</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">depends_on</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">def</span><span class="w"> </span><span class="nf">upgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">create_table</span><span class="p">(</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">,</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">UUID</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;tenant_id&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">Text</span><span class="p">(),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;embedding&#39;</span><span class="p">,</span> <span class="n">Vector</span><span class="p">(</span><span class="mi">1536</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> 
                  <span class="n">server_default</span><span class="o">=</span><span class="n">sa</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="s1">&#39;now()&#39;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">sa</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">op</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span>
        <span class="s1">&#39;ix_examples_tenant_id&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;tenant_id&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="n">op</span><span class="o">.</span><span class="n">create_index</span><span class="p">(</span>
        <span class="s1">&#39;ix_examples_embedding&#39;</span><span class="p">,</span>
        <span class="s1">&#39;examples&#39;</span><span class="p">,</span>
        <span class="p">[</span><span class="s1">&#39;embedding&#39;</span><span class="p">],</span>
        <span class="n">postgresql_using</span><span class="o">=</span><span class="s1">&#39;hnsw&#39;</span><span class="p">,</span>
        <span class="n">postgresql_with</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;ef_construction&#39;</span><span class="p">:</span> <span class="mi">64</span><span class="p">},</span>
        <span class="n">postgresql_ops</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;embedding&#39;</span><span class="p">:</span> <span class="s1">&#39;vector_l2_ops&#39;</span><span class="p">}</span>
    <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">downgrade</span><span class="p">():</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span><span class="s1">&#39;ix_examples_embedding&#39;</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;examples&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_index</span><span class="p">(</span><span class="s1">&#39;ix_examples_tenant_id&#39;</span><span class="p">,</span> <span class="n">table_name</span><span class="o">=</span><span class="s1">&#39;examples&#39;</span><span class="p">)</span>
    <span class="n">op</span><span class="o">.</span><span class="n">drop_table</span><span class="p">(</span><span class="s1">&#39;examples&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="166-adding-environment-configuration">16.6 Adding Environment Configuration</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># .env additions</span>
<span class="c1"># Example Service Configuration</span>
<span class="n">EXAMPLE_API_KEY</span><span class="o">=</span><span class="n">your_api_key_here</span>
<span class="n">EXAMPLE_BASE_URL</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">api</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">EXAMPLE_TIMEOUT</span><span class="o">=</span><span class="mi">30</span>
<span class="n">EXAMPLE_MAX_RETRIES</span><span class="o">=</span><span class="mi">3</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># siaservice/services/example_client.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">siaservice.common</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_logger</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ExampleClient</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EXAMPLE_API_KEY&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EXAMPLE_BASE_URL&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EXAMPLE_TIMEOUT&quot;</span><span class="p">,</span> <span class="mi">30</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;EXAMPLE_MAX_RETRIES&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">call_api</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Make API call with retry logic&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">api_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span>
                    <span class="n">url</span><span class="p">,</span>
                    <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
                <span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;API call failed (attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="k">return</span> <span class="p">{}</span>
</code></pre></div>

<hr />
<p><strong>Document Version</strong>: 1.0<br />
<strong>Last Updated</strong>: November 11, 2025<br />
<strong>Status</strong>: Active Development</p>
    </main>
    
    <footer class="main-footer">
        <p>&copy; 2025 Securaa Platform. All rights reserved. | <a href="#" onclick="window.print()" style="color: #ecf0f1;">Print</a></p>
    </footer>
    
    <script src="assets/js/documentation.js"></script>
</body>
</html>